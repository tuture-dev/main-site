---
title: "Taro å°ç¨‹åºå¼€å‘å¤§å‹å®æˆ˜ï¼ˆä¸ƒï¼‰ï¼šä½¿ç”¨ Authing æ‰“é€ å®Œæ•´ä¸”å¼ºå¤§çš„ç”¨æˆ·ç³»ç»Ÿ"
description: "ä¸ºäº†è®©æˆ‘ä»¬çš„åšå®¢çœ‹èµ·æ¥æ›´åŠ ä¸“ä¸šï¼Œæˆ‘ä»¬æ‰“ç®—ç»™å®ƒä¹ŸåŠ ä¸Šæ•´ä¸Šä¸€ä¸ªä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿï¼Œæœ‰äº†æœ€ä¸ºæ ¸å¿ƒçš„ç”¨æˆ·ç³»ç»Ÿåœ¨ï¼Œæˆ‘ä»¬åšå®¢ä¹‹åçš„æ‰©å±•éƒ½å¯ä»¥æ¸¸åˆƒæœ‰ä½™ï¼Œä½†æ˜¯æ®ç»Ÿè®¡ï¼Œä¸€ä¸ªåº”ç”¨è¦æƒ³æ‰“é€ ä¸€ä¸ªæ¯”è¾ƒä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿï¼Œè‡³å°‘éœ€è¦èŠ±è´¹å‡ ä¸ªæœˆæ—¶é—´ï¼Œè¿˜éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›å»ç»´æŠ¤æ‰“é€ å‡ºæ¥çš„ç”¨æˆ·ç³»ç»Ÿï¼Œæ‰€åœ¨åœ¨åšäº†ä¸€ç•ªè°ƒç ”ä¹‹åï¼Œæˆ‘ä»¬å°†ç›®æ ‡æ”¾åœ¨äº†ä¸€ä¸ªå«åš Authing çš„é€šç”¨äº‘èº«ä»½å¹³å°ï¼Œå®ƒæä¾›çš„æœåŠ¡å°±æ˜¯å¸®åº”ç”¨å¿«é€Ÿé›†æˆä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨çš„ç”¨æˆ·ç³»ç»Ÿï¼Œè€Œæˆ‘ä»¬è¿™ç¯‡æ•™ç¨‹å°†ä¼šè®²è§£å¦‚ä½•å€ŸåŠ© Authing æ¥ç»™æˆ‘ä»¬çš„ä¹‹å‰çš„å°ç¨‹åºåšå®¢æ­¦è£…ä¸€ä¸ªä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿã€‚"
tags: ["Taro", "ç”¨æˆ·ç³»ç»Ÿ", "é‰´æƒ", "è®¤è¯", "OAuth", "å¾®ä¿¡ç™»å½•", "QQç™»å½•", "Githubç™»å½•"]
categories: ["å°ç¨‹åº", "Taro", "è¿›é˜¶"]
date: 2020-05-17T01:37:06.464Z
photos:
  - https://static.tuture.co/c/34a473b/taro-cover-9.jpg
---

<div class="profileBox">
  <div class="avatarBox">
    <a href="https://github.com/tuture-dev"><img src="/images/avatars/tuture-dev.jpg" alt="" class="avatar"></a>
  </div>
  <div class="rightBox">
    <div class="infoBox">
    <a href="https://github.com/tuture-dev"><p class="nickName">@tuture-dev</p></a>
  </div>
  <div class="codeBox">
    <a href="https://github.com/tuture-dev/ultra-club"><span class="codeText">æŸ¥çœ‹ä»£ç </span></a>
  </div>
  </div>
</div>

## å‡†å¤‡æ–°ç‰ˆç™»å½•é€»è¾‘

ä¹‹å‰æˆ‘ä»¬çš„å°ç¨‹åºå…·æœ‰äº†ä¸€ä¸ªç®€å•åšå®¢å¿…å¤‡çš„ä¸€äº›åŠŸèƒ½ï¼š

- æƒé™ç®¡ç†ï¼šå‘å¸–ä¹‹å‰éœ€è¦ç™»å½•
- ç™»å½•ï¼šæ™®é€šç™»å½•å’Œå¾®ä¿¡ç™»å½•ç­‰
- å‘å¸–ï¼šå¸–å­ä¼šè‡ªåŠ¨å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯
- è·å–æ‰€æœ‰å¸–å­å’Œå•ä¸ªå¸–å­

ä¹ä¸€çœ‹è¿™ä¸ªåšå®¢æœ‰ç‚¹å°å®Œæ•´äº†ï¼Œä½†æ˜¯ä¸€è·¯è·Ÿä¸‹æ¥çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬ä¹‹å‰çš„ç™»å½•éƒ½æ˜¯é€šè¿‡ä¼ å…¥ç”¨æˆ·çš„ `nickName` å’Œ `photo` æ¥ç™»å½•çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬åœ¨ç”Ÿæ´»ä¸­çœ‹åˆ°çš„ä¸€äº›æ¯”è¾ƒæ­£è§„çš„ç½‘ç«™æˆ–è€…å°ç¨‹åºï¼Œå®ƒä»¬çš„ç™»å½•ä¸€èˆ¬éƒ½æœ‰ç±»ä¼¼æ‰‹æœº+éªŒè¯ç ç™»å½•ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªæ ‡å‡†çš„åšå®¢é‡Œé¢ï¼Œå¯èƒ½è¿˜ä¼šæ¶‰åŠåˆ°è¯¸å¦‚ç”¨æˆ·æƒé™ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•çŠ¶æ€æŸ¥è¯¢ç­‰ï¼Œåˆšåˆšæˆ‘æåˆ°çš„ç§ç§å…³äºç”¨æˆ·çš„åœºæ™¯ä¸€èˆ¬ä¼šè¢«æŠ½è±¡ä¸ºä¸€ä¸ªåº”ç”¨é‡Œçš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å— -- ç”¨æˆ·ç³»ç»Ÿï¼Œå³æ‰€æœ‰å’Œç”¨æˆ·æ³¨å†Œ/ç™»å½•ã€ä¿¡æ¯æ›´æ–°ã€æƒé™ç®¡ç†ã€é‰´æƒç­‰ç›¸å…³çš„å†…å®¹ã€‚

ä¸ºäº†è®©æˆ‘ä»¬çš„åšå®¢çœ‹èµ·æ¥æ›´åŠ ä¸“ä¸šï¼Œæˆ‘ä»¬æ‰“ç®—ç»™å®ƒä¹ŸåŠ ä¸Šæ•´ä¸Šä¸€ä¸ªä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿï¼Œæœ‰äº†æœ€ä¸ºæ ¸å¿ƒçš„ç”¨æˆ·ç³»ç»Ÿåœ¨ï¼Œæˆ‘ä»¬åšå®¢ä¹‹åçš„æ‰©å±•éƒ½å¯ä»¥æ¸¸åˆƒæœ‰ä½™ï¼Œä½†æ˜¯æ®ç»Ÿè®¡ï¼Œä¸€ä¸ªåº”ç”¨è¦æƒ³æ‰“é€ ä¸€ä¸ªæ¯”è¾ƒä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿï¼Œè‡³å°‘éœ€è¦èŠ±è´¹å‡ ä¸ªæœˆæ—¶é—´ï¼Œè¿˜éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›å»ç»´æŠ¤æ‰“é€ å‡ºæ¥çš„ç”¨æˆ·ç³»ç»Ÿï¼Œæ‰€åœ¨åœ¨åšäº†ä¸€ç•ªè°ƒç ”ä¹‹åï¼Œæˆ‘ä»¬å°†ç›®æ ‡æ”¾åœ¨äº†ä¸€ä¸ªå«åš Authing çš„é€šç”¨äº‘èº«ä»½å¹³å°ï¼Œå®ƒæä¾›çš„æœåŠ¡å°±æ˜¯å¸®åº”ç”¨å¿«é€Ÿé›†æˆä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨çš„ç”¨æˆ·ç³»ç»Ÿï¼Œè€Œæˆ‘ä»¬è¿™ç¯‡æ•™ç¨‹å°†ä¼šè®²è§£å¦‚ä½•å€ŸåŠ© Authing æ¥ç»™æˆ‘ä»¬çš„ä¹‹å‰çš„å°ç¨‹åºåšå®¢æ­¦è£…ä¸€ä¸ªä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€çœ‹å®Œæˆçš„æ•ˆæœï¼š

![](https://static.tuture.co/c/34a473b/172281ab2f4dfe98.gif)

![](https://cdn.nlark.com/yuque/0/2020/gif/123790/1588231679722-a000569d-8acf-4e8c-be6d-e7288dadacb2.gif)

å¦‚æœä½ å¸Œæœ›ç›´æ¥ä»è¿™ç¯‡å¼€å§‹ï¼Œé‚£ä¹ˆå¯ä»¥ Clone æˆ‘ä»¬ä¸ºä½ å‡†å¤‡çš„ä»£ç ï¼Œç„¶åè·Ÿç€æ•™ç¨‹è¡¥å……å‰©ä¸‹çš„éƒ¨åˆ†ï¼š

```
git clone -b authing-start https://github.com/tuture-dev/ultra-club.git

# æˆ–è€…ä¸‹è½½ Gitee ä¸Šçš„ä»“åº“
git clone -b authing-start https://gitee.com/tuture/ultra-club.git
```

### æ”¹è¿›æ™®é€šç™»å½•

é¦–å…ˆæˆ‘ä»¬æ¥å°†ä¹‹å‰æ™®é€šç™»å½•çš„ä¸“ä¸šæ€§æå‡ä¸€ä¸ªæ¡£æ¬¡ï¼Œä¹‹å‰æˆ‘ä»¬æ˜¯è®©ç”¨æˆ·è¾“å…¥æ˜µç§°å’Œä¸Šä¼ å¤´åƒç„¶åè¿›è¡Œç™»å½•ï¼Œç°åœ¨æˆ‘ä»¬æ‰“ç®—åˆ‡æ¢åˆ°æ‰‹æœºå·+éªŒè¯ç çš„å½¢å¼ï¼Œç«‹é©¬ç°ä»£åŒ–ã€‚

æ‰“å¼€ `src/components/LoginForm/index.jsx` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```jsx src/components/LoginForm/index.jsx https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/LoginForm/index.jsx æŸ¥çœ‹å®Œæ•´ä»£ç 
[tuture-del]import Taro, { useState } from '@tarojs/taro'
[tuture-add]import Taro, { useState, useRef, useEffect } from '@tarojs/taro'
import { View, Form } from '@tarojs/components'
import { AtButton, AtImagePicker } from 'taro-ui'
import { useDispatch } from '@tarojs/redux'

[tuture-del]import { LOGIN } from '../../constants'
[tuture-add]import { SET_IS_OPENED, SET_LOGIN_INFO } from '../../constants'
[tuture-add]import CountDownButton from '../CountDownButton'
import './index.scss'

export default function LoginForm(props) {
  // Login Form ç™»å½•æ•°æ®
[tuture-del]  const [formNickName, setFormNickName] = useState('')
[tuture-del]  const [files, setFiles] = useState([])
[tuture-del]  const [showAddBtn, setShowAddBtn] = useState(true)
[tuture-add]  const [phone, setPhone] = useState('')
[tuture-add]  const [phoneCode, setPhoneCode] = useState('')
[tuture-add]  const countDownButtonRef = useRef(null)

  const dispatch = useDispatch()

[tuture-del]  function onChange(files) {
[tuture-del]    if (files.length > 0) {
[tuture-del]      setShowAddBtn(false)
[tuture-del]    } else {
[tuture-del]      setShowAddBtn(true)
[tuture-add]  async function countDownButtonPressed() {
[tuture-add]    if (!phone) {
[tuture-add]      Taro.atMessage({
[tuture-add]        type: 'error',
[tuture-add]        message: 'æ‚¨è¿˜æ²¡æœ‰å¡«å†™æ‰‹æœº!',
[tuture-add]      })
[tuture-add] 
[tuture-add]      return
    }

[tuture-del]    setFiles(files)
[tuture-del]  }
[tuture-add]    countDownButtonRef.current.startCountDown()

[tuture-del]  function onImageClick() {
[tuture-del]    Taro.previewImage({
[tuture-del]      urls: [props.files[0].url],
[tuture-del]    })
[tuture-add]    // å¤„ç†å‘é€éªŒè¯ç äº‹ä»¶
  }

  async function handleSubmit(e) {
    e.preventDefault()

    // é‰´æƒæ•°æ®
[tuture-del]    if (!formNickName || !files.length) {
[tuture-add]    if (!phone || !phoneCode) {
      Taro.atMessage({
        type: 'error',
        message: 'æ‚¨è¿˜æœ‰å†…å®¹æ²¡æœ‰å¡«å†™ï¼',
      })

      return
    }

[tuture-del]    setShowAddBtn(true)
[tuture-del] 
[tuture-del]    // æç¤ºç™»å½•æˆåŠŸ
[tuture-del]    Taro.atMessage({
[tuture-del]      type: 'success',
[tuture-del]      message: 'æ­å–œæ‚¨ï¼Œç™»å½•æˆåŠŸï¼',
[tuture-del]    })
[tuture-del] 
[tuture-del]    // ç¼“å­˜åœ¨ storage é‡Œé¢
[tuture-del]    const userInfo = { avatar: files[0].url, nickName: formNickName }
[tuture-del] 
[tuture-del]    // æ¸…ç©ºè¡¨å•çŠ¶æ€
[tuture-del]    setFiles([])
[tuture-del]    setFormNickName('')
[tuture-del] 
[tuture-del]    // å‘åç«¯å‘èµ·ç™»å½•è¯·æ±‚
[tuture-del]    dispatch({ type: LOGIN, payload: { userInfo: userInfo } })
[tuture-add]    // å¤„ç†ç™»å½•å’Œæ³¨å†Œ
  }

  return (
    <View className="post-form">
      <Form onSubmit={handleSubmit}>
        <View className="login-box">
[tuture-del]          <View className="avatar-selector">
[tuture-del]            <AtImagePicker
[tuture-del]              length={1}
[tuture-del]              mode="scaleToFill"
[tuture-del]              count={1}
[tuture-del]              files={files}
[tuture-del]              showAddBtn={showAddBtn}
[tuture-del]              onImageClick={onImageClick}
[tuture-del]              onChange={onChange}
[tuture-del]            />
[tuture-del]          </View>
          <Input
[tuture-del]            className="input-nickName"
[tuture-add]            className="input-phone input-item"
            type="text"
[tuture-del]            placeholder="ç‚¹å‡»è¾“å…¥æ˜µç§°"
[tuture-del]            value={formNickName}
[tuture-del]            onInput={e => setFormNickName(e.target.value)}
[tuture-add]            placeholder="è¾“å…¥æ‰‹æœºå·"
[tuture-add]            value={phone}
[tuture-add]            onInput={e => setPhone(e.target.value)}
          />
[tuture-add]          <View className="verify-code-box">
[tuture-add]            <Input
[tuture-add]              className="input-nickName input-item"
[tuture-add]              type="text"
[tuture-add]              placeholder="å››ä½éªŒè¯ç "
[tuture-add]              value={phoneCode}
[tuture-add]              onInput={e => setPhoneCode(e.target.value)}
[tuture-add]            />
[tuture-add]            <CountDownButton
[tuture-add]              onClick={countDownButtonPressed}
[tuture-add]              ref={countDownButtonRef}
[tuture-add]            />
[tuture-add]          </View>
          <AtButton formType="submit" type="primary">
            ç™»å½•
          </AtButton>
[tuture-add]          <View className="at-article__info">
[tuture-add]            é€šè¿‡æ‰‹æœºå’ŒéªŒè¯ç æ¥ç™»å½•ï¼Œå¦‚æœæ²¡æœ‰è´¦å·ï¼Œæˆ‘ä»¬å°†è‡ªåŠ¨åˆ›å»º
[tuture-add]          </View>
        </View>
      </Form>
    </View>
  )
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„ä»£ç ä¸»è¦æœ‰å¦‚ä¸‹å‡ å¤„æ›´æ”¹ï¼š

- åˆ é™¤äº†å¤„ç† `avatar` å’Œ `nickName` çš„ `useState` é€»è¾‘
- åˆ é™¤äº†ä¹‹å‰ç”¨äºå¤„ç†ä¸Šä¼ å¤´åƒçš„ `onImageClick` å’Œ `onChange` å‡½æ•°ï¼Œä»¥åŠ `AtImagePicker` ç»„ä»¶
- æ”¹è¿›å’Œå¢åŠ äº†ä¸¤ä¸ªè¾“å…¥æ¡†ï¼Œä¸€ä¸ªç”¨äºè¾“å…¥æ‰‹æœºå·ï¼Œä¸€ä¸ªç”¨äºè¾“å…¥éªŒè¯ç ï¼ŒåŒæ˜¯å¢åŠ äº† `phone` å’Œ `phoneCode` çš„ `useState` é€»è¾‘
- æ”¹è¿› `handleSubmit` ï¼Œåˆ é™¤äº†åŸå¤„ç† `nickName` å’Œ `files` çš„é€»è¾‘ï¼Œä»¥åŠåˆ é™¤äº†ä¹‹å‰å‘èµ·ç™»å½•çš„ `dispatch` é€»è¾‘
- æ¥ç€æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªç”¨äºå€’è®¡æ—¶çš„ `CountDownButton` ç»„ä»¶ï¼Œä»¥åŠè·å– `ref` çš„ `countDownButtonRef` å’Œå¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶çš„ `countDownButtonPressed` å‡½æ•°ï¼Œåœ¨å‡½æ•°é‡Œé¢æˆ‘ä»¬ä¼šåšæ•°æ®éªŒè¯ï¼Œå¦‚æœç”¨æˆ·å¡«å†™äº†æ‰‹æœºå·ï¼Œæ‰å…è®¸æ‰§è¡Œå€’è®¡æ—¶é€»è¾‘ï¼Œåœ¨æ¥ä¸‹æ¥æˆ‘ä»¬å°†åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢å¤„ç†æ‰‹æœºéªŒè¯ç å‘é€é€»è¾‘ã€‚
- æœ€åæˆ‘ä»¬æ·»åŠ äº†æç¤ºç”¨æˆ·ä½¿ç”¨æ‰‹æœºå’ŒéªŒè¯ç ç™»å½•çš„æ–‡æ¡ˆã€‚

{% note info %}
**æç¤º**

è¿™é‡Œçš„ CountDownButton æ˜¯ Taro å®˜æ–¹ç‰©æ–™å¸‚åœºæä¾›çš„ç‰©æ–™ï¼Œå¯ä»¥è®¿é—® [è¿™ä¸ªåœ°å€]()ï¼Œä¸‹è½½ç‰©æ–™ï¼Œç„¶åå°† CountDownButton çš„æ–‡ä»¶å¤¹æ”¾åˆ° `src/compontents` æ–‡ä»¶å¤¹ä¸‹é¢ã€‚æˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿™ä¸ªç»„ä»¶çš„æ ·å¼åšä¸€ç‚¹ä¿®æ”¹ï¼Œä»¥é€‚åº”æˆ‘ä»¬ç°åœ¨çš„ UI é£æ ¼ï¼Œæˆ‘ä»¬å°†é©¬ä¸Šæ¥è®²è§£å¦‚ä½•ä¿®æ”¹ï¼Œè¯»è€…å…ˆå¯ä»¥ä¸‹è½½è¿™ä¸ªç‰©æ–™ï¼Œç„¶åæ”¾ç½®åˆ°åˆšåˆšæåˆ°çš„é¡¹ç›®ç›®å½•ä¸‹ã€‚
{% endnote %}

### æ ·å¼æ”¹è¿›

ä¸Šé¢æˆ‘ä»¬æ”¹è¿›äº†ç»„ä»¶ï¼Œä¸ºäº†è®©æˆ‘ä»¬çš„æ–°ç‰ˆç™»å½•æ ·å­çœ‹èµ·æ¥æ›´åŠ ä¸“ä¸šã€ç»Ÿä¸€ï¼Œæˆ‘ä»¬åŠ ç‚¹æ ·å¼ï¼Œæ‰“å¼€ `src/components/LoginForm/index.scss` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```scss src/components/LoginForm/index.scss https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/LoginForm/index.scss æŸ¥çœ‹å®Œæ•´ä»£ç 
.post-form {
  margin: 0 30px;
  padding: 30px;
}

[tuture-del].input-nickName {
[tuture-add].input-item {
  border: 1px solid #eee;
  padding: 10px;
  font-size: medium;
[tuture-del]  width: 100%;
  margin-top: 40px;
  margin-bottom: 40px;
}

[tuture-add].input-phone {
[tuture-add]  width: 100%;
[tuture-add]}
[tuture-add] 
[tuture-add].input-nickName {
[tuture-add]  width: calc(100% - 200px);
[tuture-add]}
[tuture-add] 
[tuture-add].verify-code-box {
[tuture-add]  display: flex;
[tuture-add]  flex-direction: row;
[tuture-add]  align-items: center;
[tuture-add]  justify-content: space-between;
[tuture-add]}
[tuture-add] 
.avatar-selector {
  width: 200px;
  margin: 0 auto;
}
```

### ä½¿ç”¨ Taro ç‰©æ–™

æˆ‘ä»¬ä¸Šé¢ç”¨åˆ°çš„ `CountDownButton` ç»„ä»¶ï¼Œå°±æ˜¯ Taro ç‰©æ–™å¸‚åœºçš„ä¸€ä¸ªç‰©æ–™, ç®€å•çš„è¯´ç‰©æ–™å°±æ˜¯ä¸€ä¸ªèƒ½æŸæ–¹é¢åŠŸèƒ½å®Œå–„çš„åŒ…æˆ–ç»„ä»¶,å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®ŒæˆæŸä¸ªé€»è¾‘è€Œä¸éœ€è¦é‡å¤é€ è½®å­,æ­£å¦‚ Taro ç‰©æ–™å¸‚åœºå®˜æ–¹çš„æ ‡è¯­ï¼š

> è®©æ¯ä¸€ä¸ªè®©æ¯ä¸€ä¸ªè½®å­äº§ç”Ÿä»·å€¼

æˆ‘ä»¬é€šè¿‡ä¹‹å‰çš„æ­¥éª¤ï¼Œåº”è¯¥å·²ç»ä¸‹è½½å¥½äº†ç‰©æ–™ï¼Œå¹¶æ”¾åœ¨äº† `src/components` æ–‡ä»¶å¤¹ä¸‹é¢äº†ï¼Œå¯ä»¥çœ‹åˆ°ç»„ä»¶ä¸­ä¸»è¦å°±æ˜¯ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªé€»è¾‘æ–‡ä»¶ `src/components/CountDownButton/index.js` ï¼Œè¿˜æœ‰ä¸€ä¸ªæ ·å¼æ–‡ä»¶ `src/components/CountDownButton/index.css`æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¦åšä¸ªå°ä¿®æ”¹å°±æ˜¯é€»è¾‘æ–‡ä»¶é‡Œé¢å¼•ç”¨çš„æ˜¯ `index.scss` æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸‹è¿™ä¸ªæ ·å¼æ–‡ä»¶çš„åç¼€ä¸º `index.scss` ã€‚

æ¥ç€ä¸ºäº†å’Œæˆ‘ä»¬çš„ç°æœ‰çš„ UI ç»Ÿä¸€ï¼Œæˆ‘ä»¬è¿˜æ”¹äº† `src/components/CountDownButton/index.scss`æ–‡ä»¶çš„ `activeButtonStyle` å’Œ `buttonCommonStyle` æ ·å¼ï¼Œæœ€åçš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```scss src/components/CountDownButton/index.scss https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/CountDownButton/index.scss æŸ¥çœ‹å®Œæ•´ä»£ç 
/* æŒ‰é’®é»˜è®¤å±•ç°æ ·å¼ */

.buttonCommonStyle {
  margin: 0;
  width: 160px;
  height: calc(1.4rem + 20px);
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  line-height: 1;
  border-radius: 4px;
  border: none;
  outline: none;
}
/* ç¦ç”¨æ—¶å€™çš„TouchableOpacityæ ·å¼ */

.disableButtonStyle {
  background-color: #f6f6f6 !important;
}
/* å¯ä»¥ç‚¹å‡»æ—¶å€™çš„TouchableOpacityæ ·å¼ */

.activeButtonStyle {
  background-color: #02b875;
}
/* æ–‡æœ¬é»˜è®¤æ ·å¼ */

.txtCommonStyle {
  font-size: 20px;
}
/* ç¦ç”¨æ—¶Textæ ·å¼ */

.disableTxtStyle {
  color: #999;
}
/* å¯ä»¥ç‚¹å‡»æ—¶å€™çš„Textæ ·å¼ */

.activeTxtStyle {
  color: #fff;
}
```

å¤§åŠŸå‘Šæˆï¼ğŸ¥³ï¼Œæˆ‘ä»¬æˆåŠŸçš„å®Œæˆäº†æ–°ç‰ˆæ™®é€šç™»å½•çš„ç•Œé¢ï¼Œå½“ä½ ä¿å­˜ä»£ç ï¼Œå¹¶åœ¨æ ¹ç›®å½•ä¸‹é€šè¿‡ `npm run dev:weapp` å¼€å¯å¾®ä¿¡å°ç¨‹åºï¼Œå¹¶ä½¿ç”¨å¼€å‘è€…å·¥å…·æ‰“å¼€æˆ‘ä»¬çš„é¡¹ç›®æ—¶ï¼Œå®ƒçš„æ•ˆæœåº”è¯¥ç±»å‹ä¸‹é¢è¿™æ ·ï¼š

![](https://static.tuture.co/c/34a473b/172281ab2f71d1d2.png)

æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å’Œä½ ä¹‹å‰ä½“éªŒçš„å„ç§ä¸“ä¸š App æˆ–è€…ç½‘ç«™ã€å°ç¨‹åºçš„ç™»å½•æ³¨å†Œç•Œé¢å’Œé€»è¾‘ç±»ä¼¼äº†å‘¢ï¼ŸğŸ˜†ï¼Œæœ‰äº†è¿™æ ·ä¸€ä¸ªä¸“ä¸šçš„ç™»å½•ç•Œé¢ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†è¦æŠŠå®ƒæ•´ä¸ªä»å‰ç«¯åˆ°åç«¯çš„é€»è¾‘è·‘é€šï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å°†è·‘é€šè¿™ä¸ªç™»å½•å’Œæ³¨å†Œé€»è¾‘ã€‚

{% note info %}
**æç¤º**

è¿™é‡Œæˆ‘ä»¬å°†ç™»å½•å’Œæ³¨å†Œé¡µé¢æ•´åˆåœ¨äº†ä¸€èµ·ï¼Œé€šè¿‡åœ¨ç™»å½•æŒ‰é’®ä¸‹æ–¹çš„å°æ–‡å­—æç¤ºï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰è´¦å·ï¼Œé‚£ä¹ˆé€šè¿‡æ‰‹æœºå·å’ŒéªŒè¯ç ç™»å½•ä¹‹åï¼Œæˆ‘ä»¬ä¼šä¸ºç”¨æˆ·ç›´æ¥æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œè€Œç®€åŒ–ç•Œé¢é€»è¾‘çš„èƒŒåé€šå¸¸éœ€è¦åœ¨ä»£ç é€»è¾‘ä¸Šåšå‡ºå¤§é‡çš„æ”¹è¿›ã€ä¼˜åŒ–ç­‰ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨ä¸‹ä¸€æ­¥å³å°†æ¥å…¥çš„é€šç”¨çš„èº«ä»½äº‘å¹³å° -- Authing åˆ™å°†è¿™ä¸€é€»è¾‘ç®€åŒ–åˆ°äº†å‡ è¡Œä»£ç ã€‚
{% endnote %}

## ä½¿ç”¨ Authing æ¥å…¥å®Œæ•´çš„ç”¨æˆ·ç³»ç»Ÿ

åœ¨æ–‡ç« å¼€å¤´å’Œä¸Šä¸€å°ç»“æœ«å°¾ä¹°äº†é‚£ä¹ˆå¤šå…³å­ï¼Œè¯´ Authing å¦‚ä½•ç®€åŒ–æˆ‘ä»¬çš„å¼€å‘æˆæœ¬ï¼Œæœ‰äº›è¯»è€…ä¼°è®¡éƒ½æœ‰ç‚¹æ€¥ä¸å¯è€äº†ï¼Œè¿™ä¸ª Authing æœ‰è¿™ä¹ˆæ–¹ä¾¿å˜›ï¼Ÿï¼Œæˆ‘ä»¬è¿™ä¸€èŠ‚å°±æ¥å¼€å§‹æ·±å…¥ä½¿ç”¨å®ƒã€‚

ä¸ºäº†å°† Authing æ¥å…¥æˆ‘ä»¬çš„åšå®¢å°ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹å‡ ç‚¹å‡†å¤‡ï¼š

- æ³¨å†Œ Authing è´¦å·å¹¶åˆ›å»ºä¸€ä¸ª â€œå°ç¨‹åºâ€ ç±»å‹çš„ç”¨æˆ·æ± 
- é€šè¿‡å®˜æ–¹æ–‡æ¡£ï¼Œæ‰¾åˆ°å°ç¨‹åº SDKï¼Œå¹¶ä¸‹è½½å¯¹äºçš„æ–‡ä»¶æ”¾ç½®åˆ°é¡¹ç›®ç›®å½•ä¸‹
- åœ¨é¡¹ç›®ä»£ç ä¸­å¯¼å…¥ Authing å°ç¨‹åº SDKï¼Œå¹¶å¼€å§‹ä½¿ç”¨

### æ³¨å†Œ Authing è´¦å·

æ‰“å¼€[ Authing å®˜ç½‘](https://authing.cn/?utm_source=tuture)ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š

![](https://static.tuture.co/c/34a473b/172281ab2faef61e.png)

æˆ‘ä»¬ç‚¹å‡»å³ä¸Šè§’çš„ç™»å½•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¼šå¼¹å‡ºå¦‚ä¸‹ç•Œé¢ï¼š

![](https://static.tuture.co/c/34a473b/172281ab31cb9682.png)

æˆ‘ä»¬è¿™æ—¶å€™å¯ä»¥æ…¢ä¸‹è„šæ­¥ï¼Œå¥½å¥½çœ‹ä¸€ä¸‹æä¾›é€šç”¨èº«ä»½äº‘å¹³å°çš„å…¬å¸ï¼Œä»–ä»¬çš„ç™»å½•ç•Œé¢æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å¾®ä¿¡ç™»å½•ã€é‚®ç®±+å¯†ç ç™»å½•ã€æ‰‹æœºå·+éªŒè¯ç ç™»å½•ã€è¿˜æœ‰æŠ€æœ¯å¼€å‘è€…å¸¸ç”¨çš„ Github ç™»å½•ï¼Œç”šè‡³è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å°ç¨‹åºæ‰«ç ç™»å½•ï¼ŒåŸºæœ¬å°†äº’è”ç½‘ä¸Šæˆ‘ä»¬å¯èƒ½ç”¨åˆ°çš„æœ€é«˜æ•ˆç‡çš„ç”¨æˆ·ç™»å½•ã€æ³¨å†ŒåŠŸèƒ½é€»è¾‘éƒ½é›†æˆè¿›äº†ä¸€ä¸ªå°å°çš„è¡¨å•é‡Œé¢ã€‚

è¯»è€…å¯ä»¥è‡ªè¡Œé€‰æ‹©è‡ªå·±å–œæ¬¢çš„ç™»å½•æ–¹å¼ğŸ˜‹ï¼Œè¿™é‡Œå›¾é›€é…±é€‰æ‹©äº†å¾®ä¿¡ç™»å½•ï¼Œç„¶ååœ¨å¼¹å‡ºçš„æ‰«ç ç•Œé¢ï¼Œä½¿ç”¨å¾®ä¿¡æ‰«ç äºŒç»´ç ç™»å½•ã€‚ç™»å½•ä¹‹åï¼Œä¼šå¼¹å‡ºä¸€ä¸ªç•Œé¢è®©ä½ ç»‘å®šæ‰‹æœºå·ï¼Œè¯»è€…è¿™é‡Œå¯ä»¥è‡ªè¡Œé€‰æ‹©æ˜¯å¦ç»‘å®šã€‚å½“å®Œæˆäº†è¿™ä¸€æ­¥æ“ä½œä¹‹åï¼Œç•Œé¢ä¼šå¯¼èˆªå¸¦ä½ æ¥åˆ°ä¸€ä¸ªåˆ›å»ºåº”ç”¨çš„ç•Œé¢ï¼Œæˆ‘ä»¬é€‰æ‹©å°ç¨‹åºï¼Œç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ï¼š

![](https://static.tuture.co/c/34a473b/172281ab328a8600.png)

æ¥ç€ï¼Œä¼šé—®ä½ çš„åº”ç”¨æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬å¡«å…¥ï¼šâ€œå›¾é›€ç¤¾åŒºåšå®¢å°ç¨‹åºâ€ï¼ˆè¯»è€…è¿™é‡Œå¯ä»¥è‡ªè¡Œè„‘è¡¥ï¼‰ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼š

![](https://static.tuture.co/c/34a473b/172281ab6a4f7cf8.png)

æ¥ç€ä¼šè®©ä½ è®¾ç½®ä¸€ä¸ªäºŒçº§åŸŸåï¼Œæˆ‘ä»¬è¾“å…¥ tuture-blog-miniprogramï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»å®Œæˆï¼š

![](https://static.tuture.co/c/34a473b/172281ab5e1312d8.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å›æ¥åˆ°ä¸€ä¸ªå¿«é€Ÿä½“éªŒ Authing åŠŸèƒ½çš„ç•Œé¢ï¼Œç³»ç»Ÿä¸ºä½ é»˜è®¤åˆ›å»ºäº†ä¸€ä¸ªè´¦å·ï¼š

- è´¦å·ï¼š`test@test.com` 
- å¯†ç ï¼š`123456a!` 

ä½ å¯ä»¥åœ¨å³è¾¹çš„ç•Œé¢é‡Œé¢ä½“éªŒæ˜¯å¦å¯ä»¥ç™»å½•ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ³¨å†Œä¸€ä¸ªç”¨æˆ·ï¼Œæ³¨å†Œçš„ç”¨æˆ·ç¨åæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°æˆ‘ä»¬åˆ›å»ºçš„ â€œå›¾é›€ç¤¾åŒºåšå®¢å°ç¨‹åºâ€ ç”¨æˆ·æ± é‡Œé¢çœ‹åˆ°è¿™ä¸ªæ³¨å†Œçš„ç”¨æˆ·ï¼š

![](https://static.tuture.co/c/34a473b/172281ab6fdfbb33.png)

å¹¶ä¸”ä¸Šé¢çš„ç•Œé¢è¿˜è®²è§£äº†å¦‚ä½•å¿«é€Ÿé›†æˆ  Authing çš„ç™»å½•åŠŸèƒ½å’Œæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¹¶ç»™å‡ºäº† JS å®ç°ä»£ç ï¼Œä»¥åŠå·¦ä¸‹è§’çš„ Guard ï¼Œè¿™ä¸ª Guard ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªé›†åˆäº†æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ Authing é‚£ä¸ªæ³¨å†Œã€ç™»å½•è¡¨å•çš„åŠŸèƒ½ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªä¸“ä¸šçš„ç•Œé¢ç»™ä½ ï¼Œä½¿å¾—ä½ å¯ä»¥å‡ è¡Œä»£ç å°±å®ç°ä¸€ä¸ªç±»ä¼¼ Authing å®˜æ–¹æ³¨å†Œç™»å½•çš„é‚£ä¸ªæ ·å­ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„è¿™ä¸ªç•Œé¢ï¼š

![](https://static.tuture.co/c/34a473b/172281ab31cb9682.png)

{% note info %}
**æç¤º**

æˆ‘ä»¬åœ¨å›¾é›€ç¤¾åŒºçš„å…¨æ ˆç”µå•†ç³»åˆ—æ–‡ç« çš„ç•ªå¤–ç¯‡é‡Œé¢é›†æˆç”¨æˆ·ç³»ç»Ÿæœ‰è®²åˆ°å¦‚ä½•ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»æ­¤ç¯‡æ–‡ç« ã€‚
{% endnote %}

å¥½çš„ï¼Œæˆ‘ä»¬ç‚¹å‡»å·¦ä¸‹è§’çš„ â€œçŸ¥é“äº†ï¼Œè¿›å…¥æ§åˆ¶å°â€ï¼Œå¼€å§‹è¿›å…¥æˆ‘ä»¬çš„ Authing ç”¨æˆ·æ± ç®¡ç†æ§åˆ¶å°ï¼Œåœ¨æ­¤ä¹‹å‰è¿˜ä¼šè®©ä½ å¡«å†™ä¸€ä¸ªå›è°ƒåœ°å€ï¼Œè¿™ä¸ªæˆ‘ä»¬æš‚æ—¶ç”¨ä¸åˆ°ï¼Œä½ å¯ä»¥è·³è¿‡ï¼Œæˆ–è€…å¯ä»¥éšä¾¿å¡«å†™ä¸€ä¸ªï¼Œæ¯”å¦‚ `http://localhost:3000`ã€‚

æœ€åï¼Œæˆ‘ä»¬æ¥åˆ°äº†è¿™æ ·ä¸€ä¸ªç•Œé¢ï¼š

![](https://static.tuture.co/c/34a473b/172281ab67e5569b.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸ªç•Œé¢å·¦ä¾§å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ä¸€ç›´æåˆ°çš„ â€œç”¨æˆ·æ± â€ ç®¡ç†ç•Œé¢ï¼Œé»˜è®¤é€‰ä¸­äº†æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ â€œå›¾é›€ç¤¾åŒºåšå®¢å°ç¨‹åºâ€ï¼Œä¸€ä¸ªç”¨æˆ·æ± å°±æ˜¯ä¸€æ•´å¥—ç”¨æˆ·ä»¥åŠå’Œç”¨æˆ·ç™»å½•ã€æ³¨å†Œã€é‰´æƒã€ç™»å½•çŠ¶æ€ã€æ´»è·ƒã€æƒé™ç­‰æœ‰å…³çš„é€»è¾‘ã€‚

ä¸­é—´å°±æ˜¯å•ä¸ªç”¨æˆ·æ± é‡Œé¢çš„ä¸€äº›ä»‹ç»ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªç±»ä¼¼ Github é‚£ä¸ªçƒ­åŠ›å›¾ä¸€æ ·çš„ç”¨æˆ·ç™»å½•çƒ­åŠ›å›¾ï¼Œä½ å¯ä»¥æ–¹ä¾¿çš„çœ‹åˆ°é‚£å¤©æœ‰å¤šå°‘æ¬¡ç”¨æˆ·ç™»å½•ï¼Œå¾€ä¸‹æ»‘å¯ä»¥çœ‹åˆ°æ›´å¤šç”¨æˆ·æ•°æ®åˆ†ææ–¹é¢çš„å›¾è¡¨å’Œå†…å®¹ã€‚

### ä¸‹è½½å’Œé…ç½® SDK

æ³¨å†Œå®Œè´¦å·ã€å»ºç«‹äº†ç”¨æˆ·æ± ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½ Authing ä¸ºæˆ‘ä»¬æä¾›çš„å¾®ä¿¡å°ç¨‹åº SDK æ¥é›†æˆç”¨æˆ·ç³»ç»Ÿï¼Œç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://docs.authing.cn/authing/sdk/authing-sdk-for-wxapp?utm_source=tuture)å»å¾€å°ç¨‹åºå¼€å‘æ–‡æ¡£ã€‚

æ ¹æ®æ–‡æ¡£ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¾®ä¿¡å°ç¨‹åºåå°é…ç½®ä¸¤ä¸ªåŸŸåç™½åå•ï¼š

- `https://oauth.authing.cn` å’Œ `https://users.authing.cn` 

ç„¶åå°†å¾®ä¿¡å°ç¨‹åºçš„ `AppId` å’Œ `AppSecret` å¡«å…¥ Authing å¯¹åº”çš„åœ°å€ï¼š

![](https://static.tuture.co/c/34a473b/172281ab696b133d.png)

è¿™ä¸ªç•Œé¢ï¼Œç„¶åæ»‘åŠ¨åˆ°åº•éƒ¨ï¼Œé€‰æ‹©å°ç¨‹åºå†…ç™»é™†ï¼š

![](https://static.tuture.co/c/34a473b/172281ab9666de85.png)

åœ¨å¼¹å‡ºçš„æ¡†é‡Œé¢å¡«å…¥å¯¹åº”çš„å¾®ä¿¡å°ç¨‹åºçš„ `AppId` å’Œ `AppSecret` ï¼š

![](https://static.tuture.co/c/34a473b/172281ab9903fdd9.png)

é…ç½®å¥½ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å¯ä»¥å°† SDK ä»£ç ä¸‹è½½ï¼Œå¹¶æ”¾è¿›æˆ‘ä»¬çš„é¡¹ç›®é‡Œï¼Œæ‰¾ä¸€ä¸ªåœ°æ–¹ï¼ˆéç°æœ‰é¡¹ç›®ä¸­ï¼‰ï¼Œè¿è¡Œå¦‚ä¸‹è„šæœ¬ï¼ŒClone å°ç¨‹åº SDKï¼š

```bash
$ git clone https://github.com/Authing/authing-wxapp-sdk
```

ç„¶åæ‰“å¼€æ­¤é¡¹ç›®ï¼Œå°†å…¶ä¸­çš„ `authing` æ–‡ä»¶å¤¹æ‹·è´è¿›æˆ‘ä»¬ `ultra-club` å°ç¨‹åºçš„ `src/utils` ç›®å½•ä¸‹ï¼Œæœ€åçš„ç›®å½•ç»“æ„çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·ï¼š

```bash
src
â”œâ”€â”€ store
â”‚   â””â”€â”€ index.js
â””â”€â”€ utils
    â””â”€â”€ authing
        â”œâ”€â”€ authing.js
        â”œâ”€â”€ configs.js
        â”œâ”€â”€ graphql
        â”‚   â””â”€â”€ wxgql.js
        â””â”€â”€ utils
            â”œâ”€â”€ qiniuUploader.js
            â”œâ”€â”€ util.js
            â””â”€â”€ wxapp_rsa.min.js
```

SDK å¼€å‘ç¯å¢ƒå‡†å¤‡å°±ç»ªâœŒï¸ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥é©¬ä¸Šæ¥é›†æˆæ‰‹æœºå·+éªŒè¯ç ç™»å½•çš„èº«ä»½é€»è¾‘ï¼

### å¼€å§‹é›†æˆ

æ‰“å¼€ `src/components/LoginForm/index.jsx` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```jsx src/components/LoginForm/index.jsx https://github.com/tuture-dev/ultra-club/blob/dfea82b0b6e11d1a575d99e95337f72c8a4eb6f9/src/components/LoginForm/index.jsx æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro, { useState, useRef, useEffect } from '@tarojs/taro'
import { View, Form } from '@tarojs/components'
import { AtButton, AtImagePicker } from 'taro-ui'
import { useDispatch } from '@tarojs/redux'

import { SET_IS_OPENED, SET_LOGIN_INFO } from '../../constants'
import CountDownButton from '../CountDownButton'
[tuture-add]import Authing from '../../utils/authing/authing'
import './index.scss'

export default function LoginForm(props) {
  // Login Form ç™»å½•æ•°æ®
  const [phone, setPhone] = useState('')
  const [phoneCode, setPhoneCode] = useState('')
  const countDownButtonRef = useRef(null)
[tuture-add]  let userPoolId = ''

  const dispatch = useDispatch()

  async function countDownButtonPressed() {
    if (!phone) {
      Taro.atMessage({
        type: 'error',
        message: 'æ‚¨è¿˜æ²¡æœ‰å¡«å†™æ‰‹æœº!',
      })

      return
    }

    countDownButtonRef.current.startCountDown()

[tuture-del]    // å¤„ç†å‘é€éªŒè¯ç äº‹ä»¶
[tuture-add]    try {
[tuture-add]      const authing = new Authing({
[tuture-add]        userPoolId,
[tuture-add]      })
[tuture-add]      const res = await authing.getVerificationCode(phone)
[tuture-add] 
[tuture-add]      if (res.code === 200) {
[tuture-add]        Taro.atMessage({
[tuture-add]          type: 'success',
[tuture-add]          message: 'æ‰‹æœºéªŒè¯ç å·²ç»å‘é€æˆåŠŸï¼Œæ³¨æ„æŸ¥æ”¶',
[tuture-add]        })
[tuture-add]      }
[tuture-add]    } catch (err) {
[tuture-add]      Taro.atMessage({
[tuture-add]        type: 'error',
[tuture-add]        message: 'éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åå°è¯• !',
[tuture-add]      })
[tuture-add]      console.log('err', err)
[tuture-add]    }
  }

  async function handleSubmit(e) {
    e.preventDefault()

    // é‰´æƒæ•°æ®
    if (!phone || !phoneCode) {
      Taro.atMessage({
        type: 'error',
        message: 'æ‚¨è¿˜æœ‰å†…å®¹æ²¡æœ‰å¡«å†™ï¼',
      })

      return
    }

[tuture-del]    // å¤„ç†ç™»å½•å’Œæ³¨å†Œ
[tuture-add]    try {
[tuture-add]      const authing = new Authing({
[tuture-add]        userPoolId,
[tuture-add]      })
[tuture-add] 
[tuture-add]      const userInfo = await authing.loginByPhoneCode({
[tuture-add]        phone,
[tuture-add]        phoneCode,
[tuture-add]      })
[tuture-add] 
[tuture-add]      // æç¤ºç™»å½•æˆåŠŸ
[tuture-add]      Taro.atMessage({
[tuture-add]        type: 'success',
[tuture-add]        message: 'æ­å–œæ‚¨ï¼Œç™»å½•æˆåŠŸï¼',
[tuture-add]      })
[tuture-add] 
[tuture-add]      const { nickname, photo, _id } = userInfo
[tuture-add] 
[tuture-add]      // å‘åç«¯å‘èµ·ç™»å½•è¯·æ±‚
[tuture-add]      await Taro.setStorage({
[tuture-add]        key: 'userInfo',
[tuture-add]        data: {
[tuture-add]          nickName: nickname,
[tuture-add]          avatar: photo,
[tuture-add]          _id,
[tuture-add]        },
[tuture-add]      })
[tuture-add] 
[tuture-add]      await Taro.setStorage({
[tuture-add]        key: 'token',
[tuture-add]        data: userInfo.token,
[tuture-add]      })
[tuture-add] 
[tuture-add]      dispatch({
[tuture-add]        type: SET_LOGIN_INFO,
[tuture-add]        payload: { nickName: nickname, avatar: photo, userId: _id },
[tuture-add]      })
[tuture-add] 
[tuture-add]      dispatch({ type: SET_IS_OPENED, payload: { isOpened: false } })
[tuture-add]    } catch (err) {
[tuture-add]      Taro.atMessage({
[tuture-add]        type: 'error',
[tuture-add]        message: 'ç™»å½•å¤±è´¥',
[tuture-add]      })
[tuture-add]    }
  }

  return (
    <View className="post-form">
      <Form onSubmit={handleSubmit}>
        <View className="login-box">
          <Input
            className="input-phone input-item"
            type="text"
            placeholder="è¾“å…¥æ‰‹æœºå·"
            value={phone}
            onInput={e => setPhone(e.target.value)}
          />
          <View className="verify-code-box">
            <Input
              className="input-nickName input-item"
              type="text"
              placeholder="å››ä½éªŒè¯ç "
              value={phoneCode}
              onInput={e => setPhoneCode(e.target.value)}
            />
            <CountDownButton
              onClick={countDownButtonPressed}
              ref={countDownButtonRef}
            />
          </View>
          <AtButton formType="submit" type="primary">
            ç™»å½•
          </AtButton>
          <View className="at-article__info">
            é€šè¿‡æ‰‹æœºå’ŒéªŒè¯ç æ¥ç™»å½•ï¼Œå¦‚æœæ²¡æœ‰è´¦å·ï¼Œæˆ‘ä»¬å°†è‡ªåŠ¨åˆ›å»º
          </View>
        </View>
      </Form>
    </View>
  )
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å†…å®¹ä¸»è¦æœ‰å¦‚ä¸‹å‡ å¤„ä¿®æ”¹ï¼š

- æˆ‘ä»¬é¦–å…ˆå¼•å…¥äº†ä¸Šä¸€æ­¥é‡Œé¢ä¸‹è½½çš„ Authing  SDK
- æ¥ç€æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `userPoolId` ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å‰é¢åˆ›å»º â€œå›¾é›€ç¤¾åŒºåšå®¢å°ç¨‹åºâ€ ç”¨æˆ·æ± çš„æ ‡å¿— IDï¼Œè¿™é‡Œè¯»è€…éœ€è¦å‰å¾€ Authing æ§åˆ¶å°ç•Œé¢ï¼Œè·å–ç”¨æˆ·æ±  IDï¼Œå¹¶æ›¿æ¢ä¸Šé¢çš„ç©ºå­—ç¬¦ä¸²ï¼š

![](https://static.tuture.co/c/34a473b/172281ab9d8b1772.png)

- æ¥ç€æˆ‘ä»¬åœ¨ `countDownButtonPressed` å‡½æ•°å†…è¿›è¡Œå‘èµ·æ‰‹æœºéªŒè¯ç æ“ä½œï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ `new Authing` ä¼ å…¥ç”¨æˆ·æ±  ID `userPoolId` åˆå§‹åŒ–ä¸€ä¸ªä¸€ä¸ªå®ä¾‹å¹¶å‘½åä¸º `authing` ï¼Œè¿™ä¸€æ­¥ä»£è¡¨æˆ‘ä»¬æ‹¿åˆ°äº†æ­¤é¡µç”¨æˆ·æ± çš„æ“ä½œæƒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œç”¨æˆ·æœ‰å…³çš„æ“ä½œäº†ã€‚
- æ¥ç€æˆ‘ä»¬ä½¿ç”¨ `authing.getVerificationCode` æ–¹æ³•ï¼Œä¼ å…¥å¡«å†™çš„æ‰‹æœºå· `phone` ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥ Promise å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ `await` å…³é”®å­—è·å–å…¶ç»“æœï¼Œå½“ç»“æœ `res.code` ä¸º 200ï¼Œä»£è¡¨å‘é€éªŒè¯ç æˆåŠŸï¼Œæˆ‘ä»¬æç¤ºç”¨æˆ·å‘é€éªŒè¯ç æˆåŠŸï¼Œå¦åˆ™æé†’å‘é€éªŒè¯ç å¤±è´¥ï¼Œå½“ç¼–å†™äº†ä¸Šé¢çš„ä»£ç å¹¶ä¿å­˜ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€å°ç¨‹åºå°è¯•ä¸€ä¸‹æ•ˆæœï¼Œè¾“å…¥æ‰‹æœºå·ï¼Œå¹¶ç‚¹å‡»å‘é€éªŒè¯ç ï¼š

![](https://static.tuture.co/c/34a473b/172281aba373023a.gif)

å½“ç„¶ä¸Šé¢çš„æ‰‹æœºå·æˆ‘çè¾“å…¥çš„ï¼Œè¯»è€…è¯·è‡ªè¡Œè¾“å…¥è‡ªå·±çš„æ‰‹æœºå·å°è¯•ï¼Œæ¥ç€åº”è¯¥å¯ä»¥åœ¨æ‰‹æœºä¸Šæ”¶åˆ°éªŒè¯ç çŸ­ä¿¡ï¼š

![](https://static.tuture.co/c/34a473b/172281aba386117a.jpeg)

BoomğŸ’¥ï¼å¯ä»¥çœ‹åˆ°ç®€å•å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±æå®šäº†æ‰‹æœºéªŒè¯ç çš„å‘é€ã€‚

- æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®Œå–„ä¸€ä¸‹ä½¿ç”¨æ‰‹æœº+éªŒè¯ç ç™»å½•çš„é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨ `handleSubmit` é‡Œé¢ç¼–å†™äº†ä¸€ä¸ª `try/catch` è¯­å¥ï¼Œç„¶ååˆå§‹åŒ– Authing å¯¹è±¡ï¼Œå¹¶è°ƒç”¨æ–¹æ³• `authing.loginByPhoneCode` ä¼ å…¥æˆ‘ä»¬çš„æ‰‹æœºå·ï¼ˆ`phone` ï¼‰å’ŒéªŒè¯ç  `phoneCode` ï¼Œè¿›è¡Œè°ƒç”¨ä¹‹åï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ‰‹æœºå·+éªŒè¯ç ç™»å½•ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤ä¼šå¯¹æœªç™»å½•ç”¨æˆ·è¿›è¡Œåˆ›å»ºè´¦å·æ“ä½œï¼Œä¸éœ€è¦ç”¨æˆ·é¢å¤–å¤„ç†å…¶ä»–é€»è¾‘ã€‚
- æ¥ç€ï¼Œæˆ‘ä»¬é€šè¿‡ç™»å½•æˆåŠŸè¿”å›çš„ `userInfo` æ‹¿åˆ°å†…å®¹ï¼Œåšå‡ºä¿®æ”¹å¹¶è®¾ç½®åˆ° `storage` é‡Œï¼Œä»¥åŠå­˜åœ¨  Redux Store é‡Œé¢ï¼Œå¹¶æç¤ºç”¨æˆ·ç™»å½•æˆåŠŸã€‚å½“ç„¶å¦‚æœç™»å½•å¤±è´¥ï¼Œæˆ‘ä»¬è¿˜ä¼šæç¤ºç”¨æˆ·ç™»å½•å¤±è´¥ã€‚

{% note info %}
**æç¤º**

1. è¿™é‡Œæˆ‘ä»¬åšäº†æ•°æ®æ ¼å¼çš„é€‚åº”ï¼Œå¦‚å°† Authing ç™»å½•è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ `userInfo.nickname` é€‚åº”æˆ `nickName` ï¼Œæ˜¯ä¸ºäº†åŒ¹é…ä¹‹å‰çš„å°ç¨‹åºç³»ç»Ÿçš„æ•°æ®æ ¼å¼ã€‚
2. å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¢å¤–å­˜äº†ä¸€ä¸ª `userInfo.token` åˆ° `storage` é‡Œé¢ï¼Œè¿™ä¸ª `token` å°±æ˜¯æˆ‘ä»¬ç”¨æˆ·ç³»ç»Ÿé‡Œé¢ç”¨äºç”¨æˆ·é‰´æƒçš„æ ‡å¿—ï¼Œä¹‹åæˆ‘ä»¬å°†ç”¨è¿™ä¸ª token æ¥æ£€æŸ¥ç”¨æˆ·çš„ç™»å½•çŠ¶æ€å¹¶è¿›è¡Œç”¨æˆ·ç™»å½•æ€çš„ä¿æŒã€‚
{% endnote %}

ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¡«å…¥æ‰‹æœºå·ï¼Œç‚¹å‡»è·å–éªŒè¯ç ï¼Œå¹¶å°†éªŒè¯ç å¡«å…¥å°ç¨‹åºçš„è¾“å…¥æ¡†ï¼Œç‚¹å‡»ç™»å½•åº”è¯¥å°±å¯ä»¥ç™»å½•æˆåŠŸï¼š

![](https://static.tuture.co/c/34a473b/172281abae530ec7.png)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ”¶è·äº†ä¸€ä¸ªé»˜è®¤çš„ â€œé…·é…·çš„å¤´åƒâ€ï¼Œå¹¶ä¸”æç¤ºäº†ç™»å½•æˆåŠŸã€‚å¤§åŠŸå‘Šæˆï¼Œä¸€ä¸ªä¸“ä¸šçš„åªéœ€è¦æ‰‹æœºå·+éªŒè¯ç çš„ç™»å½•ç•Œé¢+é€»è¾‘æˆ‘ä»¬å°±å®Œæ•´å®ç°äº†ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸»è¦åœ¨ç•Œé¢çš„è°ƒæ•´å’Œ SDKçš„å¼•å…¥ä¸ŠåºŸäº†ä¸€ç‚¹åŠŸå¤«ï¼Œå®é™…ä¸Šå®ç°æ•´ä¸ªé€»è¾‘ï¼ŒçœŸçš„åªéœ€è¦å‡ è¡Œä»£ç ï¼å› ä¸º Authing åœ¨èƒŒååšäº†å¤§é‡çš„å·¥ä½œæ¥ç¡®ä¿ä¸Šå±‚é€»è¾‘çš„ç®€å•ã€‚

## å¤„ç†ç™»å‡ºé€»è¾‘

åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸå°†ç™»å½•é€»è¾‘è¿ç§»åˆ°äº†æ‰‹æœºå·+éªŒè¯ç çš„æ–¹å¼ï¼Œå¹¶ä¸”é€šè¿‡ç®€å•å‡ è¡Œä»£ç å®ç°äº†éªŒè¯ç çš„å‘é€ï¼Œä»¥åŠç™»å½•ã€‚

å› ä¸ºæˆ‘ä»¬çš„ç™»å½•é€»è¾‘ç›¸æ¯”ä¹‹å‰æœ‰äº†ä¸€äº›å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€‚å½“çš„è°ƒæ•´æˆ‘ä»¬çš„ç™»å‡ºé€»è¾‘ï¼Œä»¥é€‚åº”è¿™äº›å˜åŒ–ã€‚

### æ”¹è¿›ç™»å‡ºç»„ä»¶

æ‰“å¼€ `src/components/Logout/index.js` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹åšå‡ºå¯¹åº”çš„ä¿®æ”¹ï¼š

```js src/components/Logout/index.js https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Logout/index.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro, { useState } from '@tarojs/taro'
import { AtButton } from 'taro-ui'
[tuture-del]import { useDispatch } from '@tarojs/redux'
[tuture-add]import { useDispatch, useSelector } from '@tarojs/redux'

import { SET_LOGIN_INFO } from '../../constants'
[tuture-add]import Authing from '../../utils/authing/authing'

export default function LoginButton(props) {
  const [isLogout, setIsLogout] = useState(false)
  const dispatch = useDispatch()
[tuture-add]  const userId = useSelector(state => state.user.userId)

  async function handleLogout() {
    setIsLogout(true)

    try {
      await Taro.removeStorage({ key: 'userInfo' })
[tuture-add]      await Taro.removeStorage({ key: 'token' })
[tuture-add] 
[tuture-add]      const userPoolId = ''
[tuture-add]      const authing = new Authing({
[tuture-add]        userPoolId,
[tuture-add]      })
[tuture-add] 
[tuture-add]      await authing.logout(userId)

      dispatch({
        type: SET_LOGIN_INFO,
        payload: {
          avatar: '',
          nickName: '',
          userId: '',
        },
      })
    } catch (err) {
      console.log('removeStorage ERR: ', err)
    }

    setIsLogout(false)
  }

  return (
    <AtButton type="secondary" full loading={isLogout} onClick={handleLogout}>
      é€€å‡ºç™»å½•
    </AtButton>
  )
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å†…å®¹ä¸»è¦æœ‰å¦‚ä¸‹å‡ å¤„ä¿®æ”¹ï¼š

- æˆ‘ä»¬åœ¨ `handleLogout` å‡½æ•°é‡Œå¤„ç†ç™»å‡ºé€»è¾‘çš„æ—¶å€™ï¼Œé¦–å…ˆåˆå§‹åŒ–äº†ä¸€ä¸ª `authing` å®ä¾‹ï¼Œä¸»è¦è¿™é‡Œçš„ `userPoolId` ä¹Ÿéœ€è¦è¯»è€…æ›¿æ¢æˆä½ è‡ªå·±çš„ï¼Œå¯ä»¥åœ¨ Authing æ§åˆ¶å°è·å–ï¼Œæ¥ç€è°ƒç”¨ `authing.logout` ä¼ å…¥ç”¨æˆ·çš„ `userId` æ¥ç™»å‡ºæ­¤ç”¨æˆ·ï¼Œè¿™æ ·ä¹‹åå°±ä¸èƒ½æ“ä½œ Authing ä¸Šåˆ›å»ºçš„ç”¨æˆ·æ± äº†
- å…³äº `userId` çš„è·å–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `react-redux` é’©å­ `useSelector` ä» Redux Store é‡Œé¢è·å–ã€‚
- æœ€åæˆ‘ä»¬è¿˜è¦åˆ é™¤ `storage` é‡Œé¢å­˜å‚¨çš„ `token` ã€‚

### æ¸…ç†å…¶ä»–ç™»å‡ºé€»è¾‘

å› ä¸ºç›®å‰æˆ‘ä»¬çš„ç™»é™†ä¸æ˜¯ä¹‹å‰çš„ä½¿ç”¨ `nickName` å’Œ `avatar` ï¼Œè€Œæ˜¯ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ç™»å½•ä¹‹åé»˜è®¤çš„ `nickName` ä¸ºç©ºï¼Œè€Œæˆ‘ä»¬ä¹‹å‰çš„åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•çš„ç»„ä»¶é€»è¾‘éƒ½æ˜¯åˆ¤æ–­ `nickName` æ˜¯å¦å­˜åœ¨ï¼Œè¿™é‡Œå°±æœ‰é—®é¢˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ã€‚

æ‰“å¼€ `src/components/Footer/index.js` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```js src/components/Footer/index.js https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Footer/index.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro from '@tarojs/taro'
import { View } from '@tarojs/components'
import { AtFloatLayout } from 'taro-ui'
import { useSelector, useDispatch } from '@tarojs/redux'

import Logout from '../Logout'
import LoginForm from '../LoginForm'
import './index.scss'
import { SET_IS_OPENED } from '../../constants'

export default function Footer(props) {
[tuture-del]  const nickName = useSelector(state => state.user.nickName)
[tuture-add]  const userId = useSelector(state => state.user.userId)

  const dispatch = useDispatch()

  // åŒå–åæ¥æ„é€ å­—ç¬¦ä¸²å¯¹åº”çš„å¸ƒå°”å€¼ï¼Œç”¨äºæ ‡å¿—æ­¤æ—¶æ˜¯å¦ç”¨æˆ·å·²ç»ç™»å½•
[tuture-del]  const isLogged = !!nickName
[tuture-add]  const isLogged = !!userId

  // ä½¿ç”¨ useSelector Hooks è·å– Redux Store æ•°æ®
  const isOpened = useSelector(state => state.user.isOpened)

  return (
    <View className="mine-footer">
      {isLogged && <Logout />}
      <View className="tuture-motto">
        {isLogged ? 'From å›¾é›€ç¤¾åŒº with Love â¤' : 'æ‚¨è¿˜æœªç™»å½•'}
      </View>
      <AtFloatLayout
        isOpened={isOpened}
        title="ç™»å½•"
        onClose={() =>
          dispatch({ type: SET_IS_OPENED, payload: { isOpened: false } })
        }
      >
        <LoginForm />
      </AtFloatLayout>
    </View>
  )
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å†…å®¹ä¸»è¦å°±æ˜¯å°† `nickName` æ›¿æ¢æˆäº† `userId` ï¼Œå¹¶ç”¨ `userId` åˆ¤æ–­æ˜¯å¦å¤„äºç™»å½•çŠ¶æ€ã€‚

åŒæ ·çš„ï¼Œ`src/components/Header/index.js` ä¹Ÿè¦ä½œå‡ºç±»ä¼¼çš„ä¿®æ”¹ï¼š

```js src/components/Header/index.js https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Header/index.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro from '@tarojs/taro'
import { View } from '@tarojs/components'
import { AtMessage } from 'taro-ui'
import { useSelector } from '@tarojs/redux'

import LoggedMine from '../LoggedMine'
import LoginButton from '../LoginButton'
import WeappLoginButton from '../WeappLoginButton'
import AlipayLoginButton from '../AlipayLoginButton'

import './index.scss'

export default function Header(props) {
[tuture-del]  const nickName = useSelector(state => state.user.nickName)
[tuture-add]  const userId = useSelector(state => state.user.userId)

  // åŒå–åæ¥æ„é€ å­—ç¬¦ä¸²å¯¹åº”çš„å¸ƒå°”å€¼ï¼Œç”¨äºæ ‡å¿—æ­¤æ—¶æ˜¯å¦ç”¨æˆ·å·²ç»ç™»å½•
[tuture-del]  const isLogged = !!nickName
[tuture-add]  const isLogged = !!userId

  const isWeapp = Taro.getEnv() === Taro.ENV_TYPE.WEAPP
  const isAlipay = Taro.getEnv() === Taro.ENV_TYPE.ALIPAY

  return (
    <View className="user-box">
      <AtMessage />
      <LoggedMine />
      {!isLogged && (
        <View className="login-button-box">
          <LoginButton />
          {isWeapp && <WeappLoginButton />}
          {isAlipay && <AlipayLoginButton />}
        </View>
      )}
    </View>
  )
}
```

è¿˜æœ‰æˆ‘ä»¬çš„ â€œæˆ‘çš„â€ é¡µé¢ï¼Œ`src/pages/mine/mine.jsx` æ–‡ä»¶ï¼š

```jsx src/pages/mine/mine.jsx https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/pages/mine/mine.jsx æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro, { useEffect } from '@tarojs/taro'
import { View } from '@tarojs/components'
import { useDispatch, useSelector } from '@tarojs/redux'

import { Header, Footer } from '../../components'
import './mine.scss'
import { SET_LOGIN_INFO } from '../../constants'

export default function Mine() {
  const dispatch = useDispatch()
[tuture-del]  const nickName = useSelector(state => state.user.nickName)
[tuture-add]  const userId = useSelector(state => state.user.userId)

[tuture-del]  const isLogged = !!nickName
[tuture-add]  const isLogged = !!userId

  useEffect(() => {
    async function getStorage() {
      try {
        const { data } = await Taro.getStorage({ key: 'userInfo' })

        const { nickName, avatar, _id } = data

        // æ›´æ–° Redux Store æ•°æ®
        dispatch({
          type: SET_LOGIN_INFO,
          payload: { nickName, avatar, userId: _id },
        })
      } catch (err) {
        console.log('getStorage ERR: ', err)
      }
    }

    if (!isLogged) {
      getStorage()
    }
  })

  return (
    <View className="mine">
      <Header />
      <Footer />
    </View>
  )
}

Mine.config = {
  navigationBarTitleText: 'æˆ‘çš„',
}
```

æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹é¦–é¡µçš„ `src/pages/index/index.jsx` ï¼š

```jsx src/pages/index/index.jsx https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/pages/index/index.jsx æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro, { useEffect } from '@tarojs/taro'
import { View, Text } from '@tarojs/components'
import { AtFab, AtFloatLayout, AtMessage } from 'taro-ui'
import { useSelector, useDispatch } from '@tarojs/redux'

import { PostCard, PostForm } from '../../components'
import './index.scss'
import {
  SET_POST_FORM_IS_OPENED,
  SET_LOGIN_INFO,
  GET_POSTS,
} from '../../constants'

export default function Index() {
  const posts = useSelector(state => state.post.posts) || []
  const isOpened = useSelector(state => state.post.isOpened)
[tuture-del]  const nickName = useSelector(state => state.user.nickName)
[tuture-add]  const userId = useSelector(state => state.user.userId)

[tuture-del]  const isLogged = !!nickName
[tuture-add]  const isLogged = !!userId

  const dispatch = useDispatch()

  useEffect(() => {
    const WeappEnv = Taro.getEnv() === Taro.ENV_TYPE.WEAPP

    if (WeappEnv) {
      Taro.cloud.init()
    }

    async function getStorage() {
      try {
        const { data } = await Taro.getStorage({ key: 'userInfo' })

        const { nickName, avatar, _id } = data

        // æ›´æ–° Redux Store æ•°æ®
        dispatch({
          type: SET_LOGIN_INFO,
          payload: { nickName, avatar, userId: _id },
        })
      } catch (err) {
        console.log('getStorage ERR: ', err)
      }
    }

    if (!isLogged) {
      getStorage()
    }

    async function getPosts() {
      try {
        // æ›´æ–° Redux Store æ•°æ®
        dispatch({
          type: GET_POSTS,
        })
      } catch (err) {
        console.log('getPosts ERR: ', err)
      }
    }

    if (!posts.length) {
      getPosts()
    }
  }, [])

  function setIsOpened(isOpened) {
    dispatch({ type: SET_POST_FORM_IS_OPENED, payload: { isOpened } })
  }

  function handleClickEdit() {
    if (!isLogged) {
      Taro.atMessage({
        type: 'warning',
        message: 'æ‚¨è¿˜æœªç™»å½•å“¦ï¼',
      })
    } else {
      setIsOpened(true)
    }
  }

  console.log('posts', posts)

  return (
    <View className="index">
      <AtMessage />
      {posts.map(post => (
        <PostCard key={post._id} postId={post._id} post={post} isList />
      ))}
      <AtFloatLayout
        isOpened={isOpened}
        title="å‘è¡¨æ–°æ–‡ç« "
        onClose={() => setIsOpened(false)}
      >
        <PostForm />
      </AtFloatLayout>
      <View className="post-button">
        <AtFab onClick={handleClickEdit}>
          <Text className="at-fab__icon at-icon at-icon-edit"></Text>
        </AtFab>
      </View>
    </View>
  )
}

Index.config = {
  navigationBarTitleText: 'é¦–é¡µ',
}
```

ä¿®æ”¹äº†å¦‚ä¸Šä»£ç å¹¶ä¿å­˜ä¹‹åï¼Œæ‰“å¼€åº”ç”¨ï¼Œæˆ‘ä»¬ç‚¹å‡»ç™»å‡ºï¼Œåº”è¯¥é¡ºåˆ©çœ‹åˆ°å¦‚ä¸‹æ•ˆæœï¼š

![](https://static.tuture.co/c/34a473b/172281abc7d4f9b3.gif)

### å°ç»“

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å‘¼åº”ä½¿ç”¨ Authing ç™»å½•çš„é€»è¾‘ï¼Œå¯¹åº”ä¿®æ”¹äº†ç™»å‡ºé€»è¾‘ï¼Œå¹¶ä¸”ä½¿ç”¨ `userId` æ›¿æ¢ `nickName` ä½œä¸ºæ˜¯å¦ç™»å½•çš„åˆ¤æ–­æ ‡å‡†ã€‚

## é›†æˆå¾®ä¿¡æˆæƒç™»å½•

åœ¨å‰ä¸¤å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Authing é›†æˆäº†æ‰‹æœºå·+éªŒè¯ç çš„ç™»å½•é€»è¾‘ï¼Œç„¶åå¤„ç†äº†ç™»å‡ºé€»è¾‘ï¼Œæœ‰åŒå­¦å¯èƒ½ä¼šé—®äº†ï¼Œæˆ‘ä»¬ä¹‹å‰æ˜¯å–ä»£äº†æ™®é€šç™»å½•ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾®ä¿¡ç™»å½•ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥ç”¨ Authing æ¥è¿›è¡Œæ›¿æ¢å‘¢ï¼Ÿæ¯•ç«Ÿé›†æˆç”¨æˆ·ç³»ç»Ÿè‚¯å®šè¦å…¨é¢é›†æˆï¼Œç­”æ¡ˆæ˜¯å¯ä»¥ï¼

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨ Authing ä¸ºæˆ‘ä»¬æä¾›çš„ `loginWithWxapp` ï¼Œå¿«æ·çš„å°†å¾®ä¿¡æˆæƒç™»å½•é›†æˆå¥½ï¼Œæ‰“å¼€ `src/components/WeappLoginButton/index.js` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```js src/components/WeappLoginButton/index.js https://github.com/tuture-dev/ultra-club/blob/29ce05bdb74dd53f6d83b82591186d2d1d10835b/src/components/WeappLoginButton/index.js æŸ¥çœ‹å®Œæ•´ä»£ç 
[tuture-del]import Taro, { useState } from '@tarojs/taro'
[tuture-add]import Taro, { useState, useEffect } from '@tarojs/taro'
import { Button } from '@tarojs/components'
import { useDispatch } from '@tarojs/redux'

import './index.scss'
[tuture-del]import { LOGIN } from '../../constants'
[tuture-add]import { SET_LOGIN_INFO } from '../../constants'
[tuture-add]import Authing from '../../utils/authing/authing'

export default function WeappLoginButton(props) {
  const [isLogin, setIsLogin] = useState(false)

  const dispatch = useDispatch()

  async function onGetUserInfo(e) {
    setIsLogin(true)

[tuture-del]    const { avatarUrl, nickName } = e.detail.userInfo
[tuture-del]    const userInfo = { avatar: avatarUrl, nickName }
[tuture-del] 
[tuture-del]    dispatch({
[tuture-del]      type: LOGIN,
[tuture-del]      payload: {
[tuture-del]        userInfo: userInfo,
[tuture-del]      },
[tuture-add]    const userPoolId = '5ea4ffa72b3a80b6eff60b65'
[tuture-add]    const authing = new Authing({
[tuture-add]      userPoolId,
    })

[tuture-add]    async function loginWithAuthing(code, detail) {
[tuture-add]      try {
[tuture-add]        const userInfo = await authing.loginWithWxapp({
[tuture-add]          code,
[tuture-add]          detail,
[tuture-add]        })
[tuture-add] 
[tuture-add]        // æç¤ºç™»å½•æˆåŠŸ
[tuture-add]        Taro.atMessage({
[tuture-add]          type: 'success',
[tuture-add]          message: 'æ­å–œæ‚¨ï¼Œç™»å½•æˆåŠŸï¼',
[tuture-add]        })
[tuture-add] 
[tuture-add]        const { nickname, photo, _id } = userInfo
[tuture-add] 
[tuture-add]        dispatch({
[tuture-add]          type: SET_LOGIN_INFO,
[tuture-add]          payload: { nickName: nickname, avatar: photo, userId: _id },
[tuture-add]        })
[tuture-add] 
[tuture-add]        // å‘åç«¯å‘èµ·ç™»å½•è¯·æ±‚
[tuture-add]        await Taro.setStorage({
[tuture-add]          key: 'userInfo',
[tuture-add]          data: {
[tuture-add]            nickName: nickname,
[tuture-add]            avatar: photo,
[tuture-add]            _id,
[tuture-add]          },
[tuture-add]        })
[tuture-add] 
[tuture-add]        await Taro.setStorage({
[tuture-add]          key: 'token',
[tuture-add]          data: userInfo.token,
[tuture-add]        })
[tuture-add] 
[tuture-add]        // å½“ code ç”¨äºç™»å½•ä¹‹åï¼Œä¼šå¤±æ•ˆï¼Œæ‰€ä»¥è¿™é‡Œé‡æ–°è·å– code
[tuture-add]        Taro.login({
[tuture-add]          success(res) {
[tuture-add]            const code = res.code
[tuture-add]            Taro.setStorageSync('code', code)
[tuture-add]          },
[tuture-add]        })
[tuture-add]      } catch (err) {
[tuture-add]        console.log('err', err)
[tuture-add]        Taro.atMessage({
[tuture-add]          type: 'success',
[tuture-add]          message: 'æ­å–œæ‚¨ï¼Œç™»å½•æˆåŠŸï¼',
[tuture-add]        })
[tuture-add]      }
[tuture-add]    }
[tuture-add] 
[tuture-add]    try {
[tuture-add]      const code = Taro.getStorageSync('code')
[tuture-add]      Taro.login({
[tuture-add]        success(res) {
[tuture-add]          const code = res.code
[tuture-add]          loginWithAuthing(code, e.detail)
[tuture-add]        },
[tuture-add]      })
[tuture-add]    } catch (err) {
[tuture-add]      console.log('err', err)
[tuture-add]    }
[tuture-add] 
    setIsLogin(false)
  }

  return (
    <Button
      openType="getUserInfo"
      onGetUserInfo={onGetUserInfo}
      type="primary"
      className="login-button"
      loading={isLogin}
    >
      å¾®ä¿¡ç™»å½•
    </Button>
  )
}
```

å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å†…å®¹ä¸»è¦æœ‰å¦‚ä¸‹å‡ å¤„ä¿®æ”¹ï¼š

- æˆ‘ä»¬åˆ é™¤äº†ä¹‹å‰ç®€å•ç²—æš´è·å–åˆ° `userInfo` é‡Œé¢çš„ `nickName` å’Œ `avatarUrl` å°±å‘èµ·ç™»å½•çš„ä»£ç é€»è¾‘ã€‚
- æˆ‘ä»¬åœ¨ `onGetUserInfo` é‡Œé¢åˆå§‹åŒ–äº†ä¸€ä¸ª `authing` å®ä¾‹ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ª `loginWithAuthing` æ–¹æ³•ï¼Œå…·ä½“ç»†èŠ‚æˆ‘ä»¬é©¬ä¸Šè®²è§£ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ `Taro.login` è°ƒç”¨å¾®ä¿¡æˆæƒç™»å½• APIï¼Œè·å–å¯¹åº”çš„ `code` ï¼Œå¹¶è¿åŒæŠŠ `onGetUserInfo` ä¼ è¿›æ¥çš„ `e.detail` ä¸€èµ·ä¼ ç»™ `loginWithAuthing` ã€‚
- åœ¨ `loginWithAuthing` å‡½æ•°é‡Œé¢ï¼Œå“¦ä»¬é¦–å…ˆè°ƒç”¨ `authing.loginWithWxapp` ï¼Œå¹¶ä¼ å…¥å¯¹åº”çš„ `code` å’Œ `detail` ï¼Œè¿›è¡Œç™»å½•ï¼Œç„¶åå°†ç™»å½•è·å–çš„ä¿¡æ¯å­˜åœ¨ `storage` é‡Œé¢ä»¥åŠä¿å­˜åœ¨ Redux Store ä¸­ï¼Œå¹¶æç¤ºç”¨æˆ·ç™»å½•æˆåŠŸã€‚

ä¿å­˜ä¸Šé¢çš„ä»£ç ï¼Œå¹¶è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ï¼Œä½ åº”è¯¥å¯ä»¥è‡ªç”±çš„æ“ä½œå¾®ä¿¡ç™»å½•äº†ï¼š

![](https://static.tuture.co/c/34a473b/172281abd1c93268.gif)

å°±è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸå°†å¾®ä¿¡æˆæƒç™»å½•ä½¿ç”¨ Authing é›†æˆå¥½äº†ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª `loginWithWxapp` å°±æŠŠé€»è¾‘é›†æˆå¥½äº†ï¼Œå®Œå…¨ä¸éœ€è¦ä¹‹å‰ `dispatch` ä¸€ä¸ª `LOGIN` è¯·æ±‚ï¼Œè¿˜è¦å»å¤„ç†ä¸€å † `sagas` é€»è¾‘ï¼Œå¹¶ä¸”è¿˜è¦ç¼–å†™å°ç¨‹åºäº‘å‡½æ•°é€»è¾‘ï¼Œæ‰‹åŠ¨å¤„ç†è¿™äº›é€»è¾‘ä¸ä»…ç¹çï¼Œè¿˜å®¹æ˜“å‡ºé”™ï¼Œå¹¶ä¸”ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè€Œ Authing æä¾›çš„ SDK å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸€ç‚¹ï¼Œèµ‹èƒ½ä¸šåŠ¡æˆåŠŸã€‚

## æ–°ç‰ˆç”¨æˆ·ç³»ç»Ÿæ•´åˆè¿›ç°æœ‰åç«¯

åœ¨ä¹‹å‰å››ä¸ªå°èŠ‚ï¼Œæˆ‘ä»¬éƒ½åœ¨å°†ç°æœ‰å°ç¨‹åºåšå®¢çš„ç”¨æˆ·é€»è¾‘ä½¿ç”¨ Authing æ¥æ›¿ä»£ï¼Œè€Œå°†ç”¨æˆ·é€»è¾‘ç”¨ Authing æ¥æ›¿ä»£ä¹‹åï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯ä¹‹å‰çš„ç”¨æˆ·ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—å¦‚æˆ‘ä»¬çš„å‘å¸–æ¨¡å—æ˜¯å­˜åœ¨è€¦åˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å°†è¿™ä¸ªè€¦åˆçš„éƒ¨åˆ†æ›¿æ¢æˆ Authing çš„ç›¸å…³é€»è¾‘ï¼Œè¿™å°±æ¶‰åŠåˆ°å¦‚ä½•å°†æ–°ç‰ˆçš„ç”¨æˆ·ç³»ç»Ÿæ•´åˆè¿›ç°æœ‰çš„åç«¯ã€‚

æˆ‘ä»¬ç›®å‰çš„åšå®¢å°ç¨‹åºæ¶‰åŠåˆ°å’Œç”¨æˆ·ç³»ç»Ÿè€¦åˆçš„éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬äº‘å‡½æ•° `createPost` åœ¨å‘å¸–çš„æ—¶å€™è¦å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªäº‘å‡½æ•°ä¸‹ä½¿ç”¨ Authing æ¥æ›¿æ¢ç›¸åº”çš„ç”¨æˆ·é€»è¾‘ã€‚

### å®‰è£… SDK

æˆ‘ä»¬çš„å¾®ä¿¡å°ç¨‹åºåå°ä½¿ç”¨äº†äº‘å‡½æ•°ï¼Œè€Œäº‘å‡½æ•°æ˜¯ä¸€ä¸ªä¸ªçš„ Node.js å‡½æ•°ï¼Œè€Œ Authing ä¸ºæˆ‘ä»¬æä¾›äº† Node.js çš„ SDK npm åŒ…ï¼Œæˆ‘ä»¬é©¬ä¸Šæ¥å®‰è£…å®ƒï¼Œåœ¨ `functions/createPost` ä¸‹æ‰§è¡Œå¦‚ä¸‹çš„ä»£ç ï¼š

```bash
$ npm install authing-js-sdk
```

æ‰§è¡Œä¹‹åï¼Œæˆ‘ä»¬çš„ `package.json` ä¼šæ˜¯å¦‚ä¸‹çš„æ ·å­ï¼š

```json functions/createPost/package.json https://github.com/tuture-dev/ultra-club/blob/336a60bbad354531b6c875f5f10319ad64a7267d/functions/createPost/package.json æŸ¥çœ‹å®Œæ•´ä»£ç 
{
  "name": "createPost",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
[tuture-add]    "authing-js-sdk": "^3.18.7",
    "wx-server-sdk": "latest"
  }
[tuture-del]}
[tuture-add]}
```

æ¥ç€ï¼Œæˆ‘ä»¬åœ¨äº‘å‡½æ•°é‡Œé¢æ›¿æ¢å¯¹åº”çš„é€»è¾‘ï¼Œæ‰“å¼€ `functions/createPost/index.js` æ–‡ä»¶ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹åšå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```js functions/createPost/index.js https://github.com/tuture-dev/ultra-club/blob/336a60bbad354531b6c875f5f10319ad64a7267d/functions/createPost/index.js æŸ¥çœ‹å®Œæ•´ä»£ç 
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')
[tuture-add]const Authing = require('authing-js-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV,
})

const db = cloud.database()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const { postData, userId } = event

[tuture-del]  console.log('event', event)
[tuture-add]  const userPoolId = ''
[tuture-add]  const secret = ''

  try {
[tuture-del]    const user = await db
[tuture-del]      .collection('user')
[tuture-del]      .doc(userId)
[tuture-del]      .get()
[tuture-add]    const authing = new Authing({
[tuture-add]      userPoolId,
[tuture-add]      secret,
[tuture-add]    })
[tuture-add]    const userInfo = await authing.user({ id: userId })
[tuture-add]    const { nickname, photo } = userInfo
[tuture-add] 
    const { _id } = await db.collection('post').add({
      data: {
        ...postData,
[tuture-del]        user: user.data,
[tuture-add]        user: { nickName: nickname, avatar: photo, _id: userInfo._id },
        createdAt: db.serverDate(),
        updatedAt: db.serverDate(),
      },
    })

    const newPost = await db
      .collection('post')
      .doc(_id)
      .get()

    return {
      post: { ...newPost.data },
    }
  } catch (err) {
    console.error(`createUser ERR: ${err}`)
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†å¦‚ä¸‹å‡ å¤„ä¿®æ”¹ï¼š

- æˆ‘ä»¬å¯¼å…¥äº† Authing SDK
- ç„¶åå‡½æ•°å†…éƒ¨æˆ‘ä»¬å®šä¹‰äº† `userPoolId` å’Œ `secret` æ¥åˆå§‹åŒ– `authing` å®ä¾‹ï¼Œè¿™ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ± æ§åˆ¶å°æ‰¾åˆ°ï¼š

![](https://static.tuture.co/c/34a473b/172281abd4f70166.png)

- æ¥ç€æˆ‘ä»¬ä½¿ç”¨åˆå§‹åŒ–å¥½çš„ `authing` æ¥è°ƒç”¨ `authing.user` æ–¹æ³•ä¼ å…¥æˆ‘ä»¬æ¥æ”¶åˆ°çš„ `userId` æŸ¥è¯¢åœ¨ Authing ä¸­ä¿å­˜çš„æ­¤ç”¨æˆ·èµ„æ–™ï¼Œå¹¶ç”¨è¿™ä¸ªç”¨æˆ·èµ„æ–™æ›¿æ¢æˆ‘ä»¬éœ€è¦åœ¨å°ç¨‹åºäº‘æ•°æ®åº“é‡Œé¢æŸ¥åˆ°çš„ç”¨æˆ·æ•°æ®

è‡ªæ­¤ï¼Œæˆ‘ä»¬å°±åœ¨å‰åç«¯æ·±åº¦æ•´åˆäº† Authing ç”¨æˆ·ç³»ç»Ÿï¼Œåœ¨ä¹‹åæˆ‘ä»¬çš„åº”ç”¨æ‰©å±•è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å’Œç”¨æˆ·æœ‰å…³çš„é€»è¾‘éƒ½ä¸éœ€è¦è‡ªå·±åœ¨åå°å•ç‹¬ç¼–å†™ï¼Œå‰ç«¯ä¹Ÿå¤§å¤§ç®€åŒ–äº†å·¥ä½œé‡ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜èƒ½åœ¨ Authing çš„æ§åˆ¶å°å¯è§†åŒ–ç”¨æˆ·çš„æ•°æ®ï¼šç™»å½•æƒ…å†µã€ç™»å½•åŒºåŸŸã€ç™»å½•æœºå™¨ï¼Œè¿˜å¯ä»¥ç»™ç”¨æˆ·è¿›è¡Œæƒé™åˆ†é…ï¼Œç”šè‡³ç›´æ¥ä¿®æ”¹ç”¨æˆ·èµ„æ–™ç­‰ã€‚

![](https://static.tuture.co/c/34a473b/172281abd746fd45.png)

## é€šè¿‡é‰´æƒä¿æœ‰ç”¨æˆ·ç™»å½•çŠ¶æ€

æœ€åï¼Œæˆ‘ä»¬æ¥æ”¶å°¾ä¸€ä¸‹ï¼Œåšä¸€ä¸‹ç”¨æˆ·ç™»å½•çŠ¶æ€çš„æŸ¥è¯¢ï¼Œå› ä¸ºåº”ç”¨çš„ç™»å½•å‡­è¯å®ƒå­˜åœ¨ä¸€ä¸ªå¤±æ•ˆæ—¶é—´ï¼Œå½“æ—¶é—´ä¸€åˆ°ï¼Œæˆ‘ä»¬å†å»æ“ä½œç”¨æˆ·ä¿¡æ¯å°±ä¼šæ˜¾ç¤ºæ²¡æœ‰æƒé™ï¼Œå› ä¸ºå‡­è¯å¤±æ•ˆäº†ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬è¦åŠæ—¶æ£€æŸ¥ç”¨æˆ·çš„ç™»å½•å‡­è¯æ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•ï¼Œè¿™ä¹Ÿæ˜¯è¯»è€…ç»å¸¸ä¼šåœ¨è®¿é—®æŸäº›ç½‘ç«™çš„æ—¶å€™é‡åˆ°ï¼Œè€Œç°åœ¨æˆ‘ä»¬å°†å®æ“ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚

ä¸€èˆ¬å¤„ç†ç”¨æˆ·ç™»å½•æ€çš„éªŒè¯ä¸»è¦æ˜¯åœ¨åº”ç”¨åˆšåˆšå¯åŠ¨æ—¶ï¼Œå»è¿›è¡Œä¸€ä¸ªé‰´æƒå¤„ç†ï¼Œå¦‚æœç”¨æˆ·æ€æœ‰æ•ˆï¼Œåˆ™é¡ºåˆ©ä»åº”ç”¨çš„ `storage`  é‡Œé¢å–å‡ºæ•°æ®ï¼Œç„¶åè®¾ç½®è¿›å‰ç«¯çŠ¶æ€ç®¡ç†ï¼Œè¿›è€Œå±•ç¤ºç”¨æˆ·æ•°æ®ï¼Œè€Œå¦‚æœæ²¡æœ‰åˆ™åˆ é™¤ `storage` é‡Œé¢çš„æ•°æ®ï¼Œæç¤ºç”¨æˆ·è¿›è¡Œç™»å½•ã€‚

æˆ‘ä»¬æ‰“å¼€ `src/pages/index/index.jsx` æ¥å®æ“ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹ä½œå‡ºå¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹ï¼š

```jsx src/pages/index/index.jsx https://github.com/tuture-dev/ultra-club/blob/c16984d25953ccee3a345815713cb54c9f9bc3fa/src/pages/index/index.jsx æŸ¥çœ‹å®Œæ•´ä»£ç 
import Taro, { useEffect } from '@tarojs/taro'
import { View, Text } from '@tarojs/components'
import { AtFab, AtFloatLayout, AtMessage } from 'taro-ui'
import { useSelector, useDispatch } from '@tarojs/redux'

import { PostCard, PostForm } from '../../components'
import './index.scss'
import {
  SET_POST_FORM_IS_OPENED,
  SET_LOGIN_INFO,
  GET_POSTS,
} from '../../constants'
[tuture-add]import Authing from '../../utils/authing/authing'

export default function Index() {
  const posts = useSelector(state => state.post.posts) || []
  const isOpened = useSelector(state => state.post.isOpened)
  const userId = useSelector(state => state.user.userId)

  const isLogged = !!userId

  const dispatch = useDispatch()

  useEffect(() => {
    const WeappEnv = Taro.getEnv() === Taro.ENV_TYPE.WEAPP

    if (WeappEnv) {
      Taro.cloud.init()
    }

    async function getStorage() {
[tuture-add]      // åœ¨åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¯¹åº”ç”¨è¿›è¡Œé‰´æƒï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœç™»å½•å¤±æ•ˆï¼Œåˆ™æƒ…å†µç¼“å­˜ä¿¡æ¯
      try {
[tuture-del]        const { data } = await Taro.getStorage({ key: 'userInfo' })
[tuture-add]        const userPoolId = ''
[tuture-add]        const { data: token } = await Taro.getStorage({ key: 'token' })
[tuture-add]        const authing = new Authing({
[tuture-add]          userPoolId,
[tuture-add]        })
[tuture-add]        const result = await Taro.request({
[tuture-add]          url: `https://users.authing.cn/authing/token?access_token=${userInfo.token}`,
[tuture-add]        })

[tuture-del]        const { nickName, avatar, _id } = data
[tuture-add]        if (result.data.status) {
[tuture-add]          const { data } = await Taro.getStorage({ key: 'userInfo' })

[tuture-del]        // æ›´æ–° Redux Store æ•°æ®
[tuture-del]        dispatch({
[tuture-del]          type: SET_LOGIN_INFO,
[tuture-del]          payload: { nickName, avatar, userId: _id },
[tuture-del]        })
[tuture-add]          const { nickName, avatar, _id } = data
[tuture-add] 
[tuture-add]          // æ›´æ–° Redux Store æ•°æ®
[tuture-add]          dispatch({
[tuture-add]            type: SET_LOGIN_INFO,
[tuture-add]            payload: { nickName, avatar, userId: _id },
[tuture-add]          })
[tuture-add]        } else {
[tuture-add]          await Taro.removeStorage({ key: 'userInfo' })
[tuture-add]          await Taro.removeStorage({ key: 'token' })
[tuture-add]        }
      } catch (err) {
        console.log('getStorage ERR: ', err)
      }
    }

    if (!isLogged) {
      getStorage()
    }

    async function getPosts() {
      try {
        // æ›´æ–° Redux Store æ•°æ®
        dispatch({
          type: GET_POSTS,
        })
      } catch (err) {
        console.log('getPosts ERR: ', err)
      }
    }

    if (!posts.length) {
      getPosts()
    }
  }, [])

  function setIsOpened(isOpened) {
    dispatch({ type: SET_POST_FORM_IS_OPENED, payload: { isOpened } })
  }

  function handleClickEdit() {
    if (!isLogged) {
      Taro.atMessage({
        type: 'warning',
        message: 'æ‚¨è¿˜æœªç™»å½•å“¦ï¼',
      })
    } else {
      setIsOpened(true)
    }
  }

  console.log('posts', posts)

  return (
    <View className="index">
      <AtMessage />
      {posts.map(post => (
        <PostCard key={post._id} postId={post._id} post={post} isList />
      ))}
      <AtFloatLayout
        isOpened={isOpened}
        title="å‘è¡¨æ–°æ–‡ç« "
        onClose={() => setIsOpened(false)}
      >
        <PostForm />
      </AtFloatLayout>
      <View className="post-button">
        <AtFab onClick={handleClickEdit}>
          <Text className="at-fab__icon at-icon at-icon-edit"></Text>
        </AtFab>
      </View>
    </View>
  )
}

Index.config = {
  navigationBarTitleText: 'é¦–é¡µ',
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å†…å®¹ä¸»è¦åšå‡ºäº†å¦‚ä¸‹å‡ å¤„ä¿®æ”¹ï¼š

- æˆ‘ä»¬åœ¨ `getStorage` å‡½æ•°é‡Œé¢ï¼Œé¦–å…ˆè·å–äº†ä¹‹å‰ç™»å½•æ—¶ä¿å­˜çš„ç”¨æˆ·å‡­è¯ `token` ï¼Œç„¶ååˆå§‹åŒ–äº†ä¸€ä¸ª `authing` å®ä¾‹ï¼Œå¹¶é€šè¿‡ `Taro.request` çš„æ–¹å¼ï¼Œå»è¯·æ±‚ Authing ä¸ºæˆ‘ä»¬æä¾›çš„é‰´æƒåœ°å€ï¼š`https://users.authing.cn/authing/token?access_token=YOUR_TOKEN ` ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé“¾æ¥ä¸­çš„ `YOUR_TOKEN` æ›¿æ¢æˆæˆ‘ä»¬ä¿å­˜åœ¨ `storage` é‡Œé¢çš„ `token` ï¼Œè®¿é—®è¿™ä¸ªåœ°å€å¦‚æœæˆåŠŸåˆ™ä¼šå¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š

```js
{
  "status": true,
  "message": "å·²ç™»å½•",
  "code": 200,
  "token": {
    "data": {
	"email": "YOUR_EMAIL@domain.com",
	"id": "YOUR_USER_ID",
	"clientId": "YOUR_UESR_POOL_ID"
    },
        "iat": "Token ç­¾å‘æ—¶é—´"
	"exp": "Token è¿‡æœŸæ—¶é—´"
    }
}
```

å¦‚æœå¤±è´¥å…¶ä¸­çš„ `status` ä¼šä¸º `false` ï¼Œå…¶å®ƒå†…å®¹ä¹Ÿä¼šç›¸åº”çš„å˜åŒ–ã€‚

- æ¥ç€æˆ‘ä»¬åˆ¤æ–­ `status` ï¼Œå¦‚æœä¸º `true` åˆ™ä» `storage` é‡Œé¢å–å‡ºæ•°æ®ï¼Œè®¾ç½®è¿› Redux Storeï¼Œå¦‚æœä¸º `false` ï¼Œæˆ‘ä»¬æ¸…ç©º `storage` æ•°æ®ï¼Œè¿™æ ·åœ¨ç”¨æˆ·å‘å¸–æ—¶ä¼šæç¤ºç”¨æˆ·éœ€è¦ç™»å½•ã€‚

## å°ç»“

é€šè¿‡è¿™ç¯‡æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä¹‹å‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ç”¨æˆ·ç³»ç»Ÿæ›¿æ¢æˆäº†ä¸“ä¸šçš„é€šç”¨äº‘èº«ä»½æä¾›å•† Authing æä¾›çš„ä¸“ä¸šçš„ç”¨æˆ·ç³»ç»Ÿï¼Œå¹¶ä¸”ä½“éªŒåˆ°äº†é€šè¿‡çŸ­çŸ­å‡ è¡Œä»£ç å°±å¯ä»¥å®ç°ä¸“ä¸šçš„æ‰‹æœºå·+éªŒè¯ç ç™»å½•ã€ç”¨æˆ·ç™»å‡ºã€å¾®ä¿¡æˆæƒç™»å½•ã€å¹¶ä¸”è¿˜å¯ä»¥åšç”¨æˆ·ç™»å½•çŠ¶æ€çš„æ£€æµ‹ç­‰ã€‚

æœ‰äº†è¿™æ ·ä¸€ä¸ªç®€å•ã€æ–¹ä¾¿ä¸”å¼ºå¤§çš„ç”¨æˆ·ç³»ç»Ÿåšä¿éšœä¹‹åï¼Œæˆ‘ä»¬çš„åšå®¢åº”ç”¨å°ç¨‹åºå°†å¯ä»¥æ— é¡¾è™‘çš„æ‰©å±•å…¶å®ƒæ¨¡å—ï¼Œè€Œæ¶‰åŠåˆ°èº«ä»½ç›¸å…³çš„å†…å®¹éƒ½å¯ä»¥äº¤ç»™ Authing æ¥åšã€‚å½“ç„¶æˆ‘ä»¬è¿™ç‰‡æ–‡ç« è¿˜åªç”¨äº† Authing å¾ˆå°çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œè¿˜æœ‰è¯¸å¦‚ä¼ä¸šç»„ç»‡ç®¡ç†ã€å•ç‚¹ç™»å½•ç­‰é«˜çº§åŠŸèƒ½ï¼Œæœ‰å…´è¶£çš„ç”¨æˆ·å¯ä»¥è‡ªè¡Œå‘æ˜ğŸ’ªï¼