<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <meta name="keywords" content="图雀社区,Tuture,Vue.js实战教程,微信小程序,Kotlin,React Native,Webpack,MVVM,React.js,Node.js,Redux,Django,MongoDB,Docker,JavaScript,Java,Go,Kubernetes,Nuxt,vue-router,react-router,小程序,跨端开发,Taro,react hooks,redux-saga,learn by doing,Web 前端实战教程,后端实战教程,小程序实战教程,移动端实战教程">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">
  <link rel="alternate" href="/atom.xml" title="图雀社区" type="application/atom+xml">
  <meta name="google-site-verification" content="uDCHIeBD5phhUIjsHM8GYeoNBYWJuQIJBjgchamUcAI">
  <meta name="yandex-verification" content="90341ba6c811f41d">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: true,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: true,
    algolia: {
      appID: '73BSUE4RKU',
      apiKey: '0b7cce26a4734cb760080065b3c4a4a1',
      indexName: 'Tuture',
      hits: {"per_page":10},
      labels: {"input_placeholder":"搜索教程","hits_empty":"我们找不到你搜索的教程: ${query}","hits_stats":"在 ${time} ms 内找到 ${hits} 条结果"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="为了让我们的博客看起来更加专业，我们打算给它也加上整上一个专业的用户系统，有了最为核心的用户系统在，我们博客之后的扩展都可以游刃有余，但是据统计，一个应用要想打造一个比较专业的用户系统，至少需要花费几个月时间，还需要花大量的精力去维护打造出来的用户系统，所在在做了一番调研之后，我们将目标放在了一个叫做 Authing 的通用云身份平台，它提供的服务就是帮应用快速集成一个高效、安全的用户系统，而我们">
<meta property="og:type" content="article">
<meta property="og:title" content="Taro 小程序开发大型实战（七）：使用 Authing 打造完整且强大的用户系统">
<meta property="og:url" content="https://tuture.co/2020/05/17/2b5a9f1/index.html">
<meta property="og:site_name" content="图雀社区">
<meta property="og:description" content="为了让我们的博客看起来更加专业，我们打算给它也加上整上一个专业的用户系统，有了最为核心的用户系统在，我们博客之后的扩展都可以游刃有余，但是据统计，一个应用要想打造一个比较专业的用户系统，至少需要花费几个月时间，还需要花大量的精力去维护打造出来的用户系统，所在在做了一番调研之后，我们将目标放在了一个叫做 Authing 的通用云身份平台，它提供的服务就是帮应用快速集成一个高效、安全的用户系统，而我们">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.powerformer.com/c/34a473b/taro-cover-9.jpg">
<meta property="article:published_time" content="2020-05-16T17:37:06.464Z">
<meta property="article:modified_time" content="2021-08-08T15:06:45.318Z">
<meta property="article:author" content="图雀社区">
<meta property="article:tag" content="Taro">
<meta property="article:tag" content="用户系统">
<meta property="article:tag" content="鉴权">
<meta property="article:tag" content="认证">
<meta property="article:tag" content="OAuth">
<meta property="article:tag" content="微信登录">
<meta property="article:tag" content="QQ登录">
<meta property="article:tag" content="Github登录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.powerformer.com/c/34a473b/taro-cover-9.jpg">
  <link rel="canonical" href="https://tuture.co/2020/05/17/2b5a9f1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Taro 小程序开发大型实战（七）：使用 Authing 打造完整且强大的用户系统 | 图雀社区</title>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-124499211-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-124499211-1');
    }
  </script>








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <style>
    span.line.tuture-add {
      font-weight: bold;
    }

    span.line.tuture-del {
      opacity: 0.3;
    }

    .profileBox {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .profileBox i {
      display: none;
    }

    .profileBox p {
      margin: 0;
      padding: 0;
    }

    .avatarBox {
      min-width: 60px;
    }

    .avatarBox .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0;
    }

    .avatarBox .avatar:hover {
      cursor: pointer;
    }

    .avatarBox {
      margin-right: 20px;
    }

    .rightBox {
      display:flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
    }

    .infoBox {
      min-width: 100px;
    }

    .infoBox p {
      padding: 0;
      margin: 0;
    }

    .infoBox .nickName {
      font-weight: bold;
      font-size: 20px;
      color: #979797;
      text-decoration: none;
    }

    .infoBox .nickName:hover {
      cursor: pointer;
    }

    .infoBox .motto {
      font-size: 16px;
      color: #979797;
    }

    .codeBox {
      margin-left: 49px;
      min-width: 100px;
    }

    .codeBox a {
      text-decoration: none;
    }

    .codeBox .exturl {
      border: none;
    }

    .codeBox span.codeText {
      display: inline-block;
      width: 100px;
      height: 40px;
      border-radius: 4px;
      border: 1px solid #979797;
      color: #979797;
      text-align: center;
      line-height: 40px;
      text-decoration: none;;
      transition: all 0.2s ease-in-out;
    }

    .codeBox .codeText:hover {
      cursor: pointer;
      background-color: #979797;
      color: #ffffff;
    }

    @media screen and (max-width:652px) {
      .profileBox {
        align-items: center;
        flex-direction: column;
      }

      .infoBox {
        margin-bottom: 20px;
      }

      .infoBox .nickName {
        text-align: center;
      }

      .rightBox {
        flex-direction: column;
        align-items: flex-start;
      }

      .codeBox {
        margin-left: 0;
      }

      .avatarBox {
        margin-right: 0;
      }
    }

    @media screen and (max-width:500px) {
      .rightBox {
        align-items: center;
      }

      .infoBox {
        margin-bottom: 20px;
      }

      .infoBox .nickName {
        text-align: center;
      }

      .infoBox .motto {
        text-align: center;
      }
    }

    .vsys {
      display:none !important;
      }

      figcaption .exturl {
        float: right;
      }
  </style>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/default.min.css">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">图雀社区</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">汇集精彩的实战技术教程</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
      
        
      
        
      
        
      
        
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
      
        
      
        
      
        
          
        
      
        
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">45</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
      
        
      
        
          
        
      
        
      
        
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">22</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
      
        
          
        
      
        
      
        
      
        
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">58</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-早报">
      
    
      
      
        
      
        
      
        
      
        
      
    

    <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvZGFpbHk="><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>早报</span>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
      
        
      
        
      
        
      
        
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-文档">
      
    
      
      
        
      
        
      
        
      
        
      
    

    <span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL3R1dHVyZS9wcm9kdWN0LW1hbnVhbHM="><i class="menu-item-icon fa fa-fw fa-book"></i> <br>文档</span>

  </li>
      
      
      
        
        <li class="menu-item menu-item-faq">
      
    
      
      
        
      
        
      
        
      
        
      
    

    <a href="/FAQ" rel="section"><i class="menu-item-icon fa fa-fw fa-question"></i> <br>FAQ</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZXByb2plY3QvaHVi" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://tuture.co/2020/05/17/2b5a9f1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="图雀社区">
      <meta itemprop="description" content="图雀社区是一个供大家分享用 Tuture 写作工具完成的教程的一个平台。在这里，读者们可以尽情享受高质量且免费的实战教程，并能与作者和其他读者互动和讨论；而作者们也可以借此传播他们的技术知识，宣传他们的开源项目，找到自己输出内容的受众，加速技术的传播。">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="图雀社区">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">Taro 小程序开发大型实战（七）：使用 Authing 打造完整且强大的用户系统

          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-05-17 01:37:06" itemprop="dateCreated datePublished" datetime="2020-05-17T01:37:06+08:00">2020-05-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-08 23:06:45" itemprop="dateModified" datetime="2021-08-08T23:06:45+08:00">2021-08-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" itemprop="url" rel="index"><span itemprop="name">小程序</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/Taro/" itemprop="url" rel="index"><span itemprop="name">Taro</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/Taro/%E8%BF%9B%E9%98%B6/" itemprop="url" rel="index"><span itemprop="name">进阶</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
          
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>33k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>30 分钟</span>
            </span>
          
            <div class="post-description">为了让我们的博客看起来更加专业，我们打算给它也加上整上一个专业的用户系统，有了最为核心的用户系统在，我们博客之后的扩展都可以游刃有余，但是据统计，一个应用要想打造一个比较专业的用户系统，至少需要花费几个月时间，还需要花大量的精力去维护打造出来的用户系统，所在在做了一番调研之后，我们将目标放在了一个叫做 Authing 的通用云身份平台，它提供的服务就是帮应用快速集成一个高效、安全的用户系统，而我们这篇教程将会讲解如何借助 Authing 来给我们的之前的小程序博客武装一个专业的用户系统。</div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
            <div class="post-gallery-row">
              <img src="https://static.powerformer.com/c/34a473b/taro-cover-9.jpg" itemprop="contentUrl">
            
          

          </div>
        </div>
        <div class="profileBox">
  <div class="avatarBox">
    <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXY=" title="https://github.com/tuture-dev"><img alt class="avatar" data-src="/images/avatars/tuture-dev.jpg"><i class="fa fa-external-link"></i></span>
  </div>
  <div class="rightBox">
    <div class="infoBox">
    <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXY=" title="https://github.com/tuture-dev"><p class="nickName">@tuture-dev</p><i class="fa fa-external-link"></i></span>
  </div>
  <div class="codeBox">
    <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yg==" title="https://github.com/tuture-dev/ultra-club"><span class="codeText">查看代码</span><i class="fa fa-external-link"></i></span>
  </div>
  </div>
</div><a id="more"></a>

<h2 id="准备新版登录逻辑"><a href="#准备新版登录逻辑" class="headerlink" title="准备新版登录逻辑"></a>准备新版登录逻辑</h2><p>之前我们的小程序具有了一个简单博客必备的一些功能：</p>
<ul>
<li>权限管理：发帖之前需要登录</li>
<li>登录：普通登录和微信登录等</li>
<li>发帖：帖子会自动带上用户信息</li>
<li>获取所有帖子和单个帖子</li>
</ul>
<p>乍一看这个博客有点小完整了，但是一路跟下来的同学应该知道，我们之前的登录都是通过传入用户的 <code>nickName</code> 和 <code>photo</code> 来登录的，但是我们一般在生活中看到的一些比较正规的网站或者小程序，它们的登录一般都有类似手机+验证码登录，并且在一个标准的博客里面，可能还会涉及到诸如用户权限管理，用户登录状态查询等，刚刚我提到的种种关于用户的场景一般会被抽象为一个应用里的一个核心模块 – 用户系统，即所有和用户注册/登录、信息更新、权限管理、鉴权等相关的内容。</p>
<p>为了让我们的博客看起来更加专业，我们打算给它也加上整上一个专业的用户系统，有了最为核心的用户系统在，我们博客之后的扩展都可以游刃有余，但是据统计，一个应用要想打造一个比较专业的用户系统，至少需要花费几个月时间，还需要花大量的精力去维护打造出来的用户系统，所在在做了一番调研之后，我们将目标放在了一个叫做 Authing 的通用云身份平台，它提供的服务就是帮应用快速集成一个高效、安全的用户系统，而我们这篇教程将会讲解如何借助 Authing 来给我们的之前的小程序博客武装一个专业的用户系统。</p>
<p>首先我们先来看一看完成的效果：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab2f4dfe98.gif"></p>
<p><img alt data-src="https://cdn.nlark.com/yuque/0/2020/gif/123790/1588231679722-a000569d-8acf-4e8c-be6d-e7288dadacb2.gif"></p>
<p>如果你希望直接从这篇开始，那么可以 Clone 我们为你准备的代码，然后跟着教程补充剩下的部分：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone -b authing-start https:&#x2F;&#x2F;github.com&#x2F;tuture-dev&#x2F;ultra-club.git</span><br><span class="line"></span><br><span class="line"># 或者下载 Gitee 上的仓库</span><br><span class="line">git clone -b authing-start https:&#x2F;&#x2F;gitee.com&#x2F;tuture&#x2F;ultra-club.git</span><br></pre></td></tr></table></figure>

<h3 id="改进普通登录"><a href="#改进普通登录" class="headerlink" title="改进普通登录"></a>改进普通登录</h3><p>首先我们来将之前普通登录的专业性提升一个档次，之前我们是让用户输入昵称和上传头像然后进行登录，现在我们打算切换到手机号+验证码的形式，立马现代化。</p>
<p>打开 <code>src/components/LoginForm/index.jsx</code> 文件，对其中的内容作出对应的修改如下：</p>
<figure class="highlight jsx"><figcaption><span>src/components/LoginForm/index.jsx</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzRhODVjZDAwNWQ4YmU2MTNkMDhjMThjMjVlYTE2MzM3MDNlMzBlYmEvc3JjL2NvbXBvbmVudHMvTG9naW5Gb3JtL2luZGV4LmpzeA==" title="https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/LoginForm/index.jsx">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-del]<span class="keyword">import</span> Taro, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Taro, &#123; useState, useRef, useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View, Form &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtButton, AtImagePicker &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line">[tuture-del]<span class="keyword">import</span> &#123; LOGIN &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> &#123; SET_IS_OPENED, SET_LOGIN_INFO &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> CountDownButton <span class="keyword">from</span> <span class="string">'../CountDownButton'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">LoginForm</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Login Form 登录数据</span></span><br><span class="line">[tuture-del]  <span class="keyword">const</span> [formNickName, setFormNickName] = useState(<span class="string">''</span>)</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> [files, setFiles] = useState([])</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> [showAddBtn, setShowAddBtn] = useState(<span class="literal">true</span>)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> [phone, setPhone] = useState(<span class="string">''</span>)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> [phoneCode, setPhoneCode] = useState(<span class="string">''</span>)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> countDownButtonRef = useRef(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">[tuture-del]  <span class="function"><span class="keyword">function</span> <span class="title">onChange</span>(<span class="params">files</span>) </span>&#123;</span><br><span class="line">[tuture-del]    <span class="keyword">if</span> (files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">[tuture-del]      setShowAddBtn(<span class="literal">false</span>)</span><br><span class="line">[tuture-del]    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-del]      setShowAddBtn(<span class="literal">true</span>)</span><br><span class="line">[tuture-add]  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">countDownButtonPressed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">[tuture-add]    <span class="keyword">if</span> (!phone) &#123;</span><br><span class="line">[tuture-add]      Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]        type: <span class="string">'error'</span>,</span><br><span class="line">[tuture-add]        message: <span class="string">'您还没有填写手机!'</span>,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[tuture-del]    setFiles(files)</span><br><span class="line">[tuture-del]  &#125;</span><br><span class="line">[tuture-add]    countDownButtonRef.current.startCountDown()</span><br><span class="line"></span><br><span class="line">[tuture-del]  <span class="function"><span class="keyword">function</span> <span class="title">onImageClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">[tuture-del]    Taro.previewImage(&#123;</span><br><span class="line">[tuture-del]      urls: [props.files[<span class="number">0</span>].url],</span><br><span class="line">[tuture-del]    &#125;)</span><br><span class="line">[tuture-add]    <span class="comment">// 处理发送验证码事件</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleSubmit</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.preventDefault()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鉴权数据</span></span><br><span class="line">[tuture-del]    <span class="keyword">if</span> (!formNickName || !files.length) &#123;</span><br><span class="line">[tuture-add]    <span class="keyword">if</span> (!phone || !phoneCode) &#123;</span><br><span class="line">      Taro.atMessage(&#123;</span><br><span class="line">        type: <span class="string">'error'</span>,</span><br><span class="line">        message: <span class="string">'您还有内容没有填写！'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[tuture-del]    setShowAddBtn(<span class="literal">true</span>)</span><br><span class="line">[tuture-del] </span><br><span class="line">[tuture-del]    <span class="comment">// 提示登录成功</span></span><br><span class="line">[tuture-del]    Taro.atMessage(&#123;</span><br><span class="line">[tuture-del]      type: <span class="string">'success'</span>,</span><br><span class="line">[tuture-del]      message: <span class="string">'恭喜您，登录成功！'</span>,</span><br><span class="line">[tuture-del]    &#125;)</span><br><span class="line">[tuture-del] </span><br><span class="line">[tuture-del]    <span class="comment">// 缓存在 storage 里面</span></span><br><span class="line">[tuture-del]    <span class="keyword">const</span> userInfo = &#123; <span class="attr">avatar</span>: files[<span class="number">0</span>].url, <span class="attr">nickName</span>: formNickName &#125;</span><br><span class="line">[tuture-del] </span><br><span class="line">[tuture-del]    <span class="comment">// 清空表单状态</span></span><br><span class="line">[tuture-del]    setFiles([])</span><br><span class="line">[tuture-del]    setFormNickName(<span class="string">''</span>)</span><br><span class="line">[tuture-del] </span><br><span class="line">[tuture-del]    <span class="comment">// 向后端发起登录请求</span></span><br><span class="line">[tuture-del]    dispatch(&#123; <span class="attr">type</span>: LOGIN, <span class="attr">payload</span>: &#123; <span class="attr">userInfo</span>: userInfo &#125; &#125;)</span><br><span class="line">[tuture-add]    <span class="comment">// 处理登录和注册</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"post-form"</span>&gt;</span><br><span class="line">      &lt;Form onSubmit=&#123;handleSubmit&#125;&gt;</span><br><span class="line">        &lt;View className=<span class="string">"login-box"</span>&gt;</span><br><span class="line">[tuture-del]          &lt;View className=<span class="string">"avatar-selector"</span>&gt;</span><br><span class="line">[tuture-del]            &lt;AtImagePicker</span><br><span class="line">[tuture-del]              length=&#123;<span class="number">1</span>&#125;</span><br><span class="line">[tuture-del]              mode=<span class="string">"scaleToFill"</span></span><br><span class="line">[tuture-del]              count=&#123;<span class="number">1</span>&#125;</span><br><span class="line">[tuture-del]              files=&#123;files&#125;</span><br><span class="line">[tuture-del]              showAddBtn=&#123;showAddBtn&#125;</span><br><span class="line">[tuture-del]              onImageClick=&#123;onImageClick&#125;</span><br><span class="line">[tuture-del]              onChange=&#123;onChange&#125;</span><br><span class="line">[tuture-del]            /&gt;</span><br><span class="line">[tuture-del]          &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Input</span></span><br><span class="line"><span class="regexp">[tuture-del]            className="input-nickName"</span></span><br><span class="line"><span class="regexp">[tuture-add]            className="input-phone input-item"</span></span><br><span class="line"><span class="regexp">            type="text"</span></span><br><span class="line"><span class="regexp">[tuture-del]            placeholder="点击输入昵称"</span></span><br><span class="line"><span class="regexp">[tuture-del]            value=&#123;formNickName&#125;</span></span><br><span class="line"><span class="regexp">[tuture-del]            onInput=&#123;e =&gt; setFormNickName(e.target.value)&#125;</span></span><br><span class="line"><span class="regexp">[tuture-add]            placeholder="输入手机号"</span></span><br><span class="line"><span class="regexp">[tuture-add]            value=&#123;phone&#125;</span></span><br><span class="line"><span class="regexp">[tuture-add]            onInput=&#123;e =&gt; setPhone(e.target.value)&#125;</span></span><br><span class="line"><span class="regexp">          /</span>&gt;</span><br><span class="line">[tuture-add]          &lt;View className=<span class="string">"verify-code-box"</span>&gt;</span><br><span class="line">[tuture-add]            &lt;Input</span><br><span class="line">[tuture-add]              className=<span class="string">"input-nickName input-item"</span></span><br><span class="line">[tuture-add]              type=<span class="string">"text"</span></span><br><span class="line">[tuture-add]              placeholder=<span class="string">"四位验证码"</span></span><br><span class="line">[tuture-add]              value=&#123;phoneCode&#125;</span><br><span class="line">[tuture-add]              onInput=&#123;e =&gt; setPhoneCode(e.target.value)&#125;</span><br><span class="line">[tuture-add]            /&gt;</span><br><span class="line">[tuture-add]            &lt;CountDownButton</span><br><span class="line">[tuture-add]              onClick=&#123;countDownButtonPressed&#125;</span><br><span class="line">[tuture-add]              ref=&#123;countDownButtonRef&#125;</span><br><span class="line">[tuture-add]            /&gt;</span><br><span class="line">[tuture-add]          &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">          &lt;AtButton formType="submit" type="primary"&gt;</span></span><br><span class="line"><span class="regexp">            登录</span></span><br><span class="line"><span class="regexp">          &lt;/</span>AtButton&gt;</span><br><span class="line">[tuture-add]          &lt;View className=<span class="string">"at-article__info"</span>&gt;</span><br><span class="line">[tuture-add]            通过手机和验证码来登录，如果没有账号，我们将自动创建</span><br><span class="line">[tuture-add]          &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>View&gt;</span><br><span class="line">      &lt;<span class="regexp">/Form&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>View&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上面的代码主要有如下几处更改：</p>
<ul>
<li>删除了处理 <code>avatar</code> 和 <code>nickName</code> 的 <code>useState</code> 逻辑</li>
<li>删除了之前用于处理上传头像的 <code>onImageClick</code> 和 <code>onChange</code> 函数，以及 <code>AtImagePicker</code> 组件</li>
<li>改进和增加了两个输入框，一个用于输入手机号，一个用于输入验证码，同是增加了 <code>phone</code> 和 <code>phoneCode</code> 的 <code>useState</code> 逻辑</li>
<li>改进 <code>handleSubmit</code> ，删除了原处理 <code>nickName</code> 和 <code>files</code> 的逻辑，以及删除了之前发起登录的 <code>dispatch</code> 逻辑</li>
<li>接着我们增加了一个用于倒计时的 <code>CountDownButton</code> 组件，以及获取 <code>ref</code> 的 <code>countDownButtonRef</code> 和处理按钮点击事件的 <code>countDownButtonPressed</code> 函数，在函数里面我们会做数据验证，如果用户填写了手机号，才允许执行倒计时逻辑，在接下来我们将在这个函数里面处理手机验证码发送逻辑。</li>
<li>最后我们添加了提示用户使用手机和验证码登录的文案。</li>
</ul>
<div class="note info">
            <p><strong>提示</strong></p><p>这里的 CountDownButton 是 Taro 官方物料市场提供的物料，可以访问 <a href>这个地址</a>，下载物料，然后将 CountDownButton 的文件夹放到 <code>src/compontents</code> 文件夹下面。我们还需要对这个组件的样式做一点修改，以适应我们现在的 UI 风格，我们将马上来讲解如何修改，读者先可以下载这个物料，然后放置到刚刚提到的项目目录下。</p>
          </div>

<h3 id="样式改进"><a href="#样式改进" class="headerlink" title="样式改进"></a>样式改进</h3><p>上面我们改进了组件，为了让我们的新版登录样子看起来更加专业、统一，我们加点样式，打开 <code>src/components/LoginForm/index.scss</code> 文件，对其中的内容作出对应的修改如下：</p>
<figure class="highlight scss"><figcaption><span>src/components/LoginForm/index.scss</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzRhODVjZDAwNWQ4YmU2MTNkMDhjMThjMjVlYTE2MzM3MDNlMzBlYmEvc3JjL2NvbXBvbmVudHMvTG9naW5Gb3JtL2luZGV4LnNjc3M=" title="https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/LoginForm/index.scss">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post-form</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">30px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[tuture-del]</span><span class="selector-class">.input-nickName</span> &#123;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span><span class="selector-class">.input-item</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: medium;</span><br><span class="line"><span class="selector-attr">[tuture-del]</span>  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">40px</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">40px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[tuture-add]</span><span class="selector-class">.input-phone</span> &#123;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>&#125;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span> </span><br><span class="line"><span class="selector-attr">[tuture-add]</span><span class="selector-class">.input-nickName</span> &#123;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">width</span>: calc(<span class="number">100%</span> - <span class="number">200px</span>);</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>&#125;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span> </span><br><span class="line"><span class="selector-attr">[tuture-add]</span><span class="selector-class">.verify-code-box</span> &#123;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">display</span>: flex;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">flex-direction</span>: row;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">align-items</span>: center;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>  <span class="attribute">justify-content</span>: space-between;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span>&#125;</span><br><span class="line"><span class="selector-attr">[tuture-add]</span> </span><br><span class="line"><span class="selector-class">.avatar-selector</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Taro-物料"><a href="#使用-Taro-物料" class="headerlink" title="使用 Taro 物料"></a>使用 Taro 物料</h3><p>我们上面用到的 <code>CountDownButton</code> 组件，就是 Taro 物料市场的一个物料, 简单的说物料就是一个能某方面功能完善的包或组件,帮助开发者快速完成某个逻辑而不需要重复造轮子,正如 Taro 物料市场官方的标语：</p>
<blockquote>
<p>让每一个让每一个轮子产生价值</p>
</blockquote>
<p>我们通过之前的步骤，应该已经下载好了物料，并放在了 <code>src/components</code> 文件夹下面了，可以看到组件中主要就是两个文件，一个逻辑文件 <code>src/components/CountDownButton/index.js</code> ，还有一个样式文件 <code>src/components/CountDownButton/index.css</code>是，这里我们要做个小修改就是逻辑文件里面引用的是 <code>index.scss</code> 文件，我们需要一下这个样式文件的后缀为 <code>index.scss</code> 。</p>
<p>接着为了和我们的现有的 UI 统一，我们还改了 <code>src/components/CountDownButton/index.scss</code>文件的 <code>activeButtonStyle</code> 和 <code>buttonCommonStyle</code> 样式，最后的文件内容如下：</p>
<figure class="highlight scss"><figcaption><span>src/components/CountDownButton/index.scss</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzRhODVjZDAwNWQ4YmU2MTNkMDhjMThjMjVlYTE2MzM3MDNlMzBlYmEvc3JjL2NvbXBvbmVudHMvQ291bnREb3duQnV0dG9uL2luZGV4LnNjc3M=" title="https://github.com/tuture-dev/ultra-club/blob/4a85cd005d8be613d08c18c25ea1633703e30eba/src/components/CountDownButton/index.scss">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 按钮默认展现样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.buttonCommonStyle</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">160px</span>;</span><br><span class="line">  <span class="attribute">height</span>: calc(<span class="number">1.4rem</span> + <span class="number">20px</span>);</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">outline</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 禁用时候的TouchableOpacity样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.disableButtonStyle</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f6f6f6</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 可以点击时候的TouchableOpacity样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.activeButtonStyle</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#02b875</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 文本默认样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.txtCommonStyle</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 禁用时Text样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.disableTxtStyle</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 可以点击时候的Text样式 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.activeTxtStyle</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大功告成！🥳，我们成功的完成了新版普通登录的界面，当你保存代码，并在根目录下通过 <code>npm run dev:weapp</code> 开启微信小程序，并使用开发者工具打开我们的项目时，它的效果应该类型下面这样：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab2f71d1d2.png"></p>
<p>怎么样，是不是和你之前体验的各种专业 App 或者网站、小程序的登录注册界面和逻辑类似了呢？😆，有了这样一个专业的登录界面之后，我们接下来将要把它整个从前端到后端的逻辑跑通，下一步我们将跑通这个登录和注册逻辑。</p>
<div class="note info">
            <p><strong>提示</strong></p><p>这里我们将登录和注册页面整合在了一起，通过在登录按钮下方的小文字提示，如果用户没有账号，那么通过手机号和验证码登录之后，我们会为用户直接注册一个账号，而简化界面逻辑的背后通常需要在代码逻辑上做出大量的改进、优化等，然而我们在下一步即将接入的通用的身份云平台 – Authing 则将这一逻辑简化到了几行代码。</p>
          </div>

<h2 id="使用-Authing-接入完整的用户系统"><a href="#使用-Authing-接入完整的用户系统" class="headerlink" title="使用 Authing 接入完整的用户系统"></a>使用 Authing 接入完整的用户系统</h2><p>在文章开头和上一小结末尾买了那么多关子，说 Authing 如何简化我们的开发成本，有些读者估计都有点急不可耐了，这个 Authing 有这么方便嘛？，我们这一节就来开始深入使用它。</p>
<p>为了将 Authing 接入我们的博客小程序，我们需要做以下几点准备：</p>
<ul>
<li>注册 Authing 账号并创建一个 “小程序” 类型的用户池</li>
<li>通过官方文档，找到小程序 SDK，并下载对于的文件放置到项目目录下</li>
<li>在项目代码中导入 Authing 小程序 SDK，并开始使用</li>
</ul>
<h3 id="注册-Authing-账号"><a href="#注册-Authing-账号" class="headerlink" title="注册 Authing 账号"></a>注册 Authing 账号</h3><p>打开<span class="exturl" data-url="aHR0cHM6Ly9hdXRoaW5nLmNuLz91dG1fc291cmNlPXR1dHVyZQ==" title="https://authing.cn/?utm_source=tuture"> Authing 官网<i class="fa fa-external-link"></i></span>，我们会看到如下界面：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab2faef61e.png"></p>
<p>我们点击右上角的登录，可以看到，它会弹出如下界面：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab31cb9682.png"></p>
<p>我们这时候可以慢下脚步，好好看一下提供通用身份云平台的公司，他们的登录界面是怎么样的呢？可以看到，我们熟悉的微信登录、邮箱+密码登录、手机号+验证码登录、还有技术开发者常用的 Github 登录，甚至还有一个比较特殊的小程序扫码登录，基本将互联网上我们可能用到的最高效率的用户登录、注册功能逻辑都集成进了一个小小的表单里面。</p>
<p>读者可以自行选择自己喜欢的登录方式😋，这里图雀酱选择了微信登录，然后在弹出的扫码界面，使用微信扫码二维码登录。登录之后，会弹出一个界面让你绑定手机号，读者这里可以自行选择是否绑定。当完成了这一步操作之后，界面会导航带你来到一个创建应用的界面，我们选择小程序，然后点击下一步：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab328a8600.png"></p>
<p>接着，会问你的应用是干什么的，我们填入：“图雀社区博客小程序”（读者这里可以自行脑补），然后我们点击下一步：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab6a4f7cf8.png"></p>
<p>接着会让你设置一个二级域名，我们输入 tuture-blog-miniprogram，然后我们点击完成：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab5e1312d8.png"></p>
<p>接下来我们回来到一个快速体验 Authing 功能的界面，系统为你默认创建了一个账号：</p>
<ul>
<li>账号：<code>test@test.com</code> </li>
<li>密码：<code>123456a!</code> </li>
</ul>
<p>你可以在右边的界面里面体验是否可以登录，当然你也可以注册一个用户，注册的用户稍后我们可以在控制台我们创建的 “图雀社区博客小程序” 用户池里面看到这个注册的用户：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab6fdfbb33.png"></p>
<p>并且上面的界面还讲解了如何快速集成  Authing 的登录功能和检查登录状态，并给出了 JS 实现代码，以及左下角的 Guard ，这个 Guard 简单来说就是一个集合了我们之前看到的 Authing 那个注册、登录表单的功能，并且提供一个专业的界面给你，使得你可以几行代码就实现一个类似 Authing 官方注册登录的那个样子。也就是我们刚刚看到的这个界面：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab31cb9682.png"></p>
<div class="note info">
            <p><strong>提示</strong></p><p>我们在图雀社区的全栈电商系列文章的番外篇里面集成用户系统有讲到如何使用，感兴趣的读者可以阅读此篇文章。</p>
          </div>

<p>好的，我们点击左下角的 “知道了，进入控制台”，开始进入我们的 Authing 用户池管理控制台，在此之前还会让你填写一个回调地址，这个我们暂时用不到，你可以跳过，或者可以随便填写一个，比如 <code>http://localhost:3000</code>。</p>
<p>最后，我们来到了这样一个界面：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab67e5569b.png"></p>
<p>可以看到这个界面左侧就是我们之前一直提到的 “用户池” 管理界面，默认选中了我们刚刚创建的 “图雀社区博客小程序”，一个用户池就是一整套用户以及和用户登录、注册、鉴权、登录状态、活跃、权限等有关的逻辑。</p>
<p>中间就是单个用户池里面的一些介绍，比如我们现在看到的是一个类似 Github 那个热力图一样的用户登录热力图，你可以方便的看到那天有多少次用户登录，往下滑可以看到更多用户数据分析方面的图表和内容。</p>
<h3 id="下载和配置-SDK"><a href="#下载和配置-SDK" class="headerlink" title="下载和配置 SDK"></a>下载和配置 SDK</h3><p>注册完账号、建立了用户池，我们需要下载 Authing 为我们提供的微信小程序 SDK 来集成用户系统，点击<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF1dGhpbmcuY24vYXV0aGluZy9zZGsvYXV0aGluZy1zZGstZm9yLXd4YXBwP3V0bV9zb3VyY2U9dHV0dXJl" title="https://docs.authing.cn/authing/sdk/authing-sdk-for-wxapp?utm_source=tuture">这个链接<i class="fa fa-external-link"></i></span>去往小程序开发文档。</p>
<p>根据文档，我们需要在微信小程序后台配置两个域名白名单：</p>
<ul>
<li><code>https://oauth.authing.cn</code> 和 <code>https://users.authing.cn</code> </li>
</ul>
<p>然后将微信小程序的 <code>AppId</code> 和 <code>AppSecret</code> 填入 Authing 对应的地址：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab696b133d.png"></p>
<p>这个界面，然后滑动到底部，选择小程序内登陆：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab9666de85.png"></p>
<p>在弹出的框里面填入对应的微信小程序的 <code>AppId</code> 和 <code>AppSecret</code> ：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab9903fdd9.png"></p>
<p>配置好之后，我们接下来可以将 SDK 代码下载，并放进我们的项目里，找一个地方（非现有项目中），运行如下脚本，Clone 小程序 SDK：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Authing/authing-wxapp-sdk</span><br></pre></td></tr></table></figure>

<p>然后打开此项目，将其中的 <code>authing</code> 文件夹拷贝进我们 <code>ultra-club</code> 小程序的 <code>src/utils</code> 目录下，最后的目录结构看起来应该是这样：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">src</span><br><span class="line">├── store</span><br><span class="line">│   └── index.js</span><br><span class="line">└── utils</span><br><span class="line">    └── authing</span><br><span class="line">        ├── authing.js</span><br><span class="line">        ├── configs.js</span><br><span class="line">        ├── graphql</span><br><span class="line">        │   └── wxgql.js</span><br><span class="line">        └── utils</span><br><span class="line">            ├── qiniuUploader.js</span><br><span class="line">            ├── util.js</span><br><span class="line">            └── wxapp_rsa.min.js</span><br></pre></td></tr></table></figure>

<p>SDK 开发环境准备就绪✌️，我们接下来马上来集成手机号+验证码登录的身份逻辑！</p>
<h3 id="开始集成"><a href="#开始集成" class="headerlink" title="开始集成"></a>开始集成</h3><p>打开 <code>src/components/LoginForm/index.jsx</code> 文件，对其中的内容作出对应的修改如下：</p>
<figure class="highlight jsx"><figcaption><span>src/components/LoginForm/index.jsx</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2RmZWE4MmIwYjZlMTFkMWE1NzVkOTllOTUzMzdmNzJjOGE0ZWI2Zjkvc3JjL2NvbXBvbmVudHMvTG9naW5Gb3JtL2luZGV4LmpzeA==" title="https://github.com/tuture-dev/ultra-club/blob/dfea82b0b6e11d1a575d99e95337f72c8a4eb6f9/src/components/LoginForm/index.jsx">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro, &#123; useState, useRef, useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View, Form &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtButton, AtImagePicker &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; SET_IS_OPENED, SET_LOGIN_INFO &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line"><span class="keyword">import</span> CountDownButton <span class="keyword">from</span> <span class="string">'../CountDownButton'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Authing <span class="keyword">from</span> <span class="string">'../../utils/authing/authing'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">LoginForm</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Login Form 登录数据</span></span><br><span class="line">  <span class="keyword">const</span> [phone, setPhone] = useState(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> [phoneCode, setPhoneCode] = useState(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> countDownButtonRef = useRef(<span class="literal">null</span>)</span><br><span class="line">[tuture-add]  <span class="keyword">let</span> userPoolId = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">countDownButtonPressed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!phone) &#123;</span><br><span class="line">      Taro.atMessage(&#123;</span><br><span class="line">        type: <span class="string">'error'</span>,</span><br><span class="line">        message: <span class="string">'您还没有填写手机!'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    countDownButtonRef.current.startCountDown()</span><br><span class="line"></span><br><span class="line">[tuture-del]    <span class="comment">// 处理发送验证码事件</span></span><br><span class="line">[tuture-add]    <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-add]      <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]        userPoolId,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add]      <span class="keyword">const</span> res = <span class="keyword">await</span> authing.getVerificationCode(phone)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (res.code === <span class="number">200</span>) &#123;</span><br><span class="line">[tuture-add]        Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]          type: <span class="string">'success'</span>,</span><br><span class="line">[tuture-add]          message: <span class="string">'手机验证码已经发送成功，注意查收'</span>,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">[tuture-add]      Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]        type: <span class="string">'error'</span>,</span><br><span class="line">[tuture-add]        message: <span class="string">'验证码发送失败，请稍后尝试 !'</span>,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add]      <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleSubmit</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.preventDefault()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鉴权数据</span></span><br><span class="line">    <span class="keyword">if</span> (!phone || !phoneCode) &#123;</span><br><span class="line">      Taro.atMessage(&#123;</span><br><span class="line">        type: <span class="string">'error'</span>,</span><br><span class="line">        message: <span class="string">'您还有内容没有填写！'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[tuture-del]    <span class="comment">// 处理登录和注册</span></span><br><span class="line">[tuture-add]    <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-add]      <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]        userPoolId,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">const</span> userInfo = <span class="keyword">await</span> authing.loginByPhoneCode(&#123;</span><br><span class="line">[tuture-add]        phone,</span><br><span class="line">[tuture-add]        phoneCode,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="comment">// 提示登录成功</span></span><br><span class="line">[tuture-add]      Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]        type: <span class="string">'success'</span>,</span><br><span class="line">[tuture-add]        message: <span class="string">'恭喜您，登录成功！'</span>,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">const</span> &#123; nickname, photo, _id &#125; = userInfo</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="comment">// 向后端发起登录请求</span></span><br><span class="line">[tuture-add]      <span class="keyword">await</span> Taro.setStorage(&#123;</span><br><span class="line">[tuture-add]        key: <span class="string">'userInfo'</span>,</span><br><span class="line">[tuture-add]        data: &#123;</span><br><span class="line">[tuture-add]          nickName: nickname,</span><br><span class="line">[tuture-add]          avatar: photo,</span><br><span class="line">[tuture-add]          _id,</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">await</span> Taro.setStorage(&#123;</span><br><span class="line">[tuture-add]        key: <span class="string">'token'</span>,</span><br><span class="line">[tuture-add]        data: userInfo.token,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      dispatch(&#123;</span><br><span class="line">[tuture-add]        type: SET_LOGIN_INFO,</span><br><span class="line">[tuture-add]        payload: &#123; <span class="attr">nickName</span>: nickname, <span class="attr">avatar</span>: photo, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      dispatch(&#123; <span class="attr">type</span>: SET_IS_OPENED, <span class="attr">payload</span>: &#123; <span class="attr">isOpened</span>: <span class="literal">false</span> &#125; &#125;)</span><br><span class="line">[tuture-add]    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">[tuture-add]      Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]        type: <span class="string">'error'</span>,</span><br><span class="line">[tuture-add]        message: <span class="string">'登录失败'</span>,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"post-form"</span>&gt;</span><br><span class="line">      &lt;Form onSubmit=&#123;handleSubmit&#125;&gt;</span><br><span class="line">        &lt;View className=<span class="string">"login-box"</span>&gt;</span><br><span class="line">          &lt;Input</span><br><span class="line">            className=<span class="string">"input-phone input-item"</span></span><br><span class="line">            type=<span class="string">"text"</span></span><br><span class="line">            placeholder=<span class="string">"输入手机号"</span></span><br><span class="line">            value=&#123;phone&#125;</span><br><span class="line">            onInput=&#123;e =&gt; setPhone(e.target.value)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">          &lt;View className=<span class="string">"verify-code-box"</span>&gt;</span><br><span class="line">            &lt;Input</span><br><span class="line">              className=<span class="string">"input-nickName input-item"</span></span><br><span class="line">              type=<span class="string">"text"</span></span><br><span class="line">              placeholder=<span class="string">"四位验证码"</span></span><br><span class="line">              value=&#123;phoneCode&#125;</span><br><span class="line">              onInput=&#123;e =&gt; setPhoneCode(e.target.value)&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;CountDownButton</span><br><span class="line">              onClick=&#123;countDownButtonPressed&#125;</span><br><span class="line">              ref=&#123;countDownButtonRef&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">          &lt;AtButton formType="submit" type="primary"&gt;</span></span><br><span class="line"><span class="regexp">            登录</span></span><br><span class="line"><span class="regexp">          &lt;/</span>AtButton&gt;</span><br><span class="line">          &lt;View className=<span class="string">"at-article__info"</span>&gt;</span><br><span class="line">            通过手机和验证码来登录，如果没有账号，我们将自动创建</span><br><span class="line">          &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>View&gt;</span><br><span class="line">      &lt;<span class="regexp">/Form&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>View&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上面的内容主要有如下几处修改：</p>
<ul>
<li>我们首先引入了上一步里面下载的 Authing  SDK</li>
<li>接着我们定义了一个 <code>userPoolId</code> ，这就是我们前面创建 “图雀社区博客小程序” 用户池的标志 ID，这里读者需要前往 Authing 控制台界面，获取用户池 ID，并替换上面的空字符串：</li>
</ul>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281ab9d8b1772.png"></p>
<ul>
<li>接着我们在 <code>countDownButtonPressed</code> 函数内进行发起手机验证码操作，我们首先使用 <code>new Authing</code> 传入用户池 ID <code>userPoolId</code> 初始化一个一个实例并命名为 <code>authing</code> ，这一步代表我们拿到了此页用户池的操作权，接下来我们就可以进行用户有关的操作了。</li>
<li>接着我们使用 <code>authing.getVerificationCode</code> 方法，传入填写的手机号 <code>phone</code> ，它是一个异步 Promise 对象，所以我们用 <code>await</code> 关键字获取其结果，当结果 <code>res.code</code> 为 200，代表发送验证码成功，我们提示用户发送验证码成功，否则提醒发送验证码失败，当编写了上面的代码并保存之后，我们可以打开小程序尝试一下效果，输入手机号，并点击发送验证码：</li>
</ul>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281aba373023a.gif"></p>
<p>当然上面的手机号我瞎输入的，读者请自行输入自己的手机号尝试，接着应该可以在手机上收到验证码短信：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281aba386117a.jpeg"></p>
<p>Boom💥！可以看到简单几行代码，我们就搞定了手机验证码的发送。</p>
<ul>
<li>接下来我们需要完善一下使用手机+验证码登录的逻辑，我们在 <code>handleSubmit</code> 里面编写了一个 <code>try/catch</code> 语句，然后初始化 Authing 对象，并调用方法 <code>authing.loginByPhoneCode</code> 传入我们的手机号（<code>phone</code> ）和验证码 <code>phoneCode</code> ，进行调用之后，我们就完成了手机号+验证码登录，这个方法默认会对未登录用户进行创建账号操作，不需要用户额外处理其他逻辑。</li>
<li>接着，我们通过登录成功返回的 <code>userInfo</code> 拿到内容，做出修改并设置到 <code>storage</code> 里，以及存在  Redux Store 里面，并提示用户登录成功。当然如果登录失败，我们还会提示用户登录失败。</li>
</ul>
<div class="note info">
            <p><strong>提示</strong></p><ol><li>这里我们做了数据格式的适应，如将 Authing 登录返回的用户信息 <code>userInfo.nickname</code> 适应成 <code>nickName</code> ，是为了匹配之前的小程序系统的数据格式。</li><li>可以看到我们额外存了一个 <code>userInfo.token</code> 到 <code>storage</code> 里面，这个 <code>token</code> 就是我们用户系统里面用于用户鉴权的标志，之后我们将用这个 token 来检查用户的登录状态并进行用户登录态的保持。</li></ol>
          </div>

<p>一切准备就绪，接下来我们填入手机号，点击获取验证码，并将验证码填入小程序的输入框，点击登录应该就可以登录成功：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281abae530ec7.png"></p>
<p>可以看到，我们收获了一个默认的 “酷酷的头像”，并且提示了登录成功。大功告成，一个专业的只需要手机号+验证码的登录界面+逻辑我们就完整实现了，可以看到我们主要在界面的调整和 SDK的引入上废了一点功夫，实际上实现整个逻辑，真的只需要几行代码！因为 Authing 在背后做了大量的工作来确保上层逻辑的简单。</p>
<h2 id="处理登出逻辑"><a href="#处理登出逻辑" class="headerlink" title="处理登出逻辑"></a>处理登出逻辑</h2><p>在上一小节中，我们成功将登录逻辑迁移到了手机号+验证码的方式，并且通过简单几行代码实现了验证码的发送，以及登录。</p>
<p>因为我们的登录逻辑相比之前有了一些变化，所以我们要适当的调整我们的登出逻辑，以适应这些变化。</p>
<h3 id="改进登出组件"><a href="#改进登出组件" class="headerlink" title="改进登出组件"></a>改进登出组件</h3><p>打开 <code>src/components/Logout/index.js</code> 文件，对其中的内容做出对应的修改：</p>
<figure class="highlight js"><figcaption><span>src/components/Logout/index.js</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2EyMzcyNmE2YjI4ZGM3ODMzMGM3OTQ1NjNlZTQ5Yjc5ODAzMDMyNjYvc3JjL2NvbXBvbmVudHMvTG9nb3V0L2luZGV4Lmpz" title="https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Logout/index.js">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtButton &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line">[tuture-del]<span class="keyword">import</span> &#123; useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> &#123; useDispatch, useSelector &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; SET_LOGIN_INFO &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Authing <span class="keyword">from</span> <span class="string">'../../utils/authing/authing'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">LoginButton</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isLogout, setIsLogout] = useState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleLogout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setIsLogout(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> Taro.removeStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line">[tuture-add]      <span class="keyword">await</span> Taro.removeStorage(&#123; <span class="attr">key</span>: <span class="string">'token'</span> &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">const</span> userPoolId = <span class="string">''</span></span><br><span class="line">[tuture-add]      <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]        userPoolId,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]      <span class="keyword">await</span> authing.logout(userId)</span><br><span class="line"></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: SET_LOGIN_INFO,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          avatar: <span class="string">''</span>,</span><br><span class="line">          nickName: <span class="string">''</span>,</span><br><span class="line">          userId: <span class="string">''</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'removeStorage ERR: '</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setIsLogout(<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;AtButton type=<span class="string">"secondary"</span> full loading=&#123;isLogout&#125; onClick=&#123;handleLogout&#125;&gt;</span><br><span class="line">      退出登录</span><br><span class="line">    &lt;<span class="regexp">/AtButton&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，上面的内容主要有如下几处修改：</p>
<ul>
<li>我们在 <code>handleLogout</code> 函数里处理登出逻辑的时候，首先初始化了一个 <code>authing</code> 实例，主要这里的 <code>userPoolId</code> 也需要读者替换成你自己的，可以在 Authing 控制台获取，接着调用 <code>authing.logout</code> 传入用户的 <code>userId</code> 来登出此用户，这样之后就不能操作 Authing 上创建的用户池了</li>
<li>关于 <code>userId</code> 的获取，我们使用了 <code>react-redux</code> 钩子 <code>useSelector</code> 从 Redux Store 里面获取。</li>
<li>最后我们还要删除 <code>storage</code> 里面存储的 <code>token</code> 。</li>
</ul>
<h3 id="清理其他登出逻辑"><a href="#清理其他登出逻辑" class="headerlink" title="清理其他登出逻辑"></a>清理其他登出逻辑</h3><p>因为目前我们的登陆不是之前的使用 <code>nickName</code> 和 <code>avatar</code> ，而是使用手机号+验证码，所以我们一登录之后默认的 <code>nickName</code> 为空，而我们之前的判断用户是否登录的组件逻辑都是判断 <code>nickName</code> 是否存在，这里就有问题了，所以我们需要修改一下。</p>
<p>打开 <code>src/components/Footer/index.js</code> 文件，对其中的内容作出对应的修改如下：</p>
<figure class="highlight js"><figcaption><span>src/components/Footer/index.js</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2EyMzcyNmE2YjI4ZGM3ODMzMGM3OTQ1NjNlZTQ5Yjc5ODAzMDMyNjYvc3JjL2NvbXBvbmVudHMvRm9vdGVyL2luZGV4Lmpz" title="https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Footer/index.js">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtFloatLayout &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Logout <span class="keyword">from</span> <span class="string">'../Logout'</span></span><br><span class="line"><span class="keyword">import</span> LoginForm <span class="keyword">from</span> <span class="string">'../LoginForm'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"><span class="keyword">import</span> &#123; SET_IS_OPENED &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> nickName = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.nickName)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 双取反来构造字符串对应的布尔值，用于标志此时是否用户已经登录</span></span><br><span class="line">[tuture-del]  <span class="keyword">const</span> isLogged = !!nickName</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> isLogged = !!userId</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 useSelector Hooks 获取 Redux Store 数据</span></span><br><span class="line">  <span class="keyword">const</span> isOpened = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.isOpened)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"mine-footer"</span>&gt;</span><br><span class="line">      &#123;isLogged &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">Logout</span> /&gt;</span></span>&#125;</span><br><span class="line">      &lt;View className=<span class="string">"tuture-motto"</span>&gt;</span><br><span class="line">        &#123;isLogged ? <span class="string">'From 图雀社区 with Love ❤'</span> : <span class="string">'您还未登录'</span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">      &lt;AtFloatLayout</span></span><br><span class="line"><span class="regexp">        isOpened=&#123;isOpened&#125;</span></span><br><span class="line"><span class="regexp">        title="登录"</span></span><br><span class="line"><span class="regexp">        onClose=&#123;() =&gt;</span></span><br><span class="line"><span class="regexp">          dispatch(&#123; type: SET_IS_OPENED, payload: &#123; isOpened: false &#125; &#125;)</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        &lt;LoginForm /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/AtFloatLayout&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>View&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上面的内容主要就是将 <code>nickName</code> 替换成了 <code>userId</code> ，并用 <code>userId</code> 判断是否处于登录状态。</p>
<p>同样的，<code>src/components/Header/index.js</code> 也要作出类似的修改：</p>
<figure class="highlight js"><figcaption><span>src/components/Header/index.js</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2EyMzcyNmE2YjI4ZGM3ODMzMGM3OTQ1NjNlZTQ5Yjc5ODAzMDMyNjYvc3JjL2NvbXBvbmVudHMvSGVhZGVyL2luZGV4Lmpz" title="https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/components/Header/index.js">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtMessage &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> LoggedMine <span class="keyword">from</span> <span class="string">'../LoggedMine'</span></span><br><span class="line"><span class="keyword">import</span> LoginButton <span class="keyword">from</span> <span class="string">'../LoginButton'</span></span><br><span class="line"><span class="keyword">import</span> WeappLoginButton <span class="keyword">from</span> <span class="string">'../WeappLoginButton'</span></span><br><span class="line"><span class="keyword">import</span> AlipayLoginButton <span class="keyword">from</span> <span class="string">'../AlipayLoginButton'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> nickName = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.nickName)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 双取反来构造字符串对应的布尔值，用于标志此时是否用户已经登录</span></span><br><span class="line">[tuture-del]  <span class="keyword">const</span> isLogged = !!nickName</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> isLogged = !!userId</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isWeapp = Taro.getEnv() === Taro.ENV_TYPE.WEAPP</span><br><span class="line">  <span class="keyword">const</span> isAlipay = Taro.getEnv() === Taro.ENV_TYPE.ALIPAY</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"user-box"</span>&gt;</span><br><span class="line">      &lt;AtMessage /&gt;</span><br><span class="line">      &lt;LoggedMine /&gt;</span><br><span class="line">      &#123;!isLogged &amp;&amp; (</span><br><span class="line">        &lt;View className=<span class="string">"login-button-box"</span>&gt;</span><br><span class="line">          &lt;LoginButton /&gt;</span><br><span class="line">          &#123;isWeapp &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">WeappLoginButton</span> /&gt;</span></span>&#125;</span><br><span class="line">          &#123;isAlipay &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">AlipayLoginButton</span> /&gt;</span></span>&#125;</span><br><span class="line">        &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">      )&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>View&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有我们的 “我的” 页面，<code>src/pages/mine/mine.jsx</code> 文件：</p>
<figure class="highlight jsx"><figcaption><span>src/pages/mine/mine.jsx</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2EyMzcyNmE2YjI4ZGM3ODMzMGM3OTQ1NjNlZTQ5Yjc5ODAzMDMyNjYvc3JjL3BhZ2VzL21pbmUvbWluZS5qc3g=" title="https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/pages/mine/mine.jsx">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDispatch, useSelector &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Header, Footer &#125; <span class="keyword">from</span> <span class="string">'../../components'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./mine.scss'</span></span><br><span class="line"><span class="keyword">import</span> &#123; SET_LOGIN_INFO &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Mine</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> nickName = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.nickName)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">[tuture-del]  <span class="keyword">const</span> isLogged = !!nickName</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> isLogged = !!userId</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStorage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> Taro.getStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; nickName, avatar, _id &#125; = data</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type: SET_LOGIN_INFO,</span><br><span class="line">          payload: &#123; nickName, avatar, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getStorage ERR: '</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isLogged) &#123;</span><br><span class="line">      getStorage()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"mine"</span>&gt;</span><br><span class="line">      &lt;Header /&gt;</span><br><span class="line">      &lt;Footer /&gt;</span><br><span class="line">    &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Mine.config = &#123;</span></span><br><span class="line"><span class="regexp">  navigationBarTitleText: '我的',</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>最后，我们修改首页的 <code>src/pages/index/index.jsx</code> ：</p>
<figure class="highlight jsx"><figcaption><span>src/pages/index/index.jsx</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2EyMzcyNmE2YjI4ZGM3ODMzMGM3OTQ1NjNlZTQ5Yjc5ODAzMDMyNjYvc3JjL3BhZ2VzL2luZGV4L2luZGV4LmpzeA==" title="https://github.com/tuture-dev/ultra-club/blob/a23726a6b28dc78330c794563ee49b7980303266/src/pages/index/index.jsx">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View, Text &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtFab, AtFloatLayout, AtMessage &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; PostCard, PostForm &#125; <span class="keyword">from</span> <span class="string">'../../components'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  SET_POST_FORM_IS_OPENED,</span><br><span class="line">  SET_LOGIN_INFO,</span><br><span class="line">  GET_POSTS,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.post.posts) || []</span><br><span class="line">  <span class="keyword">const</span> isOpened = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.post.isOpened)</span><br><span class="line">[tuture-del]  <span class="keyword">const</span> nickName = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.nickName)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">[tuture-del]  <span class="keyword">const</span> isLogged = !!nickName</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> isLogged = !!userId</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> WeappEnv = Taro.getEnv() === Taro.ENV_TYPE.WEAPP</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WeappEnv) &#123;</span><br><span class="line">      Taro.cloud.init()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStorage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> Taro.getStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; nickName, avatar, _id &#125; = data</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type: SET_LOGIN_INFO,</span><br><span class="line">          payload: &#123; nickName, avatar, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getStorage ERR: '</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isLogged) &#123;</span><br><span class="line">      getStorage()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getPosts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type: GET_POSTS,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getPosts ERR: '</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!posts.length) &#123;</span><br><span class="line">      getPosts()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setIsOpened</span>(<span class="params">isOpened</span>) </span>&#123;</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: SET_POST_FORM_IS_OPENED, <span class="attr">payload</span>: &#123; isOpened &#125; &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClickEdit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isLogged) &#123;</span><br><span class="line">      Taro.atMessage(&#123;</span><br><span class="line">        type: <span class="string">'warning'</span>,</span><br><span class="line">        message: <span class="string">'您还未登录哦！'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setIsOpened(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'posts'</span>, posts)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"index"</span>&gt;</span><br><span class="line">      &lt;AtMessage /&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;PostCard key=&#123;post._id&#125; postId=&#123;post._id&#125; post=&#123;post&#125; isList /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;AtFloatLayout</span><br><span class="line">        isOpened=&#123;isOpened&#125;</span><br><span class="line">        title=<span class="string">"发表新文章"</span></span><br><span class="line">        onClose=&#123;() =&gt; setIsOpened(<span class="literal">false</span>)&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;PostForm /&gt;</span><br><span class="line">      &lt;<span class="regexp">/AtFloatLayout&gt;</span></span><br><span class="line"><span class="regexp">      &lt;View className="post-button"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;AtFab onClick=&#123;handleClickEdit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Text className="at-fab__icon at-icon at-icon-edit"&gt;&lt;/</span>Text&gt;</span><br><span class="line">        &lt;<span class="regexp">/AtFab&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>View&gt;</span><br><span class="line">    &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Index.config = &#123;</span></span><br><span class="line"><span class="regexp">  navigationBarTitleText: '首页',</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改了如上代码并保存之后，打开应用，我们点击登出，应该顺利看到如下效果：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281abc7d4f9b3.gif"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>在这一节中，我们呼应使用 Authing 登录的逻辑，对应修改了登出逻辑，并且使用 <code>userId</code> 替换 <code>nickName</code> 作为是否登录的判断标准。</p>
<h2 id="集成微信授权登录"><a href="#集成微信授权登录" class="headerlink" title="集成微信授权登录"></a>集成微信授权登录</h2><p>在前两小节中，我们使用 Authing 集成了手机号+验证码的登录逻辑，然后处理了登出逻辑，有同学可能会问了，我们之前是取代了普通登录，还有一个微信登录，我们是不是也可以用 Authing 来进行替换呢？毕竟集成用户系统肯定要全面集成，答案是可以！</p>
<p>接下来我们将使用 Authing 为我们提供的 <code>loginWithWxapp</code> ，快捷的将微信授权登录集成好，打开 <code>src/components/WeappLoginButton/index.js</code> 文件，对其中的内容作出对应的修改如下：</p>
<figure class="highlight js"><figcaption><span>src/components/WeappLoginButton/index.js</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzI5Y2UwNWJkYjc0ZGQ1M2Y2ZDgzYjgyNTkxMTg2ZDJkMWQxMDgzNWIvc3JjL2NvbXBvbmVudHMvV2VhcHBMb2dpbkJ1dHRvbi9pbmRleC5qcw==" title="https://github.com/tuture-dev/ultra-club/blob/29ce05bdb74dd53f6d83b82591186d2d1d10835b/src/components/WeappLoginButton/index.js">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-del]<span class="keyword">import</span> Taro, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Taro, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Button &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line">[tuture-del]<span class="keyword">import</span> &#123; LOGIN &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> &#123; SET_LOGIN_INFO &#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Authing <span class="keyword">from</span> <span class="string">'../../utils/authing/authing'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">WeappLoginButton</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isLogin, setIsLogin] = useState(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">onGetUserInfo</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    setIsLogin(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">[tuture-del]    <span class="keyword">const</span> &#123; avatarUrl, nickName &#125; = e.detail.userInfo</span><br><span class="line">[tuture-del]    <span class="keyword">const</span> userInfo = &#123; <span class="attr">avatar</span>: avatarUrl, nickName &#125;</span><br><span class="line">[tuture-del] </span><br><span class="line">[tuture-del]    dispatch(&#123;</span><br><span class="line">[tuture-del]      type: LOGIN,</span><br><span class="line">[tuture-del]      payload: &#123;</span><br><span class="line">[tuture-del]        userInfo: userInfo,</span><br><span class="line">[tuture-del]      &#125;,</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> userPoolId = <span class="string">'5ea4ffa72b3a80b6eff60b65'</span></span><br><span class="line">[tuture-add]    <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]      userPoolId,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">[tuture-add]    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loginWithAuthing</span>(<span class="params">code, detail</span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> userInfo = <span class="keyword">await</span> authing.loginWithWxapp(&#123;</span><br><span class="line">[tuture-add]          code,</span><br><span class="line">[tuture-add]          detail,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        <span class="comment">// 提示登录成功</span></span><br><span class="line">[tuture-add]        Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]          type: <span class="string">'success'</span>,</span><br><span class="line">[tuture-add]          message: <span class="string">'恭喜您，登录成功！'</span>,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        <span class="keyword">const</span> &#123; nickname, photo, _id &#125; = userInfo</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        dispatch(&#123;</span><br><span class="line">[tuture-add]          type: SET_LOGIN_INFO,</span><br><span class="line">[tuture-add]          payload: &#123; <span class="attr">nickName</span>: nickname, <span class="attr">avatar</span>: photo, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        <span class="comment">// 向后端发起登录请求</span></span><br><span class="line">[tuture-add]        <span class="keyword">await</span> Taro.setStorage(&#123;</span><br><span class="line">[tuture-add]          key: <span class="string">'userInfo'</span>,</span><br><span class="line">[tuture-add]          data: &#123;</span><br><span class="line">[tuture-add]            nickName: nickname,</span><br><span class="line">[tuture-add]            avatar: photo,</span><br><span class="line">[tuture-add]            _id,</span><br><span class="line">[tuture-add]          &#125;,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        <span class="keyword">await</span> Taro.setStorage(&#123;</span><br><span class="line">[tuture-add]          key: <span class="string">'token'</span>,</span><br><span class="line">[tuture-add]          data: userInfo.token,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]        <span class="comment">// 当 code 用于登录之后，会失效，所以这里重新获取 code</span></span><br><span class="line">[tuture-add]        Taro.login(&#123;</span><br><span class="line">[tuture-add]          success(res) &#123;</span><br><span class="line">[tuture-add]            <span class="keyword">const</span> code = res.code</span><br><span class="line">[tuture-add]            Taro.setStorageSync(<span class="string">'code'</span>, code)</span><br><span class="line">[tuture-add]          &#125;,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add]      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">[tuture-add]        <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">[tuture-add]        Taro.atMessage(&#123;</span><br><span class="line">[tuture-add]          type: <span class="string">'success'</span>,</span><br><span class="line">[tuture-add]          message: <span class="string">'恭喜您，登录成功！'</span>,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]    <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-add]      <span class="keyword">const</span> code = Taro.getStorageSync(<span class="string">'code'</span>)</span><br><span class="line">[tuture-add]      Taro.login(&#123;</span><br><span class="line">[tuture-add]        success(res) &#123;</span><br><span class="line">[tuture-add]          <span class="keyword">const</span> code = res.code</span><br><span class="line">[tuture-add]          loginWithAuthing(code, e.detail)</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      &#125;)</span><br><span class="line">[tuture-add]    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">[tuture-add]      <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add] </span><br><span class="line">    setIsLogin(<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Button</span><br><span class="line">      openType=<span class="string">"getUserInfo"</span></span><br><span class="line">      onGetUserInfo=&#123;onGetUserInfo&#125;</span><br><span class="line">      type=<span class="string">"primary"</span></span><br><span class="line">      className=<span class="string">"login-button"</span></span><br><span class="line">      loading=&#123;isLogin&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      微信登录</span><br><span class="line">    &lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到上面的内容主要有如下几处修改：</p>
<ul>
<li>我们删除了之前简单粗暴获取到 <code>userInfo</code> 里面的 <code>nickName</code> 和 <code>avatarUrl</code> 就发起登录的代码逻辑。</li>
<li>我们在 <code>onGetUserInfo</code> 里面初始化了一个 <code>authing</code> 实例，然后定义了一个 <code>loginWithAuthing</code> 方法，具体细节我们马上讲解，然后我们使用 <code>Taro.login</code> 调用微信授权登录 API，获取对应的 <code>code</code> ，并连同把 <code>onGetUserInfo</code> 传进来的 <code>e.detail</code> 一起传给 <code>loginWithAuthing</code> 。</li>
<li>在 <code>loginWithAuthing</code> 函数里面，哦们首先调用 <code>authing.loginWithWxapp</code> ，并传入对应的 <code>code</code> 和 <code>detail</code> ，进行登录，然后将登录获取的信息存在 <code>storage</code> 里面以及保存在 Redux Store 中，并提示用户登录成功。</li>
</ul>
<p>保存上面的代码，并运行我们的应用，你应该可以自由的操作微信登录了：</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281abd1c93268.gif"></p>
<p>就这样，我们就成功将微信授权登录使用 Authing 集成好了，可以看到我们只需要一个 <code>loginWithWxapp</code> 就把逻辑集成好了，完全不需要之前 <code>dispatch</code> 一个 <code>LOGIN</code> 请求，还要去处理一堆 <code>sagas</code> 逻辑，并且还要编写小程序云函数逻辑，手动处理这些逻辑不仅繁琐，还容易出错，并且也不够灵活，而 Authing 提供的 SDK 可以很好的解决这一点，赋能业务成功。</p>
<h2 id="新版用户系统整合进现有后端"><a href="#新版用户系统整合进现有后端" class="headerlink" title="新版用户系统整合进现有后端"></a>新版用户系统整合进现有后端</h2><p>在之前四个小节，我们都在将现有小程序博客的用户逻辑使用 Authing 来替代，而将用户逻辑用 Authing 来替代之后，我们会遇到一个小问题，就是之前的用户系统与其他模块如我们的发帖模块是存在耦合的，所以我们还需要将这个耦合的部分替换成 Authing 的相关逻辑，这就涉及到如何将新版的用户系统整合进现有的后端。</p>
<p>我们目前的博客小程序涉及到和用户系统耦合的部分就是我们云函数 <code>createPost</code> 在发帖的时候要带上用户信息，所以我们需要在这个云函数下使用 Authing 来替换相应的用户逻辑。</p>
<h3 id="安装-SDK"><a href="#安装-SDK" class="headerlink" title="安装 SDK"></a>安装 SDK</h3><p>我们的微信小程序后台使用了云函数，而云函数是一个个的 Node.js 函数，而 Authing 为我们提供了 Node.js 的 SDK npm 包，我们马上来安装它，在 <code>functions/createPost</code> 下执行如下的代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install authing-js-sdk</span><br></pre></td></tr></table></figure>

<p>执行之后，我们的 <code>package.json</code> 会是如下的样子：</p>
<figure class="highlight"><figcaption><span>functions/createPost/package.json</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzMzNmE2MGJiYWQzNTQ1MzFiNmM4NzVmNWYxMDMxOWFkNjRhNzI2N2QvZnVuY3Rpb25zL2NyZWF0ZVBvc3QvcGFja2FnZS5qc29u" title="https://github.com/tuture-dev/ultra-club/blob/336a60bbad354531b6c875f5f10319ad64a7267d/functions/createPost/package.json">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"createPost"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">[tuture-add]    "authing-js-sdk": "^3.18.7",</span><br><span class="line">    "wx-server-sdk": "latest"</span><br><span class="line">  &#125;</span><br><span class="line">[tuture-del]&#125;</span><br><span class="line">[tuture-add]&#125;</span><br></pre></td></tr></table></figure>

<p>接着，我们在云函数里面替换对应的逻辑，打开 <code>functions/createPost/index.js</code> 文件，对其中的内容做出对应的修改如下：</p>
<figure class="highlight js"><figcaption><span>functions/createPost/index.js</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iLzMzNmE2MGJiYWQzNTQ1MzFiNmM4NzVmNWYxMDMxOWFkNjRhNzI2N2QvZnVuY3Rpb25zL2NyZWF0ZVBvc3QvaW5kZXguanM=" title="https://github.com/tuture-dev/ultra-club/blob/336a60bbad354531b6c875f5f10319ad64a7267d/functions/createPost/index.js">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// 云函数入口文件</span></span><br><span class="line"><span class="keyword">const</span> cloud = <span class="built_in">require</span>(<span class="string">'wx-server-sdk'</span>)</span><br><span class="line">[tuture-add]<span class="keyword">const</span> Authing = <span class="built_in">require</span>(<span class="string">'authing-js-sdk'</span>)</span><br><span class="line"></span><br><span class="line">cloud.init(&#123;</span><br><span class="line">  env: cloud.DYNAMIC_CURRENT_ENV,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = cloud.database()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 云函数入口函数</span></span><br><span class="line">exports.main = <span class="keyword">async</span> (event, context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; postData, userId &#125; = event</span><br><span class="line"></span><br><span class="line">[tuture-del]  <span class="built_in">console</span>.log(<span class="string">'event'</span>, event)</span><br><span class="line">[tuture-add]  <span class="keyword">const</span> userPoolId = <span class="string">''</span></span><br><span class="line">[tuture-add]  <span class="keyword">const</span> secret = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-del]    <span class="keyword">const</span> user = <span class="keyword">await</span> db</span><br><span class="line">[tuture-del]      .collection(<span class="string">'user'</span>)</span><br><span class="line">[tuture-del]      .doc(userId)</span><br><span class="line">[tuture-del]      .get()</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]      userPoolId,</span><br><span class="line">[tuture-add]      secret,</span><br><span class="line">[tuture-add]    &#125;)</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> userInfo = <span class="keyword">await</span> authing.user(&#123; <span class="attr">id</span>: userId &#125;)</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> &#123; nickname, photo &#125; = userInfo</span><br><span class="line">[tuture-add] </span><br><span class="line">    <span class="keyword">const</span> &#123; _id &#125; = <span class="keyword">await</span> db.collection(<span class="string">'post'</span>).add(&#123;</span><br><span class="line">      data: &#123;</span><br><span class="line">        ...postData,</span><br><span class="line">[tuture-del]        user: user.data,</span><br><span class="line">[tuture-add]        user: &#123; <span class="attr">nickName</span>: nickname, <span class="attr">avatar</span>: photo, <span class="attr">_id</span>: userInfo._id &#125;,</span><br><span class="line">        createdAt: db.serverDate(),</span><br><span class="line">        updatedAt: db.serverDate(),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newPost = <span class="keyword">await</span> db</span><br><span class="line">      .collection(<span class="string">'post'</span>)</span><br><span class="line">      .doc(_id)</span><br><span class="line">      .get()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      post: &#123; ...newPost.data &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">`createUser ERR: <span class="subst">$&#123;err&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们主要做了如下几处修改：</p>
<ul>
<li>我们导入了 Authing SDK</li>
<li>然后函数内部我们定义了 <code>userPoolId</code> 和 <code>secret</code> 来初始化 <code>authing</code> 实例，这两个参数我们可以在用户池控制台找到：</li>
</ul>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281abd4f70166.png"></p>
<ul>
<li>接着我们使用初始化好的 <code>authing</code> 来调用 <code>authing.user</code> 方法传入我们接收到的 <code>userId</code> 查询在 Authing 中保存的此用户资料，并用这个用户资料替换我们需要在小程序云数据库里面查到的用户数据</li>
</ul>
<p>自此，我们就在前后端深度整合了 Authing 用户系统，在之后我们的应用扩展过程中，所有和用户有关的逻辑都不需要自己在后台单独编写，前端也大大简化了工作量，并且我们还能在 Authing 的控制台可视化用户的数据：登录情况、登录区域、登录机器，还可以给用户进行权限分配，甚至直接修改用户资料等。</p>
<p><img alt data-src="https://static.powerformer.com/c/34a473b/172281abd746fd45.png"></p>
<h2 id="通过鉴权保有用户登录状态"><a href="#通过鉴权保有用户登录状态" class="headerlink" title="通过鉴权保有用户登录状态"></a>通过鉴权保有用户登录状态</h2><p>最后，我们来收尾一下，做一下用户登录状态的查询，因为应用的登录凭证它存在一个失效时间，当时间一到，我们再去操作用户信息就会显示没有权限，因为凭证失效了，所以说我们要及时检查用户的登录凭证是否失效，如果失效则要求用户重新登录，这也是读者经常会在访问某些网站的时候遇到，而现在我们将实操一下这个过程。</p>
<p>一般处理用户登录态的验证主要是在应用刚刚启动时，去进行一个鉴权处理，如果用户态有效，则顺利从应用的 <code>storage</code>  里面取出数据，然后设置进前端状态管理，进而展示用户数据，而如果没有则删除 <code>storage</code> 里面的数据，提示用户进行登录。</p>
<p>我们打开 <code>src/pages/index/index.jsx</code> 来实操，对其中的内容作出对应的修改如下：</p>
<figure class="highlight jsx"><figcaption><span>src/pages/index/index.jsx</span><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXYvdWx0cmEtY2x1Yi9ibG9iL2MxNjk4NGQyNTk1M2NjZWUzYTM0NTgxNTcxM2NiNTRjOWY5YmMzZmEvc3JjL3BhZ2VzL2luZGV4L2luZGV4LmpzeA==" title="https://github.com/tuture-dev/ultra-club/blob/c16984d25953ccee3a345815713cb54c9f9bc3fa/src/pages/index/index.jsx">查看完整代码<i class="fa fa-external-link"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'@tarojs/taro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; View, Text &#125; <span class="keyword">from</span> <span class="string">'@tarojs/components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AtFab, AtFloatLayout, AtMessage &#125; <span class="keyword">from</span> <span class="string">'taro-ui'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">'@tarojs/redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; PostCard, PostForm &#125; <span class="keyword">from</span> <span class="string">'../../components'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.scss'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  SET_POST_FORM_IS_OPENED,</span><br><span class="line">  SET_LOGIN_INFO,</span><br><span class="line">  GET_POSTS,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../constants'</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Authing <span class="keyword">from</span> <span class="string">'../../utils/authing/authing'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.post.posts) || []</span><br><span class="line">  <span class="keyword">const</span> isOpened = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.post.isOpened)</span><br><span class="line">  <span class="keyword">const</span> userId = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.user.userId)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isLogged = !!userId</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch()</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> WeappEnv = Taro.getEnv() === Taro.ENV_TYPE.WEAPP</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WeappEnv) &#123;</span><br><span class="line">      Taro.cloud.init()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStorage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="comment">// 在应用初始化的时候，对应用进行鉴权，检查登录状态，如果登录失效，则情况缓存信息</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">[tuture-del]        <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> Taro.getStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> userPoolId = <span class="string">''</span></span><br><span class="line">[tuture-add]        <span class="keyword">const</span> &#123; <span class="attr">data</span>: token &#125; = <span class="keyword">await</span> Taro.getStorage(&#123; <span class="attr">key</span>: <span class="string">'token'</span> &#125;)</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> authing = <span class="keyword">new</span> Authing(&#123;</span><br><span class="line">[tuture-add]          userPoolId,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> result = <span class="keyword">await</span> Taro.request(&#123;</span><br><span class="line">[tuture-add]          url: <span class="string">`https://users.authing.cn/authing/token?access_token=<span class="subst">$&#123;userInfo.token&#125;</span>`</span>,</span><br><span class="line">[tuture-add]        &#125;)</span><br><span class="line"></span><br><span class="line">[tuture-del]        <span class="keyword">const</span> &#123; nickName, avatar, _id &#125; = data</span><br><span class="line">[tuture-add]        <span class="keyword">if</span> (result.data.status) &#123;</span><br><span class="line">[tuture-add]          <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> Taro.getStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line"></span><br><span class="line">[tuture-del]        <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">[tuture-del]        dispatch(&#123;</span><br><span class="line">[tuture-del]          type: SET_LOGIN_INFO,</span><br><span class="line">[tuture-del]          payload: &#123; nickName, avatar, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">[tuture-del]        &#125;)</span><br><span class="line">[tuture-add]          <span class="keyword">const</span> &#123; nickName, avatar, _id &#125; = data</span><br><span class="line">[tuture-add] </span><br><span class="line">[tuture-add]          <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">[tuture-add]          dispatch(&#123;</span><br><span class="line">[tuture-add]            type: SET_LOGIN_INFO,</span><br><span class="line">[tuture-add]            payload: &#123; nickName, avatar, <span class="attr">userId</span>: _id &#125;,</span><br><span class="line">[tuture-add]          &#125;)</span><br><span class="line">[tuture-add]        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]          <span class="keyword">await</span> Taro.removeStorage(&#123; <span class="attr">key</span>: <span class="string">'userInfo'</span> &#125;)</span><br><span class="line">[tuture-add]          <span class="keyword">await</span> Taro.removeStorage(&#123; <span class="attr">key</span>: <span class="string">'token'</span> &#125;)</span><br><span class="line">[tuture-add]        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getStorage ERR: '</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isLogged) &#123;</span><br><span class="line">      getStorage()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getPosts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 更新 Redux Store 数据</span></span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type: GET_POSTS,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getPosts ERR: '</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!posts.length) &#123;</span><br><span class="line">      getPosts()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setIsOpened</span>(<span class="params">isOpened</span>) </span>&#123;</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: SET_POST_FORM_IS_OPENED, <span class="attr">payload</span>: &#123; isOpened &#125; &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClickEdit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isLogged) &#123;</span><br><span class="line">      Taro.atMessage(&#123;</span><br><span class="line">        type: <span class="string">'warning'</span>,</span><br><span class="line">        message: <span class="string">'您还未登录哦！'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setIsOpened(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'posts'</span>, posts)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;View className=<span class="string">"index"</span>&gt;</span><br><span class="line">      &lt;AtMessage /&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;PostCard key=&#123;post._id&#125; postId=&#123;post._id&#125; post=&#123;post&#125; isList /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;AtFloatLayout</span><br><span class="line">        isOpened=&#123;isOpened&#125;</span><br><span class="line">        title=<span class="string">"发表新文章"</span></span><br><span class="line">        onClose=&#123;() =&gt; setIsOpened(<span class="literal">false</span>)&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;PostForm /&gt;</span><br><span class="line">      &lt;<span class="regexp">/AtFloatLayout&gt;</span></span><br><span class="line"><span class="regexp">      &lt;View className="post-button"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;AtFab onClick=&#123;handleClickEdit&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Text className="at-fab__icon at-icon at-icon-edit"&gt;&lt;/</span>Text&gt;</span><br><span class="line">        &lt;<span class="regexp">/AtFab&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>View&gt;</span><br><span class="line">    &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Index.config = &#123;</span></span><br><span class="line"><span class="regexp">  navigationBarTitleText: '首页',</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，上面的内容主要做出了如下几处修改：</p>
<ul>
<li>我们在 <code>getStorage</code> 函数里面，首先获取了之前登录时保存的用户凭证 <code>token</code> ，然后初始化了一个 <code>authing</code> 实例，并通过 <code>Taro.request</code> 的方式，去请求 Authing 为我们提供的鉴权地址：<code>https://users.authing.cn/authing/token?access_token=YOUR_TOKEN</code> ，我们将这个链接中的 <code>YOUR_TOKEN</code> 替换成我们保存在 <code>storage</code> 里面的 <code>token</code> ，访问这个地址如果成功则会得到如下的结果：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"status"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"message"</span>: <span class="string">"已登录"</span>,</span><br><span class="line">  <span class="string">"code"</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="string">"token"</span>: &#123;</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">	<span class="string">"email"</span>: <span class="string">"YOUR_EMAIL@domain.com"</span>,</span><br><span class="line">	<span class="string">"id"</span>: <span class="string">"YOUR_USER_ID"</span>,</span><br><span class="line">	<span class="string">"clientId"</span>: <span class="string">"YOUR_UESR_POOL_ID"</span></span><br><span class="line">    &#125;,</span><br><span class="line">        <span class="string">"iat"</span>: <span class="string">"Token 签发时间"</span></span><br><span class="line">	<span class="string">"exp"</span>: <span class="string">"Token 过期时间"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果失败其中的 <code>status</code> 会为 <code>false</code> ，其它内容也会相应的变化。</p>
<ul>
<li>接着我们判断 <code>status</code> ，如果为 <code>true</code> 则从 <code>storage</code> 里面取出数据，设置进 Redux Store，如果为 <code>false</code> ，我们清空 <code>storage</code> 数据，这样在用户发帖时会提示用户需要登录。</li>
</ul>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>通过这篇教程，我们将之前一个比较简单的用户系统替换成了专业的通用云身份提供商 Authing 提供的专业的用户系统，并且体验到了通过短短几行代码就可以实现专业的手机号+验证码登录、用户登出、微信授权登录、并且还可以做用户登录状态的检测等。</p>
<p>有了这样一个简单、方便且强大的用户系统做保障之后，我们的博客应用小程序将可以无顾虑的扩展其它模块，而涉及到身份相关的内容都可以交给 Authing 来做。当然我们这片文章还只用了 Authing 很小的一部分功能，还有诸如企业组织管理、单点登录等高级功能，有兴趣的用户可以自行发掘💪！</p>

    </div>

    
    
    
      

        <div id="qrcode_subscriber-container">
  <div></div>

  <div id="qrocde-qr">
        
      
      <div style="display: inline-block">
        <img src="/uploads/wechat-qcode.png" alt="图雀社区 微信公众号">
        <p>扫一扫关注上方公众号，拉学习群和答疑解惑</p>
      </div>

  </div>
</div>

      
        
      
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>图雀社区</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tuture.co/2020/05/17/2b5a9f1/" title="Taro 小程序开发大型实战（七）：使用 Authing 打造完整且强大的用户系统">https://tuture.co/2020/05/17/2b5a9f1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li>
</ul>
</div>

      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/Taro/" rel="tag"><i class="fa fa-tag"></i> Taro</a>
            
              <a href="/tags/%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="fa fa-tag"></i> 用户系统</a>
            
              <a href="/tags/%E9%89%B4%E6%9D%83/" rel="tag"><i class="fa fa-tag"></i> 鉴权</a>
            
              <a href="/tags/%E8%AE%A4%E8%AF%81/" rel="tag"><i class="fa fa-tag"></i> 认证</a>
            
              <a href="/tags/OAuth/" rel="tag"><i class="fa fa-tag"></i> OAuth</a>
            
              <a href="/tags/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95/" rel="tag"><i class="fa fa-tag"></i> 微信登录</a>
            
              <a href="/tags/QQ%E7%99%BB%E5%BD%95/" rel="tag"><i class="fa fa-tag"></i> QQ登录</a>
            
              <a href="/tags/Github%E7%99%BB%E5%BD%95/" rel="tag"><i class="fa fa-tag"></i> Github登录</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2020/05/12/@4675l54tY/" rel="next" title="Nest.js 从零到壹系列（七）：讨厌写文档，Swagger UI 了解一下？">
                  <i class="fa fa-chevron-left"></i> Nest.js 从零到壹系列（七）：讨厌写文档，Swagger UI 了解一下？
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2020/05/17/nO-RmUb/" rel="prev" title="从零到部署：用 Vue 和 Express 实现迷你全栈电商应用（九）：使用 Authing 集成完整的用户系统">
                  从零到部署：用 Vue 和 Express 实现迷你全栈电商应用（九）：使用 Authing 集成完整的用户系统 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      <div>
          
          
          
          
        

        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc">
            文章目录
          </li>
          <li class="sidebar-nav-overview">
            站点概览
          </li>
        </ul>

        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备新版登录逻辑"><span class="nav-number">1.</span> <span class="nav-text">准备新版登录逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#改进普通登录"><span class="nav-number">1.1.</span> <span class="nav-text">改进普通登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#样式改进"><span class="nav-number">1.2.</span> <span class="nav-text">样式改进</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Taro-物料"><span class="nav-number">1.3.</span> <span class="nav-text">使用 Taro 物料</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-Authing-接入完整的用户系统"><span class="nav-number">2.</span> <span class="nav-text">使用 Authing 接入完整的用户系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注册-Authing-账号"><span class="nav-number">2.1.</span> <span class="nav-text">注册 Authing 账号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和配置-SDK"><span class="nav-number">2.2.</span> <span class="nav-text">下载和配置 SDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开始集成"><span class="nav-number">2.3.</span> <span class="nav-text">开始集成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理登出逻辑"><span class="nav-number">3.</span> <span class="nav-text">处理登出逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#改进登出组件"><span class="nav-number">3.1.</span> <span class="nav-text">改进登出组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#清理其他登出逻辑"><span class="nav-number">3.2.</span> <span class="nav-text">清理其他登出逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">3.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集成微信授权登录"><span class="nav-number">4.</span> <span class="nav-text">集成微信授权登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新版用户系统整合进现有后端"><span class="nav-number">5.</span> <span class="nav-text">新版用户系统整合进现有后端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-SDK"><span class="nav-number">5.1.</span> <span class="nav-text">安装 SDK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过鉴权保有用户登录状态"><span class="nav-number">6.</span> <span class="nav-text">通过鉴权保有用户登录状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结-1"><span class="nav-number">7.</span> <span class="nav-text">小结</span></a></li></ol></div>
          
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="图雀社区">
  <p class="site-author-name" itemprop="name">图雀社区</p>
  <div class="site-description" itemprop="description">由 <a href="https://github.com/tuture-dev/tuture" target="_blank" rel="external nofollow noopener noreferrer">Tuture</a> 工具写成，这里汇集了能够让你从头敲到尾并做出可运行项目的精彩的免费技术教程</div>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vdXNlci81YjMzNDE0MzUxODgyNTc0Yjk2OTRkMjg="><i class="fa fa-fw fa-custom juejin"></i>掘金</span>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="/images/social/wechat.png"><i class="fa fa-fw fa-custom wechat"></i>微信</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vdHV0dXJl"><i class="fa fa-fw fa-custom zhihu"></i>知乎</span>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R1dHVyZS1kZXY="><i class="fa fa-fw fa-github"></i>GitHub</span>
      </span>
    
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright"><span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5taWl0Lmdvdi5jbg==">沪ICP备19039313号 </span><span><img src="/images/gongan-url.png" style="display:inline-block;">
  
  <span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5nb3YuY24vcG9ydGFsL3JlZ2lzdGVyU3lzdGVtSW5mbz9yZWNvcmRjb2RlPTMxMDExNzAyMDA3MTMw">沪公网安备 31011702007130号 </span>&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">图雀社区</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">891k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:30</span>
</span></div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v4.2.1</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Pisces</span> v7.4.0</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>

<script src="/js/utils.js?v=7.4.0.js"></script>


<script src="/js/schemes/pisces.js?v=7.4.0.js"></script>


<script src="/js/next-boot.js?v=7.4.0.js"></script>

<script src="/js/bookmark.js?v=7.4.0.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>








  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script>
<script src="/js/algolia-search.js?v=7.4.0.js"></script>
















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '6310753ce4e95163d2b0',
      clientSecret: '4fd6839b697f9d50e01eebbb9566d8bdf3bd75b4',
      repo: 'comments',
      owner: 'tuture-dev',
      admin: 'pftom,mRcfps,tuture-dev'.split(','),
      id: '2622327b3fec5a72df5caf8ad0c8607b',
        language: 'zh-CN',
      
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>


  <script>
    const line = document.getElementsByClassName('line');
    const arrLine = Array.from(line);

    const delRegex = /\[.*tuture.*-.*del.*?\]/;
    const addRegex = /\[.*tuture.*-.*add.*?\]/;
    const omitRegex = /\[.*tuture.*-.*omit.*?\]/;

    const delSpaceRegex = /^\s*\[.*tuture.*-.*del.*?\]\s*$/;
    const addSpaceRegex = /^\s*\[.*tuture.*-.*add.*?\]\s*$/;
    const omitSpaceRegex = /^\s*\[.*tuture.*-.*omit.*?\]\s*$/;

    arrLine.map(item => {
      if (item.innerText.startsWith('[tuture-add]')) {
        if (addSpaceRegex.test(item.innerText)) {
          item.innerHTML = item.innerHTML.replace(addRegex, ' ');
        } else {
          item.innerHTML = item.innerHTML.replace(addRegex, '');
        }

          item.className = item.className + ' tuture-add';
      } else if (item.innerText.startsWith('[tuture-del]')) {
          if (delSpaceRegex.test(item.innerText)) {
            item.innerHTML = item.innerHTML.replace(delRegex, ' ');
          } else {
            item.innerHTML = item.innerHTML.replace(delRegex, '');
          }

          item.className = item.className + ' tuture-del';
      } else if (item.innerText.startsWith('[tuture-omit]')) {
        item.innerHTML = item.innerHTML.replace(omitRegex, '...');
        item.className = item.className + ' tuture-omit';
      }
    })
  </script>
</body>
</html>
