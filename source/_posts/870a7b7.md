---
title: "ç”¨åŠ¨ç”»å’Œå®æˆ˜æ‰“å¼€ React Hooksï¼ˆä¸€ï¼‰ï¼šuseState å’Œ useEffect"
description: "è‡ªä» React 16.8 å‘å¸ƒä¹‹åï¼Œå®ƒå¸¦æ¥çš„ React Hooks åœ¨å‰ç«¯åœˆå¼•èµ·äº†ä¸€åœºæ— æ³•é€†è½¬çš„é£æš´ã€‚React Hooks ä¸ºå‡½æ•°å¼ç»„ä»¶æä¾›äº†æ— é™çš„åŠŸèƒ½ï¼Œè§£å†³äº†ç±»ç»„ä»¶å¾ˆå¤šçš„å›ºæœ‰ç¼ºé™·ã€‚è¿™ç¯‡æ•™ç¨‹å°†å¸¦ä½ å¿«é€Ÿç†Ÿæ‚‰å¹¶æŒæ¡æœ€å¸¸ç”¨çš„ä¸¤ä¸ª Hookï¼šuseState å’Œ useEffectã€‚åœ¨äº†è§£å¦‚ä½•ä½¿ç”¨çš„åŒæ—¶ï¼Œè¿˜èƒ½ç®¡çª¥èƒŒåçš„åŸç†ï¼Œé¡ºä¾¿å®ç°ä¸€ä¸ª COVID-19ï¼ˆæ–°å† è‚ºç‚ï¼‰å¯è§†åŒ–åº”ç”¨ã€‚"
tags: ["React", "React Hooks"]
categories: ["å‰ç«¯", "React", "å…¥é—¨"]
date: 2020-04-08T02:52:36.227Z
photos:
  - https://static.powerformer.com/c/870a7b7/hook1.jpg
---

<div class="profileBox">
  <div class="avatarBox">
    <a href="https://github.com/tuture-dev"><img src="/images/avatars/tuture-dev.jpg" alt="" class="avatar"></a>
  </div>
  <div class="rightBox">
    <div class="infoBox">
    <a href="https://github.com/tuture-dev"><p class="nickName">@tuture-dev</p></a>
  </div>
  <div class="codeBox">
    <a href="https://github.com/tuture-dev/covid-19-with-hooks"><span class="codeText">æŸ¥çœ‹ä»£ç </span></a>
  </div>
  </div>
</div>

## èµ·æ­¥

### å‰ææ¡ä»¶

åœ¨é˜…è¯»è¿™ç¯‡æ•™ç¨‹ä¹‹å‰ï¼Œå¸Œæœ›ä½ å·²ç»åšäº†å¦‚ä¸‹å‡†å¤‡ï¼š

- æŒæ¡äº† React åŸºç¡€çŸ¥è¯†ï¼Œä¾‹å¦‚ç»„ä»¶ã€JSXã€çŠ¶æ€ç­‰ç­‰ï¼Œå¦‚æœä½ ä¸äº†è§£çš„è¯ï¼Œè¯·å…ˆå­¦ä¹ [ã€Šä¸€æ¯èŒ¶çš„æ—¶é—´ï¼Œä¸Šæ‰‹ React æ¡†æ¶ã€‹](https://tuture.co/2019/11/18/07acf61/)
- é…ç½®å¥½ Node ç¯å¢ƒï¼Œå¯å‚è€ƒ[ã€Šä¸€æ¯èŒ¶çš„æ—¶é—´ï¼Œä¸Šæ‰‹ Node.jsã€‹](https://tuture.co/2019/12/03/892fa12/)

### ä¸ºä»€ä¹ˆä¼šæœ‰ Hooksï¼Ÿ

åœ¨ Hooks å‡ºç°ä¹‹å‰ï¼Œç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶çš„åˆ†å·¥ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š

- **ç±»ç»„ä»¶**æä¾›äº†å®Œæ•´çš„çŠ¶æ€ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œé€šå¸¸ç”¨æ¥æ‰¿æ¥å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¢«ç§°ä¸º*â€œèªæ˜ç»„ä»¶â€*
- **å‡½æ•°ç»„ä»¶**åˆ™æ˜¯çº¯ç²¹çš„ä»æ•°æ®åˆ°è§†å›¾çš„æ˜ å°„ï¼Œå¯¹çŠ¶æ€æ¯«æ— æ„ŸçŸ¥ï¼Œå› æ­¤é€šå¸¸è¢«ç§°ä¸ºâ€œ*å‚»ç“œç»„ä»¶*â€

æœ‰äº›å›¢é˜Ÿè¿˜åˆ¶å®šäº†è¿™æ ·çš„ React ç»„ä»¶å¼€å‘çº¦å®šï¼š

> æœ‰çŠ¶æ€çš„ç»„ä»¶æ²¡æœ‰æ¸²æŸ“ï¼Œæœ‰æ¸²æŸ“çš„ç»„ä»¶æ²¡æœ‰çŠ¶æ€ã€‚

é‚£ä¹ˆ Hooks çš„å‡ºç°åˆæ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥è¯•å›¾æ€»ç»“ä¸€ä¸‹ç±»ç»„ä»¶é¢‡å…·ä»£è¡¨æ€§çš„**ç—›ç‚¹**ï¼š

1. ä»¤äººå¤´ç–¼çš„ `this` ç®¡ç†ï¼Œå®¹æ˜“å¼•å…¥éš¾ä»¥è¿½è¸ªçš„ Bug
2. ç”Ÿå‘½å‘¨æœŸçš„åˆ’åˆ†å¹¶ä¸ç¬¦åˆâ€œå†…èšæ€§â€åŸåˆ™ï¼Œä¾‹å¦‚ `setInterval` å’Œ `clearInterval` è¿™ç§å…·æœ‰å¼ºå…³è”çš„é€»è¾‘è¢«æ‹†åˆ†åœ¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­
3. ç»„ä»¶å¤ç”¨ï¼ˆæ•°æ®å…±äº«æˆ–åŠŸèƒ½å¤ç”¨ï¼‰çš„å›°å±€ï¼Œä»æ—©æœŸçš„ Mixinï¼Œåˆ°[é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰](https://zh-hans.reactjs.org/docs/higher-order-components.html)ï¼Œå†åˆ° [Render Props](https://zh-hans.reactjs.org/docs/render-props.html)ï¼Œå§‹ç»ˆæ²¡æœ‰ä¸€ä¸ªæ¸…æ™°ç›´è§‚åˆä¾¿äºç»´æŠ¤çš„ç»„ä»¶å¤ç”¨æ–¹æ¡ˆ

æ²¡é”™ï¼Œéšç€ Hooks çš„æ¨å‡ºï¼Œè¿™äº›ç—›ç‚¹éƒ½æˆä¸ºäº†å†å²ï¼

### ä¸ºä»€ä¹ˆè¦å†™è¿™ä¸€ç³»åˆ— Hooks æ•™ç¨‹ï¼Ÿ

å¦‚ä½•å¿«é€Ÿå­¦ä¹ å¹¶æŒæ¡ React Hooks ä¸€ç›´æ˜¯å›°æ‰°å¾ˆå¤šæ–°æ‰‹æˆ–è€…è€ç©å®¶çš„ä¸€ä¸ªé—®é¢˜ï¼Œè€Œç¬”è€…åœ¨æ—¥å¸¸çš„å­¦ä¹ å’Œå¼€å‘ä¸­ä¹Ÿå‘ç°äº†ä»¥ä¸‹å¤´ç–¼ä¹‹å¤„ï¼š

- React å®˜æ–¹æ–‡æ¡£å¯¹ Hooks çš„è®²è§£ååº”ç”¨ï¼Œå¯¹åŸç†çš„é˜è¿°ä¸€ç¬”å¸¦è¿‡
- è®² React Hooks çš„ä¼˜ç§€æ–‡ç« å¾ˆå¤šï¼Œä½†å¤§å¤šä¸“æ³¨äºè®²è§£ä¸€ä¸¤ä¸ª Hookï¼Œè¦æƒ³ä¸€ç½‘æ‰“å°½æœ‰éš¾åº¦
- çœ‹äº†å¾ˆå¤šä½¿ç”¨æ–¹æ³•ç”šè‡³æºç åˆ†æï¼Œä½†æ˜¯æ²¡æ³•å’Œå…·ä½“çš„ä½¿ç”¨åœºæ™¯å¯¹åº”èµ·æ¥ï¼Œä¸äº†è§£æ€ä¹ˆåœ¨å®é™…å¼€å‘ä¸­çµæ´»è¿ç”¨

å¦‚æœä½ ä¹Ÿæœ‰åŒæ ·çš„å›°æƒ‘ï¼Œå¸Œæœ›è¿™ä¸€ç³»åˆ—æ–‡ç« èƒ½å¸®åŠ©ä½ æ‹¨å¼€äº‘é›¾ï¼Œè®© Hooks æˆä¸ºä½ çš„ç§°æ‰‹å…µå™¨ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ COVID-19 æ•°æ®å¯è§†åŒ–é¡¹ç›®ï¼Œç»“åˆ Hooks çš„åŠ¨ç”»åŸç†è®²è§£ï¼Œè®©ä½ çœŸæ­£åœ°ç²¾é€š React Hooksï¼

è¯´å®è¯ï¼ŒHooks çš„çŸ¥è¯†ç‚¹ç›¸å½“åˆ†æ•£ï¼Œå°±åƒæ¸¸ä¹å›­çš„æ¸¸ç©é¡¹ç›®ä¸€æ ·ï¼Œé€‰æ‹©ä¸€æ¡å®Œç¾çš„è·¯çº¿å¾ˆéš¾ã€‚ä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå¸Œæœ›åœ¨æ¥ä¸‹æ¥çš„æ—…ç¨‹ä¸­ï¼Œä½ èƒ½ç©å¾—å¼€å¿ƒğŸ˜Šï¼

### åˆå§‹åŒ–é¡¹ç›®

é¦–å…ˆï¼Œé€šè¿‡ Create React Appï¼ˆä»¥ä¸‹ç®€ç§° CRAï¼‰ åˆå§‹åŒ–é¡¹ç›®ï¼š

```bash
npx create-react-app covid-19-with-hooks
```

åœ¨å°‘è®¸ç­‰å¾…ä¹‹åï¼Œè¿›å…¥é¡¹ç›®ã€‚

{% note info %}
**æç¤º**

æˆ‘ä»¬æ‰€æœ‰çš„æ•°æ®æºè‡ª [NovelCOVID 19 API](https://corona.lmao.ninja/docs/#/)ï¼Œå¯ä»¥ç‚¹å‡»è®¿é—®å…¶å…¨éƒ¨çš„ API æ–‡æ¡£ã€‚
{% endnote %}

ä¸€åˆ‡å°±ç»ªï¼Œè®©æˆ‘ä»¬å‡ºå‘å§ï¼

## useState + useEffectï¼šåˆæ¥ä¹åˆ°

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»æœ€æœ€æœ€å¸¸ç”¨çš„ä¸¤ä¸ª Hooks è¯´èµ·ï¼š`useState` å’Œ `useEffect` ã€‚å¾ˆæœ‰å¯èƒ½ï¼Œä½ åœ¨å¹³æ—¶çš„å­¦ä¹ å’Œå¼€å‘ä¸­å·²ç»æ¥è§¦å¹¶ä½¿ç”¨è¿‡äº†ï¼ˆå½“ç„¶å¦‚æœä½ åˆšå¼€å§‹å­¦ä¹Ÿæ²¡å…³ç³»å•¦ï¼‰ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸€ä¸‹ React å‡½æ•°å¼ç»„ä»¶çš„è¿è¡Œè¿‡ç¨‹ã€‚

### ç†è§£å‡½æ•°å¼ç»„ä»¶çš„è¿è¡Œè¿‡ç¨‹

æˆ‘ä»¬çŸ¥é“ï¼ŒHooks **åªèƒ½ç”¨äº React å‡½æ•°å¼ç»„ä»¶**ã€‚å› æ­¤ç†è§£å‡½æ•°å¼ç»„ä»¶çš„è¿è¡Œè¿‡ç¨‹å¯¹æŒæ¡ Hooks ä¸­è®¸å¤šé‡è¦çš„ç‰¹æ€§å¾ˆå…³é”®ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š

![](https://static.powerformer.com/c/870a7b7/1717865fb8a13cfe.gif)

å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•°å¼ç»„ä»¶ä¸¥æ ¼éµå¾ª `UI = render(data)` çš„æ¨¡å¼ã€‚å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨ç»„ä»¶å‡½æ•°æ—¶ï¼Œè§¦å‘**åˆæ¬¡æ¸²æŸ“**ï¼›ç„¶åéšç€ `props` çš„æ”¹å˜ï¼Œä¾¿ä¼šé‡æ–°è°ƒç”¨è¯¥ç»„ä»¶å‡½æ•°ï¼Œè§¦å‘**é‡æ¸²æŸ“**ã€‚

ä½ ä¹Ÿè®¸ä¼šçº³é—·ï¼ŒåŠ¨ç”»é‡Œé¢ä¸ºå•¥è¦å¹¶æ’ç”»ä¸‰ä¸ªä¸€æ ·çš„ç»„ä»¶å‘¢ï¼Ÿå› ä¸ºæˆ‘æƒ³é€šè¿‡è¿™ç§æ–¹å¼ç›´è§‚åœ°é˜è¿°å‡½æ•°å¼ç»„ä»¶çš„ä¸€ä¸ªé‡è¦æ€æƒ³ï¼š

> æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚

åé¢æˆ‘ä»¬å°†æ²¿ç”¨è¿™æ ·çš„é£æ ¼ï¼Œå¹¶ä¸€æ­¥æ­¥åœ°ä»‹ç» Hook åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­æ‰®æ¼”æ€æ ·çš„è§’è‰²ã€‚

### useState ä½¿ç”¨æµ…æ

é¦–å…ˆæˆ‘ä»¬æ¥ç®€å•åœ°äº†è§£ä¸€ä¸‹ `useState` é’©å­çš„ä½¿ç”¨ï¼Œå®˜æ–¹æ–‡æ¡£ä»‹ç»çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```js
const [state, setState] = useState(initialValue);
```

å…¶ä¸­ `state` å°±æ˜¯ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œ`setState` æ˜¯ä¸€ä¸ªç”¨äºä¿®æ”¹çŠ¶æ€çš„ Setter å‡½æ•°ï¼Œè€Œ `initialValue` åˆ™æ˜¯çŠ¶æ€çš„åˆå§‹å€¼ã€‚

å…‰çœ‹ä»£ç å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œè¯·çœ‹ä¸‹é¢çš„åŠ¨ç”»ï¼š

![](https://static.powerformer.com/c/870a7b7/1717865fbad32d1c.gif)

ä¸ä¹‹å‰çš„çº¯å‡½æ•°å¼ç»„ä»¶ç›¸æ¯”ï¼Œæˆ‘ä»¬å¼•å…¥äº† `useState` è¿™ä¸ªé’©å­ï¼Œç¬é—´å°±æ‰“ç ´äº†ä¹‹å‰ `UI = render(data)` çš„å®‰é™ç”»é¢â€”â€”å‡½æ•°ç»„ä»¶å±…ç„¶å¯ä»¥**ä»ç»„ä»¶ä¹‹å¤–æŠŠçŠ¶æ€å’Œä¿®æ”¹çŠ¶æ€çš„å‡½æ•°â€œé’©â€è¿‡æ¥**ï¼å¹¶ä¸”ä»”ç»†çœ‹ä¸Šé¢çš„åŠ¨ç”»ï¼Œ**é€šè¿‡è°ƒç”¨ Setter å‡½æ•°ï¼Œå±…ç„¶è¿˜å¯ä»¥ç›´æ¥è§¦å‘ç»„ä»¶çš„é‡æ¸²æŸ“**ï¼

{% note info %}
**æç¤º**

ä½ ä¹Ÿè®¸æ³¨æ„åˆ°äº†æ‰€æœ‰çš„â€œé’©å­â€éƒ½æŒ‡å‘äº†ä¸€ä¸ªç»¿è‰²çš„é—®å·ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹é¢è¯¦ç»†åœ°åˆ†æé‚£æ˜¯ä»€ä¹ˆï¼Œç°åœ¨å°±æš‚æ—¶æŠŠå®ƒçœ‹ä½œæ˜¯ç»„ä»¶ä¹‹å¤–å¯ä»¥è®¿é—®çš„ä¸€ä¸ªâ€œç¥ç§˜é¢†åŸŸâ€ã€‚
{% endnote %}

ç»“åˆä¸Šé¢çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªé‡è¦çš„æ¨è®ºï¼š**æ¯æ¬¡æ¸²æŸ“å…·æœ‰ç‹¬ç«‹çš„çŠ¶æ€å€¼**ï¼ˆæ¯•ç«Ÿæ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„å˜›ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå‡½æ•°ä¸­çš„ `state` å˜é‡åªæ˜¯ä¸€ä¸ªç®€å•çš„**å¸¸é‡**ï¼Œæ¯æ¬¡æ¸²æŸ“æ—¶ä»é’©å­ä¸­è·å–åˆ°çš„å¸¸é‡ï¼Œå¹¶æ²¡æœ‰é™„ç€æ•°æ®ç»‘å®šä¹‹ç±»çš„ç¥å¥‡é­”æ³•ã€‚

è¿™ä¹Ÿå°±æ˜¯è€ç”Ÿå¸¸è°ˆçš„ **Capture Value** ç‰¹æ€§ã€‚å¯ä»¥çœ‹ä¸‹é¢è¿™æ®µç»å…¸çš„è®¡æ•°å™¨ä»£ç ï¼ˆæ¥è‡ª Dan çš„[è¿™ç¯‡ç²¾å½©çš„æ–‡ç« ](https://overreacted.io/a-complete-guide-to-useeffect/)ï¼‰ï¼š

```js
function Counter() {
  const [count, setCount] = useState(0);

  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
      <button onClick={handleAlertClick}>
        Show alert
      </button>
    </div>
  );
}
```

å®ç°äº†ä¸Šé¢è¿™ä¸ªè®¡æ•°å™¨åï¼ˆä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ª [Sandbox](https://codesandbox.io/s/w2wxl3yo0l) è¿›è¡Œä½“éªŒï¼‰ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤æ“ä½œï¼š1ï¼‰ç‚¹å‡» Click me æŒ‰é’®ï¼ŒæŠŠæ•°å­—å¢åŠ åˆ° 3ï¼›2ï¼‰ç‚¹å‡» Show alert æŒ‰é’®ï¼›3ï¼‰åœ¨ `setTimeout` è§¦å‘ä¹‹å‰ç‚¹å‡» Click meï¼ŒæŠŠæ•°å­—å¢åŠ åˆ° 5ã€‚

![](https://static.powerformer.com/c/870a7b7/1717865fbc70e63d.gif)

ç»“æœæ˜¯ Alert æ˜¾ç¤º 3ï¼

å¦‚æœä½ è§‰å¾—è¿™ä¸ªç»“æœå¾ˆæ­£å¸¸ï¼Œæ­å–œä½ å·²ç»ç†è§£äº† Capture Value çš„æ€æƒ³ï¼å¦‚æœä½ è§‰å¾—åŒªå¤·æ‰€æ€å˜›â€¦â€¦æ¥ç®€å•è§£é‡Šä¸€ä¸‹ï¼š

- æ¯æ¬¡æ¸²æŸ“ç›¸äº’ç‹¬ç«‹ï¼Œå› æ­¤æ¯æ¬¡æ¸²æŸ“æ—¶ç»„ä»¶ä¸­çš„çŠ¶æ€ã€äº‹ä»¶å¤„ç†å‡½æ•°ç­‰ç­‰éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæˆ–è€…è¯´**åªå±äº**æ‰€åœ¨çš„é‚£ä¸€æ¬¡æ¸²æŸ“
- æˆ‘ä»¬åœ¨ `count` ä¸º 3 çš„æ—¶å€™è§¦å‘äº† `handleAlertClick` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°**æ‰€è®°ä½çš„** `count` ä¹Ÿä¸º 3
- ä¸‰ç§’ç§åï¼Œåˆšæ‰å‡½æ•°çš„ `setTimeout` ç»“æŸï¼Œè¾“å‡º**å½“æ—¶è®°ä½çš„**ç»“æœï¼š3

è¿™é“ç†å°±åƒï¼Œä½ ç¿»å¼€åå¹´å‰çš„æ—¥è®°æœ¬ï¼Œè™½ç„¶æ˜¯ç°åœ¨ç¿»å¼€çš„ï¼Œä½†è®°å½•çš„ä»ç„¶æ˜¯åå¹´å‰çš„æ—¶å…‰ã€‚æˆ–è€…è¯´ï¼Œæ—¥è®°æœ¬ Capture äº†é‚£ä¸€æ®µç¾å¥½çš„å›å¿†ã€‚

### useEffect ä½¿ç”¨æµ…æ

ä½ å¯èƒ½å·²ç»å¬è¯´ `useEffect` ç±»ä¼¼ç±»ç»„ä»¶ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚ä½†æ˜¯åœ¨å¼€å§‹å­¦ä¹  `useEffect` ä¹‹å‰ï¼Œå»ºè®®ä½ æš‚æ—¶å¿˜è®°ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ï¼Œæ¯•ç«Ÿå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶æ˜¯ä¸åŒçš„ä¸–ç•Œã€‚å®˜æ–¹æ–‡æ¡£ä»‹ç» `useEffect` çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
useEffect(effectFn, deps)
```

`effectFn` æ˜¯ä¸€ä¸ªæ‰§è¡ŒæŸäº›å¯èƒ½å…·æœ‰**å‰¯ä½œç”¨**çš„ Effect å‡½æ•°ï¼ˆä¾‹å¦‚æ•°æ®è·å–ã€è®¾ç½®/é”€æ¯å®šæ—¶å™¨ç­‰ï¼‰ï¼Œå®ƒå¯ä»¥è¿”å›ä¸€ä¸ª**æ¸…ç†å‡½æ•°**ï¼ˆCleanupï¼‰ï¼Œä¾‹å¦‚å¤§å®¶æ‰€ç†Ÿæ‚‰çš„ `setInterval` å’Œ `clearInterval` ï¼š

```javascript
useEffect(() => {
  const intervalId = setInterval(doSomething(), 1000);
  return () => clearInterval(intervalId);
});
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ Effect å‡½æ•°ä½“å†…é€šè¿‡ `setInterval` å¯åŠ¨äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œéšååˆè¿”å›äº†ä¸€ä¸ª Cleanup å‡½æ•°ï¼Œç”¨äºé”€æ¯åˆšåˆšåˆ›å»ºçš„å®šæ—¶å™¨ã€‚

OKï¼Œå¬ä¸Šå»è¿˜æ˜¯å¾ˆæŠ½è±¡ï¼Œå†æ¥çœ‹çœ‹ä¸‹é¢çš„åŠ¨ç”»å§ï¼š

![](https://static.powerformer.com/c/870a7b7/1717865fbc8ba58f.gif)

åŠ¨ç”»ä¸­æœ‰ä»¥ä¸‹éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

- æ¯ä¸ª Effect å¿…ç„¶åœ¨æ¸²æŸ“ä¹‹åæ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šé˜»å¡æ¸²æŸ“ï¼Œæé«˜äº†æ€§èƒ½
- åœ¨è¿è¡Œæ¯ä¸ª Effect ä¹‹å‰ï¼Œè¿è¡Œå‰ä¸€æ¬¡æ¸²æŸ“çš„ Effect Cleanup å‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
- å½“ç»„ä»¶é”€æ¯æ—¶ï¼Œè¿è¡Œæœ€åä¸€æ¬¡ Effect çš„ Cleanup å‡½æ•°

{% note info %}
**æç¤º**

å°† Effect æ¨è¿Ÿåˆ°æ¸²æŸ“å®Œæˆä¹‹åæ‰§è¡Œæ˜¯å‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œå¦‚æœä½ æƒ³åœ¨æ¸²æŸ“ä¹‹å‰æ‰§è¡ŒæŸäº›é€»è¾‘ï¼ˆä¸æƒœç‰ºç‰²æ¸²æŸ“æ€§èƒ½ï¼‰ï¼Œé‚£ä¹ˆå¯ä½¿ç”¨ [`useLayoutEffect`](https://reactjs.org/docs/hooks-reference.html#uselayouteffect) é’©å­ï¼Œä½¿ç”¨æ–¹æ³•ä¸ `useEffect` å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯æ‰§è¡Œçš„æ—¶æœºä¸åŒã€‚
{% endnote %}

å†æ¥çœ‹çœ‹ `useEffect` çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š`deps` ï¼ˆä¾èµ–æ•°ç»„ï¼‰ã€‚ä»ä¸Šé¢çš„æ¼”ç¤ºåŠ¨ç”»ä¸­å¯ä»¥çœ‹å‡ºï¼ŒReact ä¼šåœ¨**æ¯æ¬¡æ¸²æŸ“åéƒ½è¿è¡Œ Effect**ã€‚è€Œä¾èµ–æ•°ç»„å°±æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯å¦åº”è¯¥è§¦å‘ Effectï¼Œä»è€Œèƒ½å¤Ÿå‡å°‘ä¸å¿…è¦çš„è®¡ç®—ï¼Œä»è€Œä¼˜åŒ–äº†æ€§èƒ½ã€‚å…·ä½“è€Œè¨€ï¼Œåªè¦ä¾èµ–æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“ç›¸æ¯”éƒ½æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆå°±è·³è¿‡æœ¬æ¬¡ Effect çš„æ‰§è¡Œã€‚

ä»”ç»†ä¸€æƒ³ï¼Œæˆ‘ä»¬å‘ç° `useEffect` é’©å­ä¸ä¹‹å‰ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç›¸æ¯”ï¼Œæœ‰ä¸¤ä¸ªæ˜¾è‘—çš„ç‰¹ç‚¹ï¼š

- å°†åˆæ¬¡æ¸²æŸ“ï¼ˆ`componentDidMount`ï¼‰ã€é‡æ¸²æŸ“ï¼ˆ`componentDidUpdate`ï¼‰å’Œé”€æ¯ï¼ˆ`componentDidUnmount`ï¼‰ä¸‰ä¸ªé˜¶æ®µçš„é€»è¾‘ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ API å»è§£å†³
- æŠŠç›¸å…³çš„é€»è¾‘éƒ½æ”¾åˆ°ä¸€ä¸ª Effect é‡Œé¢ï¼ˆä¾‹å¦‚ `setInterval` å’Œ `clearInterval`ï¼‰ï¼Œæ›´çªå‡ºé€»è¾‘çš„å†…èšæ€§

åœ¨æœ€æç«¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®š `deps` ä¸ºç©ºæ•°ç»„ `[]` ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ Effect **åªä¼šåœ¨ç»„ä»¶åˆæ¬¡æ¸²æŸ“åæ‰§è¡Œ**ã€‚å®é™…æ•ˆæœåŠ¨ç”»å¦‚ä¸‹ï¼š

![](https://static.powerformer.com/c/870a7b7/1717865fbf149bdc.gif)

å¯ä»¥çœ‹åˆ°ï¼Œåé¢çš„æ‰€æœ‰é‡æ¸²æŸ“éƒ½ä¸ä¼šè§¦å‘ Effect çš„æ‰§è¡Œï¼›åœ¨ç»„ä»¶é”€æ¯æ—¶ï¼Œè¿è¡Œ Effect Cleanup å‡½æ•°ã€‚

{% note warning %}
**æ³¨æ„**

å¦‚æœä½ ç†Ÿæ‚‰ React çš„é‡æ¸²æŸ“æœºåˆ¶ï¼Œé‚£ä¹ˆåº”è¯¥å¯ä»¥çŒœåˆ° `deps` æ•°ç»„åœ¨åˆ¤æ–­å…ƒç´ æ˜¯å¦å‘ç”Ÿæ”¹å˜æ—¶åŒæ ·ä¹Ÿä½¿ç”¨äº† `Object.is` è¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤ä¸€ä¸ªéšæ‚£ä¾¿æ˜¯ï¼Œå½“ `deps` ä¸­æŸä¸€å…ƒç´ ä¸ºéåŸå§‹ç±»å‹æ—¶ï¼ˆä¾‹å¦‚å‡½æ•°ã€å¯¹è±¡ç­‰ï¼‰ï¼Œ**æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šå‘ç”Ÿæ”¹å˜**ï¼Œä»è€Œå¤±å»äº† `deps` æœ¬èº«çš„æ„ä¹‰ï¼ˆæ¡ä»¶å¼åœ°è§¦å‘ Effectï¼‰ã€‚æˆ‘ä»¬ä¼šåœ¨æ¥ä¸‹æ¥è®²è§£å¦‚ä½•è§„é¿è¿™ä¸ªå›°å¢ƒã€‚
{% endnote %}

### å®æˆ˜ç¯èŠ‚

OKï¼Œåˆ°äº†å®æˆ˜ç¯èŠ‚ï¼Œæˆ‘ä»¬å…ˆå®ç°è·å–å…¨çƒæ•°æ®æ¦‚å†µï¼ˆæ¯ 5 ç§’é‡æ–°è·å–ä¸€æ¬¡ï¼‰ã€‚åˆ›å»º `src/components/GlobalStats.js` ç»„ä»¶ï¼Œç”¨äºå±•ç¤ºå…¨çƒæ•°æ®æ¦‚å†µï¼Œä»£ç å¦‚ä¸‹ï¼š

```js src/components/GlobalStats.js https://github.com/tuture-dev/covid-19-with-hooks/blob/5d8232d260cfb7e1885575ce1513d3f07d662a30/src/components/GlobalStats.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import React from "react";

function Stat({ number, color }) {
  return <span style={{ color: color, fontWeight: "bold" }}>{number}</span>;
}

function GlobalStats({ stats }) {
  const { cases, deaths, recovered, active, updated } = stats;

  return (
    <div className='global-stats'>
      <small>Updated on {new Date(updated).toLocaleString()}</small>
      <table>
        <tr>
          <td>
            Cases: <Stat number={cases} color='red' />
          </td>
          <td>
            Deaths: <Stat number={deaths} color='gray' />
          </td>
          <td>
            Recovered: <Stat number={recovered} color='green' />
          </td>
          <td>
            Active: <Stat number={active} color='orange' />
          </td>
        </tr>
      </table>
    </div>
  );
}

export default GlobalStats;
```

å¯ä»¥çœ‹åˆ°ï¼Œ`GlobalStats` å°±æ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°å¼ç»„ä»¶ï¼Œæ²¡æœ‰ä»»ä½•é’©å­ã€‚

ç„¶åä¿®æ”¹ `src/App.js` ï¼Œå¼•å…¥åˆšåˆšåˆ›å»ºçš„ `GlobalStats` ç»„ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js src/App.js https://github.com/tuture-dev/covid-19-with-hooks/blob/5d8232d260cfb7e1885575ce1513d3f07d662a30/src/App.js æŸ¥çœ‹å®Œæ•´ä»£ç 
[tuture-del]import React from 'react';
[tuture-del]import logo from './logo.svg';
[tuture-del]import './App.css';
[tuture-add]import React, { useState, useEffect } from "react";
[tuture-add] 
[tuture-add]import "./App.css";
[tuture-add]import GlobalStats from "./components/GlobalStats";
[tuture-add] 
[tuture-add]const BASE_URL = "https://corona.lmao.ninja/v2";

function App() {
[tuture-add]  const [globalStats, setGlobalStats] = useState({});
[tuture-add] 
[tuture-add]  useEffect(() => {
[tuture-add]    const fetchGlobalStats = async () => {
[tuture-add]      const response = await fetch(`${BASE_URL}/all`);
[tuture-add]      const data = await response.json();
[tuture-add]      setGlobalStats(data);
[tuture-add]    };
[tuture-add] 
[tuture-add]    fetchGlobalStats();
[tuture-add]    const intervalId = setInterval(fetchGlobalStats, 5000);
[tuture-add] 
[tuture-add]    return () => clearInterval(intervalId);
[tuture-add]  }, []);
[tuture-add] 
  return (
[tuture-del]    <div className="App">
[tuture-del]      <header className="App-header">
[tuture-del]        <img src={logo} className="App-logo" alt="logo" />
[tuture-del]        <p>
[tuture-del]          Edit <code>src/App.js</code> and save to reload.
[tuture-del]        </p>
[tuture-del]        <a
[tuture-del]          className="App-link"
[tuture-del]          href="https://reactjs.org"
[tuture-del]          target="_blank"
[tuture-del]          rel="noopener noreferrer"
[tuture-del]        >
[tuture-del]          Learn React
[tuture-del]        </a>
[tuture-del]      </header>
[tuture-add]    <div className='App'>
[tuture-add]      <h1>COVID-19</h1>
[tuture-add]      <GlobalStats stats={globalStats} />
    </div>
  );
}

export default App;
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ `App` ç»„ä»¶ä¸­ï¼Œé¦–å…ˆé€šè¿‡ `useState` é’©å­å¼•å…¥äº† `globalStats` çŠ¶æ€å˜é‡ï¼Œä»¥åŠä¿®æ”¹è¯¥çŠ¶æ€çš„å‡½æ•°ã€‚ç„¶åé€šè¿‡ `useEffect` é’©å­è·å– API æ•°æ®ï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

1. æˆ‘ä»¬é€šè¿‡å®šä¹‰äº†ä¸€ä¸ª `fetchGlobalStats` å¼‚æ­¥å‡½æ•°å¹¶è¿›è¡Œè°ƒç”¨ä»è€Œè·å–æ•°æ®ï¼Œè€Œä¸æ˜¯ç›´æ¥æŠŠè¿™ä¸ª async å‡½æ•°ä½œä¸º `useEffect` çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼›
2. åˆ›å»ºäº†ä¸€ä¸ª Intervalï¼Œç”¨äºæ¯ 5 ç§’é’Ÿé‡æ–°è·å–ä¸€æ¬¡æ•°æ®ï¼›
3. è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé”€æ¯ä¹‹å‰åˆ›å»ºçš„ Intervalã€‚

æ­¤å¤–ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆä¾èµ–æ•°ç»„ï¼‰ä¸ºç©ºæ•°ç»„ï¼Œå› æ­¤æ•´ä¸ª Effect å‡½æ•°åªä¼šè¿è¡Œä¸€æ¬¡ã€‚

{% note warning %}
**æ³¨æ„**

æœ‰æ—¶å€™ï¼Œä½ ä¹Ÿè®¸ä¼šä¸ç»æ„é—´æŠŠ Effect å†™æˆä¸€ä¸ª async å‡½æ•°ï¼š

```js
useEffect(async () => {
  const response = await fetch('...');
  // ...
}, []);
```

è¿™æ ·å¯ä»¥å—ï¼Ÿ**å¼ºçƒˆå»ºè®®ä½ ä¸è¦è¿™æ ·åš**ã€‚`useEffect` çº¦å®š Effect å‡½æ•°è¦ä¹ˆæ²¡æœ‰è¿”å›å€¼ï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ª Cleanup å‡½æ•°ã€‚è€Œè¿™é‡Œ async å‡½æ•°ä¼šéšå¼åœ°è¿”å›ä¸€ä¸ª Promiseï¼Œç›´æ¥è¿åäº†è¿™ä¸€çº¦å®šï¼Œä¼šé€ æˆä¸å¯é¢„æµ‹çš„ç»“æœã€‚
{% endnote %}

æœ€åé™„ä¸Šåº”ç”¨çš„å…¨å±€ CSS æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼ˆç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ï¼‰ï¼š

```css src/App.css https://github.com/tuture-dev/covid-19-with-hooks/blob/5d8232d260cfb7e1885575ce1513d3f07d662a30/src/App.css æŸ¥çœ‹å®Œæ•´ä»£ç 
.App {
[tuture-add]  width: 1200px;
[tuture-add]  margin: auto;
  text-align: center;
}

[tuture-del].App-logo {
[tuture-del]  height: 40vmin;
[tuture-del]  pointer-events: none;
[tuture-del]}
[tuture-del] 
[tuture-del]@media (prefers-reduced-motion: no-preference) {
[tuture-del]  .App-logo {
[tuture-del]    animation: App-logo-spin infinite 20s linear;
[tuture-del]  }
[tuture-del]}
[tuture-del] 
[tuture-del].App-header {
[tuture-del]  background-color: #282c34;
[tuture-del]  min-height: 100vh;
[tuture-add].history-group {
  display: flex;
[tuture-del]  flex-direction: column;
[tuture-del]  align-items: center;
  justify-content: center;
[tuture-del]  font-size: calc(10px + 2vmin);
[tuture-del]  color: white;
[tuture-add]  width: 1200px;
[tuture-add]  margin: auto;
[tuture-add]}
[tuture-add] 
[tuture-add]table,
[tuture-add]th,
[tuture-add]td {
[tuture-add]  border: 1px solid #ccc;
[tuture-add]  border-collapse: collapse;
}

[tuture-del].App-link {
[tuture-del]  color: #61dafb;
[tuture-add]th,
[tuture-add]td {
[tuture-add]  padding: 5px;
[tuture-add]  text-align: left;
}

[tuture-del]@keyframes App-logo-spin {
[tuture-del]  from {
[tuture-del]    transform: rotate(0deg);
[tuture-del]  }
[tuture-del]  to {
[tuture-del]    transform: rotate(360deg);
[tuture-del]  }
[tuture-add].global-stats > table {
[tuture-add]  margin: auto;
[tuture-add]  margin-top: 0.5rem;
[tuture-add]  margin-bottom: 1rem;
}
```

é€šè¿‡ `npm start` å¼€å¯é¡¹ç›®ï¼š

![](https://static.powerformer.com/c/870a7b7/171786603098c448.png)

æ­¤å¤–ï¼Œä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸‹æ§åˆ¶å°çš„ Network é€‰é¡¹å¡ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨æ¯äº”ç§’å°±ä¼šå‘èµ·ä¸€æ¬¡è¯·æ±‚æŸ¥è¯¢æœ€æ–°çš„æ•°æ®ã€‚æ­å–œä½ ï¼ŒæˆåŠŸåœ°ç”¨ Hooks è¿›è¡Œäº†ä¸€æ¬¡æ•°æ®è·å–ï¼

## useState + useEffectï¼šæ¸å…¥ä½³å¢ƒ

åœ¨ä¸Šä¸€æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬åœ¨ `App` ç»„ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª State å’Œ Effectï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸å¯èƒ½è¿™ä¹ˆç®€å•ï¼Œä¸€èˆ¬éƒ½éœ€è¦å¤šä¸ª State å’Œ Effectï¼Œè¿™æ—¶å€™åˆè¯¥æ€ä¹ˆå»ç†è§£å’Œä½¿ç”¨å‘¢ï¼Ÿ

### æ·±å…¥ useState çš„æœ¬è´¨

åœ¨ä¸Šä¸€èŠ‚çš„åŠ¨ç”»ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¯ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬éƒ½èƒ½é€šè¿‡ä¸€ä¸ªç¥å¥‡çš„é’©å­æŠŠçŠ¶æ€â€é’©â€œè¿‡æ¥ï¼Œä¸è¿‡è¿™äº›é’©å­ä»ä½•è€Œæ¥æˆ‘ä»¬æ‰“äº†ä¸€ä¸ªé—®å·ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™è§£å¼€è°œå›¢äº†ã€‚

{% note warning %}
**æ³¨æ„**

ä»¥ä¸‹åŠ¨ç”»æ¼”ç¤ºå¹¶ä¸å®Œå…¨å¯¹åº” React Hooks çš„æºç å®ç°ï¼Œä½†æ˜¯å®ƒèƒ½å¾ˆå¥½åœ°å¸®åŠ©ä½ ç†è§£å…¶å·¥ä½œåŸç†ã€‚å½“ç„¶ï¼Œä¹Ÿèƒ½å¸®åŠ©ä½ å»å•ƒçœŸæ­£çš„æºç ã€‚
{% endnote %}

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å½“ç»„ä»¶åˆæ¬¡æ¸²æŸ“ï¼ˆæŒ‚è½½ï¼‰æ—¶ï¼Œæƒ…å†µåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ï¼š

![](https://static.powerformer.com/c/870a7b7/171786605bc81ad0.gif)

æ³¨æ„ä»¥ä¸‹è¦ç‚¹ï¼š

1. åœ¨åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ `useState` å®šä¹‰äº†å¤šä¸ªçŠ¶æ€ï¼›
2. æ¯è°ƒç”¨ä¸€æ¬¡ `useState` ï¼Œéƒ½ä¼šåœ¨ç»„ä»¶ä¹‹å¤–ç”Ÿæˆä¸€æ¡ Hook è®°å½•ï¼ŒåŒæ—¶åŒ…æ‹¬çŠ¶æ€å€¼ï¼ˆç”¨ `useState` ç»™å®šçš„åˆå§‹å€¼åˆå§‹åŒ–ï¼‰å’Œä¿®æ”¹çŠ¶æ€çš„ Setter å‡½æ•°ï¼›
3. å¤šæ¬¡è°ƒç”¨ `useState` ç”Ÿæˆçš„ Hook è®°å½•å½¢æˆäº†ä¸€æ¡**é“¾è¡¨**ï¼›
4. è§¦å‘ `onClick` å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨ `setS2` å‡½æ•°ä¿®æ”¹ `s2` çš„çŠ¶æ€ï¼Œä¸ä»…ä¿®æ”¹äº† Hook è®°å½•ä¸­çš„çŠ¶æ€å€¼ï¼Œè¿˜å³å°†**è§¦å‘é‡æ¸²æŸ“**ã€‚

OKï¼Œé‡æ¸²æŸ“çš„æ—¶å€™åˆ°äº†ï¼ŒåŠ¨ç”»å¦‚ä¸‹ï¼š

![](https://static.powerformer.com/c/870a7b7/171786607069e72d.gif)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆæ¬¡æ¸²æŸ“ç»“æŸä¹‹åã€é‡æ¸²æŸ“ä¹‹å‰ï¼ŒHook è®°å½•é“¾è¡¨ä¾ç„¶å­˜åœ¨ã€‚å½“æˆ‘ä»¬é€ä¸ªè°ƒç”¨ `useState` çš„æ—¶å€™ï¼Œ`useState` ä¾¿è¿”å›äº† Hook é“¾è¡¨ä¸­å­˜å‚¨çš„çŠ¶æ€ï¼Œä»¥åŠä¿®æ”¹çŠ¶æ€çš„ Setterã€‚

{% note info %}
**æç¤º**

å½“ä½ å……åˆ†ç†è§£ä¸Šé¢ä¸¤ä¸ªåŠ¨ç”»ä¹‹åï¼Œå…¶å®å°±èƒ½ç†è§£ä¸ºä»€ä¹ˆè¿™ä¸ª Hook å« `useState` è€Œä¸æ˜¯ `createState` äº†â€”â€”ä¹‹æ‰€ä»¥å« `use` ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰çš„æ—¶å€™æ‰åˆ›å»ºï¼ˆåˆæ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼‰ï¼Œæœ‰çš„æ—¶å€™å°±ç›´æ¥è¯»å–ï¼ˆé‡æ¸²æŸ“çš„æ—¶å€™ï¼‰ã€‚
{% endnote %}

é€šè¿‡ä»¥ä¸Šçš„åˆ†æï¼Œæˆ‘ä»¬ä¸éš¾å‘ç° `useState` åœ¨è®¾è®¡æ–¹é¢çš„ç²¾å·§ï¼ˆæ‘˜è‡ªå¼ ç«‹ç†ï¼š[å¯¹ React Hooks çš„ä¸€äº›æ€è€ƒ](https://zhuanlan.zhihu.com/p/48264713)ï¼‰ï¼š

- çŠ¶æ€å’Œä¿®æ”¹çŠ¶æ€çš„ Setter å‡½æ•°ä¸¤ä¸¤é…å¯¹ï¼Œå¹¶ä¸”åè€…ä¸€å®šå½±å“å‰è€…ï¼Œå‰è€…åªè¢«åè€…å½±å“ï¼Œä½œä¸ºä¸€ä¸ªæ•´ä½“å®ƒä»¬å®Œå…¨ä¸å—å¤–ç•Œçš„å½±å“
- é¼“åŠ±ç»†ç²’åº¦å’Œæ‰å¹³åŒ–çš„çŠ¶æ€å®šä¹‰å’Œæ§åˆ¶ï¼Œå¯¹äºä»£ç è¡Œä¸ºçš„å¯é¢„æµ‹æ€§å’Œå¯æµ‹è¯•æ€§å¤§æœ‰å¸®åŠ©
- é™¤äº† `useState` ï¼ˆå’Œå…¶ä»–é’©å­ï¼‰ï¼Œå‡½æ•°ç»„ä»¶ä¾ç„¶æ˜¯å®ç°æ¸²æŸ“é€»è¾‘çš„â€œçº¯â€ç»„ä»¶ï¼Œå¯¹çŠ¶æ€çš„ç®¡ç†è¢« Hooks æ‰€å°è£…äº†èµ·æ¥

### æ·±å…¥ useEffect çš„æœ¬è´¨

åœ¨å¯¹ `useState` è¿›è¡Œä¸€æ³¢æ·±æŒ–ä¹‹åï¼Œæˆ‘ä»¬å†æ¥æ­å¼€ `useEffect` ç¥ç§˜çš„é¢çº±ã€‚å®é™…ä¸Šï¼Œä½ å¯èƒ½å·²ç»çŒœåˆ°äº†â€”â€”åŒæ ·æ˜¯é€šè¿‡ä¸€ä¸ªé“¾è¡¨è®°å½•æ‰€æœ‰çš„ Hookï¼Œè¯·çœ‹ä¸‹é¢çš„æ¼”ç¤ºï¼š

![](https://static.powerformer.com/c/870a7b7/17178660689c7301.gif)

æ³¨æ„å…¶ä¸­ä¸€äº›ç»†èŠ‚ï¼š

1. `useState` å’Œ `useEffect` åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¢«æ·»åŠ åˆ° Hook é“¾è¡¨ä¸­ï¼›
2. `useEffect` è¿˜ä¼šé¢å¤–åœ°åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªç­‰å¾…æ‰§è¡Œçš„ Effect å‡½æ•°ï¼›
3. åœ¨æ¸²æŸ“å®Œæˆåï¼Œä¾æ¬¡è°ƒç”¨ Effect é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ª Effect å‡½æ•°ã€‚

è‡³æ­¤ï¼Œä¸Šä¸€èŠ‚çš„åŠ¨ç”»ä¸­é‚£ä¸¤ä¸ªâ€œé—®å·â€çš„èº«ä¸–ä¹Ÿå°±æ­æ™“äº†â€”â€”åªä¸è¿‡æ˜¯**é“¾è¡¨**ç½¢äº†ï¼å›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬æƒ³èµ·æ¥ React å®˜æ–¹æ–‡æ¡£ Rules of Hooks ä¸­å¼ºè°ƒè¿‡ä¸€ç‚¹ï¼š

> Only call hooks at the top level. åªåœ¨æœ€é¡¶å±‚ä½¿ç”¨ Hookã€‚

å…·ä½“åœ°è¯´ï¼Œä¸è¦åœ¨å¾ªç¯ã€åµŒå¥—ã€æ¡ä»¶è¯­å¥ä¸­ä½¿ç”¨ Hookâ€”â€”å› ä¸ºè¿™äº›åŠ¨æ€çš„è¯­å¥å¾ˆæœ‰å¯èƒ½ä¼šå¯¼è‡´æ¯æ¬¡æ‰§è¡Œç»„ä»¶å‡½æ•°æ—¶è°ƒç”¨ Hook çš„é¡ºåºä¸èƒ½å®Œå…¨ä¸€è‡´ï¼Œå¯¼è‡´ Hook é“¾è¡¨è®°å½•çš„æ•°æ®å¤±æ•ˆã€‚å…·ä½“çš„åœºæ™¯å°±ä¸ç”»åŠ¨ç”»å•¦ï¼Œè‡ªè¡Œè„‘è¡¥å§~

### ä¸è¦æ’’è°ï¼šå…³äº deps çš„é‚£äº›äº‹

`useEffect` ï¼ˆåŒ…æ‹¬å…¶ä»–ç±»ä¼¼çš„ `useCallback` å’Œ `useMemo` ç­‰ï¼‰éƒ½æœ‰ä¸ªä¾èµ–æ•°ç»„ï¼ˆ`deps`ï¼‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ¯”è¾ƒæœ‰è¶£çš„ä¸€ç‚¹æ˜¯ï¼šæŒ‡å®šä¾èµ–çš„å†³å®šæƒå®Œå…¨åœ¨ä½ æ‰‹é‡Œã€‚ä½ å½“ç„¶å¯ä»¥é€‰æ‹©â€œæ’’è°â€ï¼Œä¸ç®¡ä»€ä¹ˆæƒ…å†µéƒ½ç»™ä¸€ä¸ªç©ºçš„ `deps` æ•°ç»„ï¼Œä»¿ä½›åœ¨è¯´â€œè¿™ä¸ª Effect å‡½æ•°ä»€ä¹ˆä¾èµ–éƒ½æ²¡æœ‰ï¼Œç›¸ä¿¡æˆ‘â€ã€‚

ç„¶è€Œï¼Œè¿™ç§æœ‰ç‚¹å·æ‡’çš„åšæ³•æ˜¾ç„¶ä¼šå¼•æ¥å„ç§ Bugã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ‰€ä½¿ç”¨åˆ°çš„ `prop` æˆ–è€… `state` éƒ½åº”è¯¥è¢«æ·»åŠ åˆ° `deps` æ•°ç»„é‡Œé¢å»ã€‚å¹¶ä¸”ï¼ŒReact å®˜æ–¹è¿˜æ¨å‡ºäº†ä¸€ä¸ªä¸“é—¨çš„ [ESLint æ’ä»¶](https://www.npmjs.com/package/eslint-plugin-react-hooks)ï¼Œå¯ä»¥å¸®ä½ è‡ªåŠ¨ä¿®å¤ `deps` æ•°ç»„ï¼ˆ*è¯´å®è¯ï¼Œè¿™ä¸ªæ’ä»¶çš„è‡ªåŠ¨ä¿®å¤æœ‰æ—¶å€™è¿˜æ˜¯æŒºé—¹å¿ƒçš„â€¦â€¦*ï¼‰ã€‚

### å®æˆ˜ç¯èŠ‚

ä»è¿™ä¸€æ­¥å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Recharts](http://recharts.org) ä½œä¸ºå¯è§†åŒ–åº”ç”¨çš„å›¾è¡¨åº“ï¼Œå®ƒæä¾›äº†å‡ºè‰²çš„ D3 å’Œ React çš„ç»‘å®šå±‚ã€‚é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ·»åŠ  `recharts` ä¾èµ–ï¼š

```bash
npm install recharts
```

åˆ›å»º `src/components/CountriesChart.js` ï¼Œç”¨äºå±•ç¤ºå¤šä¸ªå›½å®¶çš„ç›¸å…³æ•°æ®ç›´æ–¹å›¾ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js src/components/CountriesChart.js https://github.com/tuture-dev/covid-19-with-hooks/blob/aca177468ecb4220a336d0d8f91e36f9bdd70b97/src/components/CountriesChart.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import React from "react";
import {
  BarChart,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  Bar,
} from "recharts";

function CountriesChart({ data, dataKey }) {
  return (
    <BarChart
      width={1200}
      height={250}
      style={{ margin: "auto" }}
      margin={{ top: 30, left: 20, right: 30 }}
      data={data}
    >
      <CartesianGrid strokeDasharray='3 3' />
      <XAxis dataKey='country' />
      <YAxis />
      <Tooltip />
      <Legend />
      <Bar dataKey={dataKey} fill='#8884d8' />
    </BarChart>
  );
}

export default CountriesChart;
```

åˆ›å»º `src/components/SelectDataKey.js` ï¼Œç”¨äºé€‰æ‹©éœ€è¦å±•ç¤ºçš„å…³é”®æŒ‡æ ‡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js src/components/SelectDataKey.js https://github.com/tuture-dev/covid-19-with-hooks/blob/aca177468ecb4220a336d0d8f91e36f9bdd70b97/src/components/SelectDataKey.js æŸ¥çœ‹å®Œæ•´ä»£ç 
import React from "react";

function SelectDataKey({ onChange }) {
  return (
    <>
      <label htmlFor='key-select'>Select a key for sorting: </label>
      <select id='key-select' onChange={onChange}>
        <option value='cases'>Cases</option>
        <option value='todayCases'>Today Cases</option>
        <option value='deaths'>Death</option>
        <option value='recovered'>Recovered</option>
        <option value='active'>Active</option>
      </select>
    </>
  );
}

export default SelectDataKey;
```

`SelectDataKey` ç”¨äºè®©ç”¨æˆ·é€‰æ‹©ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š

- `cases` ï¼šç´¯ç§¯ç¡®è¯Šç—…ä¾‹
- `todayCases` ï¼šä»Šæ—¥ç¡®è¯Šç—…ä¾‹
- `deaths` ï¼šç´¯ç§¯æ­»äº¡ç—…ä¾‹
- `recovered` ï¼šæ²»æ„ˆäººæ•°
- `active` ï¼šç°å­˜ç¡®è¯Šäººæ•°

æœ€åæˆ‘ä»¬åœ¨æ ¹ç»„ä»¶ `src/App.js` ä¸­å¼•å…¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ªç»„ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js src/App.js https://github.com/tuture-dev/covid-19-with-hooks/blob/aca177468ecb4220a336d0d8f91e36f9bdd70b97/src/App.js æŸ¥çœ‹å®Œæ•´ä»£ç 
// ...
import GlobalStats from "./components/GlobalStats";
[tuture-add]import CountriesChart from "./components/CountriesChart";
[tuture-add]import SelectDataKey from "./components/SelectDataKey";

const BASE_URL = "https://corona.lmao.ninja/v2";

function App() {
  const [globalStats, setGlobalStats] = useState({});
[tuture-add]  const [countries, setCountries] = useState([]);
[tuture-add]  const [key, setKey] = useState("cases");

  useEffect(() => {
    // ...
  }, []);

[tuture-add]  useEffect(() => {
[tuture-add]    const fetchCountries = async () => {
[tuture-add]      const response = await fetch(`${BASE_URL}/countries?sort=${key}`);
[tuture-add]      const data = await response.json();
[tuture-add]      setCountries(data.slice(0, 10));
[tuture-add]    };
[tuture-add] 
[tuture-add]    fetchCountries();
[tuture-add]  }, [key]);
[tuture-add] 
  return (
    <div className='App'>
      <h1>COVID-19</h1>
      <GlobalStats stats={globalStats} />
[tuture-add]      <SelectDataKey onChange={(e) => setKey(e.target.value)} />
[tuture-add]      <CountriesChart data={countries} dataKey={key} />
    </div>
  );
}

export default App;
```

å¯ä»¥çœ‹åˆ°ï¼š

1. æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ–°çš„çŠ¶æ€ `countries` ï¼ˆæ‰€æœ‰å›½å®¶çš„æ•°æ®ï¼‰å’Œ `key` ï¼ˆæ•°æ®æ’åºçš„æŒ‡æ ‡ï¼Œå°±æ˜¯ä¸Šé¢çš„äº”ä¸ªï¼‰ï¼›
2. æˆ‘ä»¬åˆé€šè¿‡ä¸€ä¸ª `useEffect` é’©å­è¿›è¡Œæ•°æ®è·å–ï¼Œå’Œä¹‹å‰è·å–å…¨çƒæ•°æ®ç±»ä¼¼ï¼Œåªä¸è¿‡æ³¨æ„æˆ‘ä»¬è¿™è¾¹ç¬¬äºŒä¸ªå‚æ•°ï¼ˆä¾èµ–æ•°ç»„ï¼‰æ˜¯ `[key]` ï¼Œä¹Ÿå°±æ˜¯åªæœ‰å½“ `key` çŠ¶æ€æ”¹å˜çš„æ—¶å€™ï¼Œæ‰ä¼šè°ƒç”¨ `useEffect` é‡Œé¢çš„å‡½æ•°ã€‚
3. æœ€åä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„ä¸¤ä¸ªå­ç»„ä»¶ï¼Œä¼ å…¥ç›¸åº”çš„æ•°æ®å’Œå›è°ƒå‡½æ•°ã€‚

æŠŠé¡¹ç›®è·‘èµ·æ¥ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ–¹å›¾æ˜¾ç¤ºäº†å‰åä¸ªå›½å®¶çš„æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹æ’åºçš„æŒ‡æ ‡ï¼ˆæ¯”å¦‚å¯ä»¥ä»é»˜è®¤çš„ç´¯ç§¯ç¡®è¯Š `cases` åˆ‡æ¢æˆæ­»äº¡äººæ•° `deaths` ï¼‰ï¼š

![](https://static.powerformer.com/c/870a7b7/171786607417628c.gif)

çœ‹ä¸Šå»æŒºä¸é”™çš„ï¼

åˆ°è¿™é‡Œï¼Œæœ¬ç³»åˆ—ç¬¬ä¸€ç¯‡ä¹Ÿå°±è®²å®Œå•¦ï¼Œå¸Œæœ›ä½ çœŸæ­£ç†è§£äº† `useState` å’Œ `useEffect` â€”â€”æœ€æœ€æœ€å¸¸ç”¨çš„ä¸¤ä¸ª Hookã€‚åœ¨ä¸‹ä¸€ç¯‡æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­è®²è§£è‡ªå®šä¹‰ Hook å’Œ `useCallback` ï¼Œæ•¬è¯·æœŸå¾…ã€‚

## å‚è€ƒèµ„æ–™

- [React å®˜æ–¹æ–‡æ¡£](https://reactjs.org/)
- Robin Wieruchï¼š[How to fetch data with React Hooks?](https://www.robinwieruch.de/react-hooks-fetch-data)
- Dan Abramovï¼š[A Complete Guide to useEffect](https://overreacted.io/a-complete-guide-to-useeffect/)
- Dan Abramovï¼š[How Are Function Components Different from Classes?](https://overreacted.io/how-are-function-components-different-from-classes/)
- Rudi Yardleyï¼š[React hooks: not magic, just arrays](https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e)
- Eytan Manorï¼š[Under the hood of Reactâ€™s hooks system](https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba)
- è¡è‰¯ï¼š[React Hooks å®Œå…¨ä¸Šæ‰‹æŒ‡å—](https://zhuanlan.zhihu.com/p/92211533)
- å¼ ç«‹ç†ï¼š[å¯¹ React Hooks çš„ä¸€äº›æ€è€ƒ](https://zhuanlan.zhihu.com/p/48264713)